<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EY Contact Navigator ‚Äî Transformation Intelligence for Contact Centres</title>
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 0: DESIGN SYSTEM & SHELL CSS
   EY Branding: #FFE600 yellow, #2E2E38 dark
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root {
  --ey-yellow: #FFE600;
  --ey-dark: #2E2E38;
  --ey-dark-hover: #3a3a48;
  --ey-white: #FFFFFF;
  --ey-light-gray: #F6F6FA;
  --ey-mid-gray: #E0E0E6;
  --ey-text: #2E2E38;
  --ey-text-light: #747480;
  --ey-green: #168736;
  --ey-green-bg: #E8F5E9;
  --ey-amber: #D97706;
  --ey-amber-bg: #FFF8E1;
  --ey-red: #C5003E;
  --ey-red-bg: #FFEBEE;
  --ey-blue: #1A73E8;
  --ey-blue-bg: #E3F2FD;
  --ey-teal: #0097A9;
  --ey-purple: #7B61FF;
  --sidebar-w: 260px;
  --topbar-h: 56px;
  --radius: 8px;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'EYInterstate', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--ey-light-gray);
  color: var(--ey-text);
  font-size: 14px;
  line-height: 1.5;
}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar {
  position: fixed; top: 0; left: 0; bottom: 0;
  width: var(--sidebar-w);
  background: var(--ey-dark);
  color: var(--ey-white);
  overflow-y: auto;
  z-index: 100;
  display: flex;
  flex-direction: column;
}

.sidebar-logo {
  padding: 18px 20px 12px;
  border-bottom: 2px solid var(--ey-yellow);
}

.sidebar-logo h1 {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--ey-yellow);
  margin-bottom: 2px;
}

.sidebar-logo h2 {
  font-size: 17px;
  font-weight: 600;
  color: var(--ey-white);
}

.sidebar-logo .sub {
  font-size: 10px;
  color: #9E9EA8;
  margin-top: 2px;
}

.sidebar nav { flex: 1; padding: 10px 0; }

.nav-phase {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1.2px;
  text-transform: uppercase;
  color: var(--ey-yellow);
  padding: 16px 20px 6px;
  opacity: 0.9;
  border-top: 1px solid rgba(255,255,255,0.06);
  margin-top: 4px;
}
.nav-phase:first-child { border-top: none; margin-top: 0; }

.nav-item {
  display: flex;
  align-items: center;
  padding: 9px 20px;
  cursor: pointer;
  transition: all 0.15s;
  border-left: 3px solid transparent;
  gap: 10px;
  font-size: 13px;
  color: #C8C8D0;
}

.nav-item:hover { background: var(--ey-dark-hover); color: var(--ey-white); }

.nav-item.active {
  background: rgba(255,230,0,0.08);
  border-left-color: var(--ey-yellow);
  color: var(--ey-white);
  font-weight: 600;
}

.nav-num {
  display: inline-flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; border-radius: 50%;
  background: rgba(255,255,255,0.1);
  font-size: 10px; font-weight: 700; flex-shrink: 0;
}

.nav-item.active .nav-num { background: var(--ey-yellow); color: var(--ey-dark); }

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar {
  position: fixed; top: 0; left: var(--sidebar-w); right: 0;
  height: var(--topbar-h);
  background: var(--ey-white);
  border-bottom: 1px solid var(--ey-mid-gray);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  z-index: 90;
}

.topbar-left { display: flex; align-items: center; gap: 16px; }

.topbar-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--ey-text);
}

.topbar-question {
  font-size: 12px;
  color: var(--ey-text-light);
  background: var(--ey-light-gray);
  padding: 4px 12px;
  border-radius: 20px;
}

.topbar-right { display: flex; align-items: center; gap: 10px; }

.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 7px 16px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.15s;
}

.btn-primary { background: var(--ey-yellow); color: var(--ey-dark); }
.btn-primary:hover { background: #E6CF00; }

.btn-outline {
  background: transparent;
  border: 1.5px solid var(--ey-mid-gray);
  color: var(--ey-text);
}
.btn-outline:hover { border-color: var(--ey-text); }

.btn-dark { background: var(--ey-dark); color: var(--ey-white); }
.btn-dark:hover { background: var(--ey-dark-hover); }

.btn-sm { padding: 5px 12px; font-size: 12px; }

/* ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ */
.main {
  margin-left: var(--sidebar-w);
  margin-top: var(--topbar-h);
  padding: 24px;
  min-height: calc(100vh - var(--topbar-h));
}

.page { display: none; }
.page.active { display: block; }

/* ‚îÄ‚îÄ CARDS & COMPONENTS ‚îÄ‚îÄ */
.card {
  background: var(--ey-white);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 20px;
  margin-bottom: 16px;
  transition: box-shadow 0.2s ease, transform 0.15s ease;
}
.card:hover {
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.card-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--ey-text);
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.card-title .icon { font-size: 16px; }

/* KPI row */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}

.kpi-card {
  background: var(--ey-white);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 16px;
  text-align: center;
  border-left: 4px solid var(--ey-mid-gray);
  transition: transform 0.15s ease, box-shadow 0.2s ease;
}
.kpi-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

.kpi-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--ey-text-light);
  margin-bottom: 6px;
}

.kpi-value {
  font-size: 26px;
  font-weight: 700;
  color: var(--ey-text);
}

.kpi-sub {
  font-size: 11px;
  color: var(--ey-text-light);
  margin-top: 2px;
}

.kpi-card.green .kpi-value { color: var(--ey-green); }
.kpi-card.amber .kpi-value { color: var(--ey-amber); }
.kpi-card.red .kpi-value { color: var(--ey-red); }

/* Page transition */
.page { display: none; animation: fadeIn 0.25s ease; }
.page.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

/* Tables */
.table-wrap { overflow-x: auto; }

table.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

table.data-table th {
  background: var(--ey-light-gray);
  font-weight: 700;
  text-align: left;
  padding: 10px 12px;
  border-bottom: 2px solid var(--ey-mid-gray);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--ey-text-light);
}

table.data-table td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--ey-mid-gray);
  vertical-align: middle;
}

table.data-table tr:hover { background: rgba(246,246,250,0.6); }

/* Badges */
.badge {
  display: inline-block;
  padding: 2px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
}

.badge-critical { background: var(--ey-red-bg); color: var(--ey-red); }
.badge-high { background: #FFF3E0; color: #E65100; }
.badge-medium { background: var(--ey-amber-bg); color: var(--ey-amber); }
.badge-low { background: var(--ey-green-bg); color: var(--ey-green); }

.rag-green { background: var(--ey-green); color: white; }
.rag-amber { background: var(--ey-amber); color: white; }
.rag-red { background: var(--ey-red); color: white; }

/* Grid layouts */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.grid-2-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
.grid-1-2 { display: grid; grid-template-columns: 1fr 2fr; gap: 16px; }

/* Health gauge */
.health-gauge {
  width: 200px;
  height: 200px;
  position: relative;
  margin: 0 auto;
}

.health-gauge canvas { width: 200px; height: 200px; }

.health-gauge-value {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.health-gauge-value .score {
  font-size: 42px;
  font-weight: 800;
  line-height: 1;
}

.health-gauge-value .label {
  font-size: 11px;
  color: var(--ey-text-light);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Radar chart */
.radar-container {
  width: 100%;
  max-width: 380px;
  margin: 0 auto;
}

.radar-container canvas { width: 100% !important; height: auto !important; }

/* Before/After comparison */
.compare-row {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 16px;
  align-items: center;
}

.compare-card {
  background: var(--ey-white);
  border-radius: var(--radius);
  padding: 20px;
  text-align: center;
}

.compare-card.before { border: 2px solid var(--ey-mid-gray); }
.compare-card.after { border: 2px solid var(--ey-green); background: var(--ey-green-bg); }

.compare-arrow { font-size: 28px; color: var(--ey-text-light); }

/* Metric toggle buttons */
.metric-toggle {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

.metric-btn {
  padding: 5px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border: 1.5px solid var(--ey-mid-gray);
  background: transparent;
  color: var(--ey-text);
  transition: all 0.15s;
}

.metric-btn.active,
.metric-btn:hover {
  background: var(--ey-dark);
  color: var(--ey-white);
  border-color: var(--ey-dark);
}

/* Pentagon/Maturity chart */
.maturity-pentagon {
  width: 100%;
  max-width: 400px;
  margin: 0 auto;
}

/* Heatmap */
.heatmap-grid {
  display: grid;
  gap: 2px;
  font-size: 12px;
}

.heatmap-cell {
  padding: 8px 6px;
  text-align: center;
  border-radius: 4px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.1s;
}

.heatmap-cell:hover { transform: scale(1.05); z-index: 1; }

.heatmap-header {
  padding: 8px 6px;
  text-align: center;
  font-weight: 700;
  font-size: 11px;
  color: var(--ey-text-light);
  text-transform: uppercase;
}

/* Bubble chart */
.bubble-container {
  position: relative;
  width: 100%;
  height: 400px;
  background: var(--ey-light-gray);
  border-radius: var(--radius);
  overflow: hidden;
}

/* Scatter plot */
.scatter-container {
  position: relative;
  width: 100%;
  height: 400px;
}

/* Bar chart containers */
.bar-chart {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.bar-row {
  display: flex;
  align-items: center;
  gap: 12px;
}

.bar-label {
  width: 120px;
  font-size: 12px;
  font-weight: 600;
  text-align: right;
  flex-shrink: 0;
}

.bar-track {
  flex: 1;
  height: 28px;
  background: var(--ey-light-gray);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}

.bar-fill {
  height: 100%;
  border-radius: 4px;
  display: flex;
  align-items: center;
  padding-left: 8px;
  font-size: 11px;
  font-weight: 700;
  color: white;
  transition: width 0.6s ease;
}

.bar-value {
  font-size: 12px;
  font-weight: 700;
  width: 70px;
  text-align: right;
  flex-shrink: 0;
}

/* Initiative cards */
.init-card {
  border: 1px solid var(--ey-mid-gray);
  border-radius: var(--radius);
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.init-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.init-card-title {
  font-weight: 700;
  font-size: 14px;
}

.init-card-meta {
  display: flex;
  gap: 16px;
  font-size: 12px;
  color: var(--ey-text-light);
}

.init-card-meta span { display: flex; align-items: center; gap: 4px; }

/* Tooltip */
.tooltip {
  position: absolute;
  background: var(--ey-dark);
  color: var(--ey-white);
  padding: 10px 14px;
  border-radius: 6px;
  font-size: 12px;
  z-index: 200;
  pointer-events: none;
  box-shadow: var(--shadow-md);
  max-width: 300px;
}

/* Status indicator for data */
.status-bar {
  background: var(--ey-blue-bg);
  border: 1px solid #90CAF9;
  border-radius: var(--radius);
  padding: 10px 16px;
  font-size: 13px;
  color: var(--ey-blue);
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
}

.status-bar.warning {
  background: var(--ey-amber-bg);
  border-color: #FFE082;
  color: var(--ey-amber);
}

/* Section headers within pages */
.section-header {
  font-size: 13px;
  font-weight: 700;
  color: var(--ey-text);
  margin: 20px 0 12px;
  padding-bottom: 6px;
  border-bottom: 2px solid var(--ey-yellow);
  display: inline-block;
}

/* Canvas wrapper */
.canvas-wrap {
  position: relative;
  width: 100%;
}

.canvas-wrap canvas {
  width: 100%;
  height: auto;
}

/* Stacked bar */
.stacked-bar-container {
  width: 100%;
  overflow-x: auto;
}

/* Gantt */
.gantt-container {
  position: relative;
  width: 100%;
  overflow-x: auto;
}

/* Mini sparkline */
.sparkline { display: inline-block; vertical-align: middle; }

/* Override badge */
.override-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: #EDE7F6;
  color: var(--ey-purple);
  font-size: 10px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 10px;
}

/* Initiative Editor Panel */
.init-editor {
  position: fixed; top: 0; right: -520px; width: 500px; height: 100vh;
  background: var(--ey-white); z-index: 200; box-shadow: -4px 0 24px rgba(0,0,0,0.15);
  transition: right 0.35s cubic-bezier(0.4,0,0.2,1); overflow-y: auto; padding: 0;
}
.init-editor.open { right: 0; }
.init-editor-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 199; display: none; }
.init-editor-backdrop.open { display: block; }
.init-editor-header {
  position: sticky; top: 0; z-index: 10; background: var(--ey-dark); color: var(--ey-white);
  padding: 16px 20px; display: flex; align-items: center; justify-content: space-between;
}
.init-editor-header h3 { font-size: 15px; font-weight: 700; }
.init-editor-body { padding: 20px; }
.init-field { margin-bottom: 14px; }
.init-field label { display: block; font-size: 11px; font-weight: 700; color: var(--ey-text-light); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
.init-field input, .init-field select { width: 100%; padding: 8px 10px; border: 1.5px solid var(--ey-mid-gray); border-radius: 6px; font-size: 13px; }
.init-field input:focus, .init-field select:focus { border-color: var(--ey-yellow); outline: none; box-shadow: 0 0 0 3px rgba(255,230,0,0.15); }
.init-field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.init-field-row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.chip-group { display: flex; flex-wrap: wrap; gap: 4px; }
.chip { display: inline-flex; align-items: center; gap: 3px; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; border: 1.5px solid var(--ey-mid-gray); background: var(--ey-white); cursor: pointer; transition: all 0.15s; }
.chip.active { background: var(--ey-yellow); border-color: var(--ey-yellow); color: var(--ey-dark); }
.chip:hover { border-color: var(--ey-yellow); }
.init-impact-preview {
  background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border: 1.5px solid var(--ey-green);
  border-radius: 8px; padding: 12px; margin-top: 12px;
}
.init-impact-preview .impact-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; text-align: center; }
.init-impact-preview .impact-val { font-size: 18px; font-weight: 800; color: var(--ey-green); }
.init-impact-preview .impact-lbl { font-size: 10px; color: var(--ey-text-light); }

/* Page-level override panel */
.page-override-bar {
  background: linear-gradient(135deg, #FFFDE7, #FFF8E1); border: 1.5px solid #FFE082;
  border-radius: 8px; padding: 10px 16px; margin-bottom: 12px;
  display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
}
.page-override-bar .pob-label { font-size: 11px; font-weight: 700; color: var(--ey-amber); white-space: nowrap; }
.page-override-bar input { width: 70px; padding: 5px 8px; border: 1.5px solid #FFE082; border-radius: 5px; font-size: 12px; text-align: center; }
.page-override-bar select { padding: 5px 8px; border: 1.5px solid #FFE082; border-radius: 5px; font-size: 12px; }
.page-override-bar button { padding: 5px 12px; border-radius: 5px; font-size: 11px; font-weight: 700; cursor: pointer; border: none; }

/* Recalculating indicator */
.recalc-toast {
  position: fixed; top: 12px; right: 12px; z-index: 300;
  background: var(--ey-dark); color: var(--ey-yellow); padding: 10px 20px;
  border-radius: 8px; font-size: 12px; font-weight: 700;
  box-shadow: var(--shadow-md); display: none; animation: fadeIn 0.2s;
}
.recalc-toast.show { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }

/* Editable table cell */
.editable-cell { cursor: pointer; position: relative; }
.editable-cell:hover { background: #FFFDE7 !important; }
.editable-cell::after { content: '‚úé'; position: absolute; right: 4px; top: 2px; font-size: 9px; opacity: 0; transition: 0.15s; }
.editable-cell:hover::after { opacity: 0.4; }

/* Consistency warning */
.consistency-warn {
  background: var(--ey-red-bg); border: 1.5px solid var(--ey-red); border-radius: 8px;
  padding: 10px 16px; margin-bottom: 12px; font-size: 12px; color: var(--ey-red);
  display: flex; align-items: center; gap: 8px;
}

/* Responsive */
@media (max-width: 1200px) {
  .grid-2 { grid-template-columns: 1fr; }
  .grid-3 { grid-template-columns: 1fr 1fr; }
}

@media (max-width: 900px) {
  .sidebar { width: 60px; }
  .sidebar .nav-item span:not(.nav-num) { display: none; }
  .sidebar .nav-phase { display: none; }
  .sidebar-logo h2, .sidebar-logo .sub { display: none; }
  .main { margin-left: 60px; }
  .topbar { left: 60px; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #C8C8D0; border-radius: 3px; }
.sidebar::-webkit-scrollbar-thumb { background: #555; }

/* Drill-down modal */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 500;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-overlay.hidden { display: none; }

.modal {
  background: var(--ey-white);
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.15);
  padding: 24px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.modal-close {
  width: 32px; height: 32px;
  border-radius: 50%;
  border: none;
  background: var(--ey-light-gray);
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Placeholder for pages not yet built */
.placeholder-page {
  text-align: center;
  padding: 80px 20px;
}

.placeholder-page .icon { font-size: 48px; margin-bottom: 16px; }
.placeholder-page h3 { font-size: 20px; margin-bottom: 8px; }
.placeholder-page p { color: var(--ey-text-light); max-width: 500px; margin: 0 auto; }

/* Waterfall chart specific */
.waterfall-bar { transition: all 0.4s ease; }

/* Loading shimmer */
@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}
.loading {
  background: linear-gradient(90deg, var(--ey-light-gray) 25%, #eee 50%, var(--ey-light-gray) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: var(--radius);
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SIDEBAR NAVIGATION
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <h1>EY GDS Intelligence</h1>
    <h2>Contact Navigator</h2>
    <div class="sub">Transformation Intelligence for Contact Centres</div>
  </div>
  <nav id="sidebarNav">
    <div class="nav-phase">üîç Diagnose</div>
    <div class="nav-item active" data-page="1">
      <span class="nav-num">1</span><span>Executive Summary</span>
    </div>
    <div class="nav-item" data-page="2">
      <span class="nav-num">2</span><span>Benchmarking</span>
    </div>
    <div class="nav-item" data-page="3">
      <span class="nav-num">3</span><span>Maturity Assessment</span>
    </div>

    <div class="nav-phase">üìä Understand</div>
    <div class="nav-item" data-page="4">
      <span class="nav-num">4</span><span>Performance Heatmap</span>
    </div>
    <div class="nav-item" data-page="5">
      <span class="nav-num">5</span><span>Friction Map</span>
    </div>
    <div class="nav-item" data-page="6">
      <span class="nav-num">6</span><span>Gap Analysis</span>
    </div>
    <div class="nav-item" data-page="7">
      <span class="nav-num">7</span><span>Cost Analysis</span>
    </div>

    <div class="nav-phase">üí° Recommend</div>
    <div class="nav-item" data-page="8">
      <span class="nav-num">8</span><span>Self-Service Feasibility</span>
    </div>
    <div class="nav-item" data-page="9">
      <span class="nav-num">9</span><span>Initiative Roadmap</span>
    </div>
    <div class="nav-item" data-page="10">
      <span class="nav-num">10</span><span>Channel Strategy</span>
    </div>

    <div class="nav-phase">üìã Plan</div>
    <div class="nav-item" data-page="11">
      <span class="nav-num">11</span><span>Implementation Gantt</span>
    </div>
    <div class="nav-item" data-page="12">
      <span class="nav-num">12</span><span>Risk Assessment</span>
    </div>
    <div class="nav-item" data-page="13">
      <span class="nav-num">13</span><span>Workforce Transition</span>
    </div>

    <div class="nav-phase">üéØ Justify &amp; Adjust</div>
    <div class="nav-item" data-page="14">
      <span class="nav-num">14</span><span>Impact Dashboard</span>
    </div>
    <div class="nav-item" data-page="15">
      <span class="nav-num">15</span><span>Overrides</span>
    </div>
  </nav>
</aside>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TOP BAR
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header class="topbar">
  <div class="topbar-left">
    <span class="topbar-title" id="topbarTitle">Executive Summary</span>
    <span class="topbar-question" id="topbarQuestion">Q1: How healthy is this contact centre?</span>
  </div>
  <div class="topbar-right">
    <button class="btn btn-outline btn-sm" onclick="refreshFromServer()" title="Reload from source data ‚Äî resets all overrides">‚Üª Refresh Data</button>
    <button class="btn btn-sm" style="background:#FFE600;color:#2E2E38;font-weight:600;" onclick="recalculateAll()" title="Re-run calculations with current edits ‚Äî preserves overrides">‚ö° Recalculate</button>
    <button class="btn btn-outline btn-sm" onclick="handleExport()">‚§ì Export Excel</button>
    <span id="topbarIndustry" style="font-size:12px; color:var(--ey-text-light);">Loading...</span>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN CONTENT AREA ‚Äî ALL 15 PAGES
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<main class="main">

  <!-- ‚îÄ‚îÄ‚îÄ PAGE 1: EXECUTIVE SUMMARY ‚îÄ‚îÄ‚îÄ -->
  <div class="page active" id="page-1"></div>

  <!-- ‚îÄ‚îÄ‚îÄ PAGE 2: BENCHMARKING ‚îÄ‚îÄ‚îÄ -->
  <div class="page" id="page-2"></div>

  <!-- ‚îÄ‚îÄ‚îÄ PAGE 3: MATURITY ASSESSMENT ‚îÄ‚îÄ‚îÄ -->
  <div class="page" id="page-3"></div>

  <!-- ‚îÄ‚îÄ‚îÄ PAGES 4-15: PLACEHOLDERS (Future Modules) ‚îÄ‚îÄ‚îÄ -->
  <div class="page" id="page-4"></div>
  <div class="page" id="page-5"></div>
  <div class="page" id="page-6"></div>
  <div class="page" id="page-7"></div>
  <div class="page" id="page-8"></div>
  <div class="page" id="page-9"></div>
  <div class="page" id="page-10"></div>
  <div class="page" id="page-11"></div>
  <div class="page" id="page-12"></div>
  <div class="page" id="page-13"></div>
  <div class="page" id="page-14"></div>
  <div class="page" id="page-15"></div>

</main>

<!-- Drill-down Modal -->
<div class="modal-overlay hidden" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" id="modalContent" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 id="modalTitle">Detail</h3>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- Recalculation toast -->
<div class="recalc-toast" id="recalcToast">üîÑ Recalculating model‚Ä¶</div>

<!-- Initiative Editor Slide Panel -->
<div class="init-editor-backdrop" id="initEditorBackdrop" onclick="closeInitEditor()"></div>
<div class="init-editor" id="initEditorPanel">
  <div class="init-editor-header">
    <h3 id="initEditorTitle">Edit Initiative</h3>
    <button style="background:none;border:none;color:var(--ey-white);font-size:22px;cursor:pointer;" onclick="closeInitEditor()">√ó</button>
  </div>
  <div class="init-editor-body" id="initEditorBody"></div>
</div>

<script>
/* ‚îÄ‚îÄ Global Error Handler ‚îÄ‚îÄ */
window.onerror = function(msg, url, line, col, err) {
  console.error('JS Error:', msg, 'at line', line);
  var el = document.getElementById('page-' + (typeof currentPage !== 'undefined' ? currentPage : 1));
  if (el && !el.innerHTML.trim()) {
    el.innerHTML = '<div style="padding:40px;color:#C5003E;"><h3>JavaScript Error</h3><pre style="white-space:pre-wrap;background:#f5f5f5;padding:16px;border-radius:8px;font-size:12px;">' + msg + '\nLine: ' + line + '\n' + (err && err.stack ? err.stack : '') + '</pre></div>';
  }
};

/* ‚îÄ‚îÄ Server Data Injection ‚îÄ‚îÄ */
{% if server_data %}
window.__SERVER_DATA = {{ server_data | safe }};
{% endif %}
{% raw %}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 0: CORE ‚Äî Navigation, State, Demo Data, Utilities
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// ‚îÄ‚îÄ‚îÄ PAGE METADATA ‚îÄ‚îÄ‚îÄ
const PAGE_META = {
  1:  { title: 'Executive Summary',      question: 'Q1: How healthy is this contact centre?' },
  2:  { title: 'Benchmarking',           question: 'Q2: How do we compare to industry peers?' },
  3:  { title: 'Maturity Assessment',    question: 'Q3: What\'s our maturity level?' },
  4:  { title: 'Performance Heatmap',    question: 'Q4: Where exactly is the pain?' },
  5:  { title: 'Friction Map',           question: 'Q5: Where are customers suffering most?' },
  6:  { title: 'Gap Analysis',           question: 'Q6: Why is it happening?' },
  7:  { title: 'Cost Analysis',          question: 'Q7: How much is it costing us?' },
  8:  { title: 'Self-Service Feasibility', question: 'Q8: Can we just automate everything?' },
  9:  { title: 'Initiative Roadmap',     question: 'Q9: What should we do about it?' },
  10: { title: 'Channel Strategy',       question: 'Q10: Which channels to invest vs shut down?' },
  11: { title: 'Implementation Gantt',   question: 'Q11: What\'s the implementation plan?' },
  12: { title: 'Risk Assessment',        question: 'Q12: What are the risks?' },
  13: { title: 'Workforce Transition',   question: 'Q13: What does the talent impact look like?' },
  14: { title: 'Impact Dashboard',      question: 'Q14: What\u0027s the business case?' },
  15: { title: 'Overrides',             question: 'Q15: Can I adjust the assumptions?' },
};

// ‚îÄ‚îÄ‚îÄ DATA LOADING: V6 ‚Äî Single source of truth with visible fallback ‚îÄ‚îÄ‚îÄ
// Priority: 1. __SERVER_DATA (Jinja-injected) ‚Üí 2. /api/data (XHR) ‚Üí 3. fallback demo
let DEMO;
let _DATA_SOURCE = 'unknown'; // 'server_inject', 'api', or 'demo_fallback'
let _LOAD_ERROR = null;

function _hydrateDemo(data) {
    // Derive arrays/fields the frontend needs from queue data (display-only, no math)
    if (!data.totalMonthlyCost && data.totalCost) data.totalMonthlyCost = data.totalCost / 12;
    const ann = data.volumeAnnualizationFactor || 12;
    if (!data.avgCPC && data.totalCost) data.avgCPC = data.totalCost / Math.max(data.totalVolumeAnnual || data.totalVolume * ann, 1);
    if (!data.intents) data.intents = [...new Set(data.queues.map(q => q.intent))];
    if (!data.channels) data.channels = [...new Set(data.queues.map(q => q.channel))];
    if (!data.bus) data.bus = [...new Set(data.queues.map(q => q.bu))];
    if (!data.intentComplexity) data.intentComplexity = Object.fromEntries(
        data.intents.map(i => [i, data.queues.find(q => q.intent === i)?.complexity || 0.5])
    );
    if (!data.channelCap) data.channelCap = {
        'Voice': 0.85, 'IVR': 0.30, 'Chat': 0.65, 'Email': 0.55,
        'App/Self-Service': 0.45, 'Social Media': 0.35, 'SMS/WhatsApp': 0.35, 'Retail/Walk-in': 0.80
    };
    if (!data.channelCost) data.channelCost = {
        'Voice': 1.00, 'IVR': 0.12, 'Chat': 0.55, 'Email': 0.45,
        'App/Self-Service': 0.15, 'Social Media': 0.40, 'SMS/WhatsApp': 0.10, 'Retail/Walk-in': 1.30
    };
    return data;
}

function _normalizeBenchmarks(data) {
    const defaultBenchmarks = {
        CSAT: { global: 3.9, voice: 4.0, chat: 4.0, email: 3.8, ivr: 3.5, direction: 'higher' },
        FCR: { global: 0.76, voice: 0.78, chat: 0.80, email: 0.75, ivr: 0.70, direction: 'higher' },
        AHT: { global: 5.5, voice: 5.0, chat: 8.0, email: 12.0, ivr: 3.0, direction: 'lower' },
        CPC: { global: 6.50, voice: 8.50, chat: 5.00, email: 4.00, ivr: 1.20, direction: 'lower' },
        Repeat: { global: 0.12, voice: 0.10, chat: 0.12, email: 0.15, ivr: 0.18, direction: 'lower' },
        Escalation: { global: 0.09, voice: 0.08, chat: 0.06, email: 0.10, ivr: 0.12, direction: 'lower' },
        CES: { global: 2.3, voice: 2.5, chat: 2.0, email: 2.5, ivr: 1.5, direction: 'lower' },
    };
    if (data.benchmarks && data.benchmarks._defaults) {
        const raw = data.benchmarks._raw || [];
        const normalized = {};
        for (const [metric, vals] of Object.entries(data.benchmarks._defaults)) {
            const entry = {};
            for (const [k, v] of Object.entries(vals)) {
                if (k === '_default') entry.global = v;
                else if (k === '_dir') entry.direction = v;
                else entry[k.toLowerCase()] = v;
            }
            if (!entry.global && entry._default) entry.global = entry._default;
            if (!entry.direction) entry.direction = 'lower';
            for (const r of raw) {
                if (r.metric === metric && r.channel) {
                    entry[r.channel.toLowerCase()] = r.average;
                    if (!entry.global) entry.global = r.average;
                }
                if (r.metric === metric && r.scope === 'global') {
                    entry.global = r.average;
                }
            }
            normalized[metric] = entry;
        }
        normalized._raw = raw;
        data.benchmarks = normalized;
    } else if (!data.benchmarks || Object.keys(data.benchmarks).length === 0) {
        data.benchmarks = defaultBenchmarks;
    }
    return data;
}

// ‚îÄ‚îÄ Step 1: Try __SERVER_DATA (Jinja-injected, most reliable) ‚îÄ‚îÄ
if (window.__SERVER_DATA && window.__SERVER_DATA.demo) {
    DEMO = _normalizeBenchmarks(_hydrateDemo(window.__SERVER_DATA.demo));
    _DATA_SOURCE = 'server_inject';
    console.log('V6: Loaded from __SERVER_DATA (Jinja inject)', DEMO.queues.length, 'queues,', DEMO.totalFTE, 'FTE');
} else {
    // ‚îÄ‚îÄ Step 2: Try /api/data (XHR fallback) ‚îÄ‚îÄ
    try {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/data', false);
        xhr.send();
        if (xhr.status === 200) {
            DEMO = _normalizeBenchmarks(_hydrateDemo(JSON.parse(xhr.responseText)));
            _DATA_SOURCE = 'api';
            console.log('V6: Loaded from /api/data', DEMO.queues.length, 'queues,', DEMO.totalFTE, 'FTE');
        } else {
            // Capture the actual error from the backend
            try { _LOAD_ERROR = JSON.parse(xhr.responseText); } catch(e) { _LOAD_ERROR = {error: 'API returned ' + xhr.status}; }
            console.error('V6: /api/data returned', xhr.status, _LOAD_ERROR);
            DEMO = _normalizeBenchmarks(_hydrateDemo(generateFallbackDemo()));
            _DATA_SOURCE = 'demo_fallback';
        }
    } catch(e) {
        _LOAD_ERROR = {error: e.message, hint: 'Is the Flask server running? (python app.py)'};
        console.error('V6: /api/data unavailable:', e.message);
        DEMO = _normalizeBenchmarks(_hydrateDemo(generateFallbackDemo()));
        _DATA_SOURCE = 'demo_fallback';
    }
}

// ‚îÄ‚îÄ Show data source banner ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
    if (_DATA_SOURCE === 'demo_fallback') {
        const banner = document.createElement('div');
        banner.id = 'demo-mode-banner';
        banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99999;background:#C5003E;color:white;padding:10px 20px;font-size:13px;font-weight:600;display:flex;align-items:center;justify-content:space-between;font-family:EYInterstate,sans-serif;';
        const reason = _LOAD_ERROR?.reason || _LOAD_ERROR?.error || 'Backend not connected';
        const hint = _LOAD_ERROR?.hint || 'Check terminal for errors, or move folder out of OneDrive';
        banner.innerHTML = `
            <div>
                <span style="font-size:16px;margin-right:8px;">‚ö†Ô∏è</span>
                <strong>DEMO MODE</strong> ‚Äî Numbers below are simulated, not from your data.
                <span style="opacity:0.85;margin-left:12px;">Reason: ${reason}</span>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
                <span style="font-size:11px;opacity:0.8;">${hint}</span>
                <button onclick="location.reload()" style="background:white;color:#C5003E;border:none;padding:5px 12px;border-radius:4px;font-weight:700;cursor:pointer;font-size:11px;">Retry</button>
                <button onclick="this.parentElement.parentElement.remove()" style="background:transparent;color:white;border:1px solid rgba(255,255,255,0.5);padding:5px 8px;border-radius:4px;cursor:pointer;font-size:11px;">Dismiss</button>
            </div>
        `;
        document.body.prepend(banner);
        // Push main content down
        document.body.style.paddingTop = '45px';
    }
});

function generateFallbackDemo() {
  const seed = 42;
  let _s = seed;
  function rng() { _s = (_s * 16807 + 0) % 2147483647; return _s / 2147483647; }
  function rngInt(a,b) { return Math.floor(a + rng() * (b - a + 1)); }
  function rngFloat(a,b) { return a + rng() * (b - a); }
  function clamp(v,lo,hi) { return Math.max(lo, Math.min(hi, v)); }

  const intents = [
    'Billing & Payments', 'Technical Support', 'Network Outage', 'Plan Change',
    'Device Troubleshooting', 'Service Cancellation', 'Roaming', 'Data Usage',
    'Contract Renewal', 'Complaints', 'New Connection', 'SIM Replacement',
    'Number Portability', 'Value-Added Services', 'General Enquiry'
  ];

  const channels = ['Voice', 'IVR', 'Chat', 'Email', 'App/Self-Service', 'Social Media', 'SMS/WhatsApp', 'Retail/Walk-in'];

  const intentComplexity = {
    'Billing & Payments': 0.25, 'Technical Support': 0.65, 'Network Outage': 0.70,
    'Plan Change': 0.35, 'Device Troubleshooting': 0.70, 'Service Cancellation': 0.60,
    'Roaming': 0.40, 'Data Usage': 0.15, 'Contract Renewal': 0.35,
    'Complaints': 0.75, 'New Connection': 0.25, 'SIM Replacement': 0.15,
    'Number Portability': 0.45, 'Value-Added Services': 0.30, 'General Enquiry': 0.20
  };

  const channelCap = {
    'Voice': 0.85, 'IVR': 0.30, 'Chat': 0.65, 'Email': 0.55,
    'App/Self-Service': 0.45, 'Social Media': 0.35, 'SMS/WhatsApp': 0.35, 'Retail/Walk-in': 0.80
  };

  const channelCost = {
    'Voice': 1.00, 'IVR': 0.12, 'Chat': 0.55, 'Email': 0.45,
    'App/Self-Service': 0.15, 'Social Media': 0.40, 'SMS/WhatsApp': 0.10, 'Retail/Walk-in': 1.30
  };

  const bus = ['Consumer', 'Business', 'Enterprise'];
  const buShare = { Consumer: 0.6, Business: 0.3, Enterprise: 0.1 };

  const queues = [];
  const baseCost = 8.50;

  for (const bu of bus) {
    for (const intent of intents) {
      const cmplx = intentComplexity[intent];
      const totalVol = rngInt(8000, 80000) * buShare[bu];

      for (const ch of channels) {
        const cap = channelCap[ch];
        const costTier = channelCost[ch];

        if (cmplx > 0.6 && cap < 0.30 && rng() < 0.6) continue;
        if (rng() < 0.15) continue;

        const vol = Math.max(100, Math.round(totalVol * (rng() * 0.3 + 0.05)));
        const match = Math.max(0, cap - cmplx * 0.5);
        const csat = clamp(3.0 + match * 2 + (rng() - 0.5) * 0.6, 1.5, 5.0);
        const fcr = clamp(0.55 + match * 0.35 + (rng() - 0.5) * 0.12, 0.25, 0.95);
        const aht = clamp(3 + cmplx * 8 * (ch === 'Email' ? 1.5 : ch === 'Chat' ? 1.2 : 1.0) + (rng() - 0.5) * 2, 1, 25);
        const cpc = clamp(baseCost * costTier * (1 + cmplx * 0.5) + (rng() - 0.5) * 0.8, 0.3, 25);
        const repeat = clamp((1 - fcr) * 0.5 + cmplx * 0.08 + (rng() - 0.5) * 0.04, 0.03, 0.40);
        const escalation = clamp(cmplx * 0.15 * (1 - cap * 0.3) + (rng() - 0.5) * 0.03, 0.01, 0.30);
        const ces = clamp(2 + (1 - match) * 2.5 + (rng() - 0.5) * 0.4, 1, 5);

        queues.push({
          bu, intent, channel: ch,
          volume: Math.round(vol),
          csat: +csat.toFixed(2),
          fcr: +fcr.toFixed(3),
          aht: +aht.toFixed(1),
          cpc: +cpc.toFixed(2),
          repeat: +repeat.toFixed(3),
          escalation: +escalation.toFixed(3),
          ces: +ces.toFixed(2),
          complexity: cmplx,
          capability: cap,
          costTier
        });
      }
    }
  }

  // Benchmarks (system defaults)
  const benchmarks = {
    CSAT:       { voice: 4.0, chat: 4.0, email: 3.8, ivr: 3.5, global: 3.9, direction: 'higher' },
    FCR:        { voice: 0.78, chat: 0.80, email: 0.75, ivr: 0.70, global: 0.76, direction: 'higher' },
    AHT:        { voice: 5.0, chat: 8.0, email: 12.0, ivr: 3.0, global: 6.5, direction: 'lower' },
    CPC:        { voice: 8.50, chat: 5.00, email: 4.00, ivr: 1.20, global: 5.50, direction: 'lower' },
    Repeat:     { voice: 0.10, chat: 0.12, email: 0.15, ivr: 0.18, global: 0.12, direction: 'lower' },
    Escalation: { voice: 0.08, chat: 0.06, email: 0.10, ivr: 0.12, global: 0.08, direction: 'lower' },
    CES:        { voice: 2.5, chat: 2.0, email: 2.5, ivr: 1.5, global: 2.2, direction: 'lower' },
  };

  // Workforce
  const roles = [
    { role: 'Agent L1', headcount: 820, costPerFTE: 55000, location: 'Onshore' },
    { role: 'Agent L2 / Specialist', headcount: 210, costPerFTE: 68000, location: 'Onshore' },
    { role: 'Agent L3 / Expert', headcount: 45, costPerFTE: 82000, location: 'Onshore' },
    { role: 'Supervisor / Team Lead', headcount: 85, costPerFTE: 72000, location: 'Onshore' },
    { role: 'QA Analyst', headcount: 35, costPerFTE: 58000, location: 'Onshore' },
    { role: 'WFM Analyst', headcount: 18, costPerFTE: 62000, location: 'Onshore' },
    { role: 'Back-Office / Processing', headcount: 120, costPerFTE: 42000, location: 'Nearshore' },
    { role: 'Trainer', headcount: 22, costPerFTE: 55000, location: 'Onshore' },
    { role: 'Knowledge Manager', headcount: 8, costPerFTE: 65000, location: 'Onshore' },
    { role: 'Reporting / Analytics', headcount: 14, costPerFTE: 70000, location: 'Onshore' },
  ];

  const params = {
    programName: 'CC Transformation',
    industry: DEMO.params?.industry || 'Custom',
    horizon: 3,
    discountRate: 0.10,
    volumeGrowth: 0.02,
    wageInflation: 0.03,
    attritionMonthly: 0.03,
    redeploymentPct: 0.10,
    currency: 'USD',
  };

  const totalFTE = roles.reduce((s, r) => s + r.headcount, 0);
  const totalMonthlyCost = roles.reduce((s, r) => s + r.headcount * r.costPerFTE / 12, 0);
  const totalVolume = queues.reduce((s, q) => s + q.volume, 0);
  const avgCSAT = queues.reduce((s, q) => s + q.csat * q.volume, 0) / totalVolume;
  const avgFCR = queues.reduce((s, q) => s + q.fcr * q.volume, 0) / totalVolume;
  const avgAHT = queues.reduce((s, q) => s + q.aht * q.volume, 0) / totalVolume;

  return {
    queues, benchmarks, roles, params, intents, channels, bus,
    intentComplexity, channelCap, channelCost,
    totalFTE, totalMonthlyCost, totalVolume, avgCSAT, avgFCR, avgAHT,
  };
}

// ‚îÄ‚îÄ‚îÄ UTILITY FUNCTIONS ‚îÄ‚îÄ‚îÄ
function fmt(n, type) {
  if (type === '$') return '$' + Number(n).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
  if (type === '$k') return '$' + (n / 1000).toFixed(0) + 'K';
  if (type === '$m') return '$' + (n / 1000000).toFixed(1) + 'M';
  if (type === '%') return (n * 100).toFixed(1) + '%';
  if (type === 'dec') return Number(n).toFixed(2);
  if (type === 'int') return Math.round(n).toLocaleString();
  if (type === 'min') return Number(n).toFixed(1) + ' min';
  return String(n);
}

function ragColor(score) {
  if (score >= 0.90) return 'green';
  if (score >= 0.70) return 'amber';
  return 'red';
}

function ragBg(color) {
  return { green: '#168736', amber: '#D97706', red: '#C5003E' }[color];
}

function ragBgLight(color) {
  return { green: 'var(--ey-green-bg)', amber: 'var(--ey-amber-bg)', red: 'var(--ey-red-bg)' }[color];
}

function metricScore(actual, benchmark, direction) {
  if (direction === 'higher') return Math.min(1.5, actual / benchmark);
  return Math.min(1.5, benchmark / actual);
}

function metricScoreNorm(actual, benchmark, direction) {
  const raw = metricScore(actual, benchmark, direction);
  return Math.max(0, Math.min(1, raw));
}

function getBmVal(metric, chKey) {
  const m = DEMO.benchmarks[metric];
  if (!m) return 1;
  // Try exact key, then Title Case, then lowercase, then _default/global fallback
  return m[chKey] || m[chKey.charAt(0).toUpperCase() + chKey.slice(1)]
      || m[chKey.toLowerCase()] || m._default || m.global || 1;
}

function getQueueHealth(q) {
  const ch = q.channel || '';
  const chKey = ch.toLowerCase().includes('ivr') ? 'ivr' :
                ch.toLowerCase().includes('chat') ? 'chat' :
                ch.toLowerCase().includes('email') ? 'email' :
                ch.toLowerCase().includes('voice') ? 'voice' : 'global';

  const csatS = metricScoreNorm(q.csat || 0, getBmVal('CSAT', chKey), 'higher');
  const fcrS  = metricScoreNorm(q.fcr || 0,  getBmVal('FCR', chKey), 'higher');
  const ahtS  = metricScoreNorm(q.aht || 1,  getBmVal('AHT', chKey), 'lower');
  const cpcS  = metricScoreNorm(q.cpc || 1,  getBmVal('CPC', chKey), 'lower');
  const repS  = metricScoreNorm(q.repeat || 0, getBmVal('Repeat', chKey), 'lower');
  const escS  = metricScoreNorm(q.escalation || 0, getBmVal('Escalation', chKey), 'lower');
  const cesS  = metricScoreNorm(q.ces || 1,  getBmVal('CES', chKey), 'lower');

  return csatS*0.20 + fcrS*0.20 + ahtS*0.15 + cpcS*0.15 + repS*0.10 + escS*0.10 + cesS*0.10;
}

function getHealthScore() {
  let totalW = 0, totalS = 0;
  for (const q of DEMO.queues) {
    const h = getQueueHealth(q);
    totalS += h * q.volume;
    totalW += q.volume;
  }
  return (totalS / totalW) * 100;
}

function getChannelBenchmark(channel, metric) {
  const bm = DEMO.benchmarks[metric];
  if (!bm) return null;
  const chKey = channel.toLowerCase().includes('ivr') ? 'ivr' :
                channel.toLowerCase().includes('chat') ? 'chat' :
                channel.toLowerCase().includes('email') ? 'email' :
                channel.toLowerCase().includes('voice') ? 'voice' : 'global';
  return bm[chKey] || bm[chKey.charAt(0).toUpperCase() + chKey.slice(1)] || bm._default || bm.global || null;
}

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ
let currentPage = 1;

function navigateTo(page) {
  currentPage = page;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(`page-${page}`).classList.add('active');
  document.querySelector(`.nav-item[data-page="${page}"]`).classList.add('active');
  document.getElementById('topbarTitle').textContent = PAGE_META[page].title;
  document.getElementById('topbarQuestion').textContent = PAGE_META[page].question;

  // Update industry label dynamically (Change 3)
  const indEl = document.getElementById('topbarIndustry');
  if (indEl && DEMO?.params?.industry) indEl.textContent = DEMO.params.industry + ' Data';

  // Render page if needed
  renderPage(page);
}

document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => navigateTo(+item.dataset.page));
});

// Set industry label on initial load
setTimeout(() => {
  const indEl = document.getElementById('topbarIndustry');
  if (indEl && DEMO?.params?.industry) indEl.textContent = DEMO.params.industry + ' Data';
}, 100);

function handleExport() {
  window.open('/api/export', '_blank');
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ
function openModal(title, bodyHTML) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = bodyHTML;
  document.getElementById('modalOverlay').classList.remove('hidden');
}

function closeModal(e) {
  if (e && e.target && e.target !== document.getElementById('modalOverlay')) return;
  document.getElementById('modalOverlay').classList.add('hidden');
}

// ‚îÄ‚îÄ‚îÄ PAGE RENDER DISPATCHER ‚îÄ‚îÄ‚îÄ
const rendered = {};

function renderPage(page) {
  if (rendered[page]) return;
  try {
    switch (page) {
      case 1: renderPage1(); break;
      case 2: renderPage2(); break;
      case 3: renderPage3(); break;
      case 4: renderPage4(); break;
      case 5: renderPage5(); break;
      case 6: renderPage6(); break;
      case 7: renderPage7(); break;
      case 8: renderPage8(); break;
      case 9: renderPage9(); break;
      case 10: renderPage10(); break;
      case 11: renderPage11(); break;
      case 12: renderPage12(); break;
      case 13: renderPage13(); break;
      case 14: renderPage14(); break;
      case 15: renderPage15(); break;
      default: renderPlaceholder(page); break;
    }
    rendered[page] = true;
  } catch(err) {
    console.error('Page ' + page + ' render error:', err);
    var el = document.getElementById('page-' + page);
    if (el) el.innerHTML = '<div style="padding:40px;color:#C5003E;"><h3 style="margin-bottom:12px;">Page ' + page + ' Error</h3><pre style="white-space:pre-wrap;background:#f5f5f5;padding:16px;border-radius:8px;font-size:12px;max-height:400px;overflow:auto;">' + String(err.message || err) + '\n\n' + String(err.stack || '') + '</pre><p style="margin-top:12px;color:#666;font-size:13px;">Press F12 and check Console for full details. Click Refresh Data to retry.</p></div>';
  }
}

function renderPlaceholder(page) {
  const icons = { 4:'üî•', 5:'üò£', 6:'üîç', 7:'üí∞', 8:'ü§ñ', 9:'üó∫Ô∏è', 10:'üì°', 11:'üìä', 12:'‚ö†Ô∏è', 13:'üë•', 14:'üìà', 15:'‚öôÔ∏è' };
  document.getElementById(`page-${page}`).innerHTML = `
    <div class="placeholder-page">
      <div class="icon">${icons[page] || 'üìÑ'}</div>
      <h3>${PAGE_META[page].title}</h3>
      <p>This page will be built in the next frontend module. The navigation structure and data model are ready.</p>
      <p style="margin-top:12px; font-size:12px; color:var(--ey-text-light);">${PAGE_META[page].question}</p>
    </div>`;
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 1: PAGE 1 ‚Äî EXECUTIVE SUMMARY
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage1() {
  const health = getHealthScore();
  const healthColor = health >= 70 ? 'var(--ey-green)' : health >= 40 ? 'var(--ey-amber)' : 'var(--ey-red)';

  // Top 5 problem areas
  const queueScores = DEMO.queues.map(q => ({
    ...q,
    health: getQueueHealth(q) * 100,
    monthlyCost: q.volume * q.cpc
  }));
  queueScores.sort((a, b) => a.health - b.health);
  const top5 = queueScores.slice(0, 10);

  // Summary projected values ‚Äî sourced from waterfall engine
  const wf = WATERFALL;
  const projFTEReduction = wf.totalReduction;
  const projSavings = wf.yearly[wf.yearly.length-1]?.annualSaving || 0;
  const projCSAT = Math.min(5, DEMO.avgCSAT + 0.35);
  const projFCR = Math.min(0.95, DEMO.avgFCR + 0.08);
  const projAHT = DEMO.avgAHT_min * (1 - (projFTEReduction / DEMO.totalFTE) * 0.6);

  const el = document.getElementById('page-1');
  el.innerHTML = `
    <div class="status-bar">
      üìä ${DEMO.params?.clientName || 'Client'} ‚Äî ${DEMO.params?.industry || 'Custom'} ‚Äî ${DEMO.intents?.length || '?'} intents √ó ${DEMO.channels?.length || '?'} channels √ó ${DEMO.bus?.length || '?'} BUs ‚Äî ${DEMO.queues.length} queues loaded
    </div>

    <!-- CR-001: Investment Decision Summary (merged from Impact Dashboard) -->
    <div class="card" style="background:linear-gradient(135deg,#1a1a2e,#2E2E38);color:white;margin-bottom:16px;border:2px solid var(--ey-yellow);">
      <div style="display:flex;align-items:flex-start;gap:16px;">
        <div style="font-size:36px;">üéØ</div>
        <div style="flex:1;">
          <div style="font-size:16px;font-weight:800;color:var(--ey-yellow);margin-bottom:8px;">Investment Decision Summary</div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px;">
            <div><div style="font-size:24px;font-weight:800;color:var(--ey-yellow);">${fmt(wf.totalInvestment||0,'$m')}</div><div style="font-size:10px;opacity:0.7;">Total Investment</div></div>
            <div><div style="font-size:24px;font-weight:800;color:#4CAF50;">${fmt(wf.totalNPV||0,'$m')}</div><div style="font-size:10px;opacity:0.7;">NPV (${DEMO.params?.horizon||3}-yr)</div></div>
            <div><div style="font-size:24px;font-weight:800;color:#4CAF50;">${fmt(wf.totalSaving||0,'$m')}</div><div style="font-size:10px;opacity:0.7;">Total Saving</div></div>
            <div><div style="font-size:24px;font-weight:800;color:#4CAF50;">${(wf.irr||0).toFixed(0)}%</div><div style="font-size:10px;opacity:0.7;">IRR</div></div>
          </div>
          <div style="font-size:12px;opacity:0.85;line-height:1.5;">
            ${INITIATIVES.filter(i=>i.enabled).length} initiatives enabled targeting <strong>${projFTEReduction} FTE</strong> reduction with <strong>${fmt(wf.totalNPV||0,'$m')}</strong> NPV over ${DEMO.params?.horizon||3} years.
            <span style="cursor:pointer;text-decoration:underline;color:var(--ey-yellow);" onclick="navigateTo(14)">View detailed Impact Dashboard ‚Üí</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Health Score + KPIs -->
    <div class="grid-2-1" style="margin-bottom:16px;">
      <div>
        <div class="kpi-row">
          <div class="kpi-card">
            <div class="kpi-label">Total FTE</div>
            <div class="kpi-value">${fmt(DEMO.totalFTE, 'int')}<span style="font-size:12px;font-weight:400;color:var(--ey-text-light);"> FTE</span></div>
            <div class="kpi-sub">Across ${DEMO.roles.length} role types</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Monthly Cost</div>
            <div class="kpi-value">${fmt(DEMO.totalMonthlyCost, '$k')}<span style="font-size:12px;font-weight:400;color:var(--ey-text-light);">/mo</span></div>
            <div class="kpi-sub">${fmt(DEMO.totalMonthlyCost * 12, '$m')}/year total</div>
          </div>
          <div class="kpi-card ${DEMO.avgCSAT >= 3.8 ? 'green' : DEMO.avgCSAT >= 3.3 ? 'amber' : 'red'}">
            <div class="kpi-label">Avg CSAT</div>
            <div class="kpi-value">${DEMO.avgCSAT.toFixed(2)}<span style="font-size:14px;font-weight:400;color:var(--ey-text-light);"> /5</span></div>
            <div class="kpi-sub">Target: 4.20 /5</div>
          </div>
          <div class="kpi-card ${DEMO.avgFCR >= 0.76 ? 'green' : DEMO.avgFCR >= 0.65 ? 'amber' : 'red'}">
            <div class="kpi-label">Avg FCR</div>
            <div class="kpi-value">${fmt(DEMO.avgFCR, '%')}</div>
            <div class="kpi-sub">Target: 82%</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Avg AHT</div>
            <div class="kpi-value">${fmt(DEMO.avgAHT_min, 'min')}</div>
            <div class="kpi-sub">Across all channels</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Annual Volume</div>
            <div class="kpi-value">${((DEMO.totalVolumeAnnual || DEMO.totalVolume * (DEMO.volumeAnnualizationFactor || 12)) / 1000).toFixed(0)}K<span style="font-size:12px;font-weight:400;color:var(--ey-text-light);"> contacts/yr</span></div>
            <div class="kpi-sub">${DEMO.queues.length} queue combos</div>
          </div>
        </div>
      </div>
      <div class="card" style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div class="health-gauge">
          <canvas id="healthGauge" width="200" height="200"></canvas>
          <div class="health-gauge-value">
            <div class="score" style="color:${healthColor}">${Math.round(health)}</div>
            <div class="label">Health Score</div>
          </div>
        </div>
        <div style="text-align:center; margin-top:8px; font-size:12px; color:var(--ey-text-light);">
          ${health >= 70 ? 'Healthy ‚Äî minor improvements available' : health >= 40 ? 'Needs Attention ‚Äî significant opportunities' : 'Critical ‚Äî urgent transformation required'}
        </div>
      </div>
    </div>

    <!-- Top 10 Problem Areas -->
    <div class="card">
      <div class="card-title">üö® Top 10 Problem Areas</div>
      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>Severity</th><th>BU</th><th>Intent</th><th>Channel</th>
              <th>Health (/100)</th><th>CSAT (/5)</th><th>FCR</th><th>AHT (min)</th><th>Cost ($/mo)</th>
            </tr>
          </thead>
          <tbody>
            ${top5.map(q => {
              const sev = q.health < 30 ? 'critical' : q.health < 50 ? 'high' : q.health < 70 ? 'medium' : 'low';
              return `<tr style="cursor:pointer" onclick="drillDown('${q.bu}','${q.intent}','${q.channel}')">
                <td><span class="badge badge-${sev}">${sev.charAt(0).toUpperCase()+sev.slice(1)}</span></td>
                <td>${q.bu}</td><td>${q.intent}</td><td>${q.channel}</td>
                <td><strong>${q.health.toFixed(0)}</strong><span style="font-size:9px;color:var(--ey-text-light);">/100</span></td>
                <td>${q.csat.toFixed(2)} <span style="font-size:9px;color:var(--ey-text-light);">/5</span></td>
                <td>${fmt(q.fcr, '%')}</td>
                <td>${fmt(q.aht, 'min')}</td>
                <td>${fmt(q.monthlyCost, '$')}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Top 3 Priority Initiatives (dynamic from waterfall) -->
    <div class="card">
      <div class="card-title">üéØ Top 3 Priority Initiatives <span style="font-size:11px; font-weight:400; color:var(--ey-text-light);">Click to edit</span></div>
      <div class="grid-3">
        ${(() => {
          const top10 = [...INITIATIVES].filter(i => i.enabled && i._annualSaving > 0).sort((a,b) => b._annualSaving - a._annualSaving).slice(0,10);
          const layerColors = { 'AI & Automation': 'var(--ey-blue)', 'Operating Model': 'var(--ey-teal)', 'Location Strategy': 'var(--ey-amber)' };
          const layerBg = { 'AI & Automation': 'var(--ey-blue-bg)', 'Operating Model': '#E0F7FA', 'Location Strategy': 'var(--ey-amber-bg)' };
          return top10.slice(0,10).map((init, i) => `
            <div class="init-card" style="border-left:4px solid ${layerColors[init.layer]}; cursor:pointer;" onclick="openInitEditor(${INITIATIVES.indexOf(init)})">
              <div class="init-card-header">
                <span class="init-card-title">${init.id} ‚Äî ${init.name}</span>
                <span class="badge" style="background:${layerBg[init.layer]}; color:${layerColors[init.layer]};">${init.layer.split(' ')[0]}</span>
              </div>
              <div class="init-card-meta">
                <span>üí∞ ${fmt(init._annualSaving, '$k')}/yr</span>
                <span>üë• ‚àí${init._fteImpact?.toFixed(0) || '‚Äî'} FTE</span>
              </div>
              <div style="font-size:12px; color:var(--ey-text-light);">${(init._effectiveImpact*100).toFixed(0)}% ${init.lever.replace(/_/g,' ')} on ${init.channels.slice(0,3).join(', ')}${init.channels.length>3 ? '‚Ä¶' : ''}</div>
            </div>
          `).join('');
        })()}
      </div>
    </div>

    <!-- Before vs After -->
    <div class="card">
      <div class="card-title">üìä Before vs After Summary (${DEMO.params.horizon}-Year Projection)</div>
      <div class="compare-row">
        <div class="compare-card before">
          <div style="font-size:11px; font-weight:700; color:var(--ey-text-light); text-transform:uppercase; letter-spacing:1px; margin-bottom:12px;">Current State</div>
          <div style="font-size:32px; font-weight:800;">${fmt(DEMO.totalFTE, 'int')} <span style="font-size:14px;font-weight:400;">FTE</span></div>
          <div style="font-size:12px; color:var(--ey-text-light); margin-bottom:8px;">Total Headcount</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px;">
            <div><strong>${fmt(DEMO.totalMonthlyCost * 12, '$m')}</strong><br><span style="font-size:11px; color:var(--ey-text-light);">Annual Cost</span></div>
            <div><strong>${DEMO.avgCSAT.toFixed(2)} /5</strong><br><span style="font-size:11px; color:var(--ey-text-light);">Avg CSAT</span></div>
            <div><strong>${fmt(DEMO.avgFCR, '%')}</strong><br><span style="font-size:11px; color:var(--ey-text-light);">Avg FCR</span></div>
            <div><strong>${fmt(DEMO.avgAHT_min, 'min')}</strong><br><span style="font-size:11px; color:var(--ey-text-light);">Avg AHT</span></div>
          </div>
        </div>
        <div class="compare-arrow">‚Üí</div>
        <div class="compare-card after">
          <div style="font-size:11px; font-weight:700; color:var(--ey-green); text-transform:uppercase; letter-spacing:1px; margin-bottom:12px;">Projected (Year ${DEMO.params.horizon})</div>
          <div style="font-size:32px; font-weight:800; color:var(--ey-green);">${fmt(DEMO.totalFTE - projFTEReduction, 'int')} <span style="font-size:14px;font-weight:400;">FTE</span></div>
          <div style="font-size:12px; color:var(--ey-text-light); margin-bottom:8px;">Projected (‚àí${projFTEReduction} FTE)</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px;">
            <div><strong style="color:var(--ey-green)">${fmt((DEMO.totalMonthlyCost * 12) - projSavings, '$m')}</strong><br><span style="font-size:11px; color:var(--ey-text-light);">Annual Cost</span></div>
            <div><strong style="color:var(--ey-green)">${projCSAT.toFixed(2)} /5</strong><br><span style="font-size:11px; color:var(--ey-text-light);">Proj CSAT</span></div>
            <div><strong style="color:var(--ey-green)">${fmt(projFCR, '%')}</strong><br><span style="font-size:11px; color:var(--ey-text-light);">Proj FCR</span></div>
            <div><strong style="color:var(--ey-green)">${fmt(projAHT, 'min')}</strong><br><span style="font-size:11px; color:var(--ey-text-light);">Proj AHT</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- FTE Waterfall Step-Down Chart (Change 2) -->
    <div class="card">
      <div class="card-title">üìâ FTE Impact Waterfall ‚Äî Baseline to Target</div>
      <div style="font-size:11px;color:var(--ey-text-light);margin-bottom:12px;">
        Step-down from current FTE to projected FTE by transformation layer
      </div>
      <canvas id="fteWaterfallChart" width="700" height="260"></canvas>
    </div>

    <!-- Executive Recommendation ("So What") -->
    <div class="card" style="background:linear-gradient(135deg,#1a1a2e,#2E2E38);color:white;border:2px solid var(--ey-yellow);">
      <div style="display:flex;align-items:flex-start;gap:16px;">
        <div style="font-size:36px;">üéØ</div>
        <div style="flex:1;">
          <div style="font-size:15px;font-weight:800;color:var(--ey-yellow);margin-bottom:6px;">Executive Recommendation</div>
          <div style="font-size:12px;line-height:1.6;opacity:0.9;">
            Your contact centre is operating at <strong style="color:${health >= 70 ? '#4CAF50' : health >= 40 ? '#FFB300' : '#EF5350'};">${Math.round(health)}/100</strong> health.
            A ${DEMO.params.horizon}-year transformation across <strong>${WATERFALL.enabledInits.length} initiatives</strong> can reduce
            <strong style="color:var(--ey-yellow);">${projFTEReduction} FTE</strong> (${(projFTEReduction/DEMO.totalFTE*100).toFixed(0)}% of workforce) while improving CSAT by
            <strong>${(projCSAT - DEMO.avgCSAT).toFixed(2)} points</strong>.
            NPV: <strong style="color:#4CAF50;">${fmt(WATERFALL.totalNPV,'$m')}</strong> with IRR of <strong>${WATERFALL.irr?.toFixed(0)||0}%</strong>.
            <span style="color:var(--ey-yellow);font-weight:700;">Recommend proceeding to detailed design.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Year-over-Year Mini Table (clickable ‚Äî shows deltas from prior year) -->
    <div class="card">
      <div class="card-title">üìÖ Year-over-Year Projection <span style="font-size:11px; font-weight:400; color:var(--ey-text-light); margin-left:8px;">Click any cell to see calculation breakdown</span></div>
      ${(() => {
        // Pre-compute all yearly values so we can show deltas
        const yoyData = { fte: [DEMO.totalFTE], cost: [DEMO.totalMonthlyCost * 12], saving: [0] };
        // Use waterfall-computed yearly data
        const wfY = WATERFALL.yearly;
        for (let i = 0; i < DEMO.params.horizon; i++) {
          yoyData.fte.push(wfY[i]?.finalFTE || DEMO.totalFTE);
          yoyData.cost.push(wfY[i]?.futureCost || DEMO.totalMonthlyCost * 12);
          yoyData.saving.push(wfY[i]?.annualSaving || 0);
        }
        // Store globally for drill-down access
        window._yoyData = yoyData;
        window._projFTEReduction = projFTEReduction;
        window._projSavings = projSavings;

        return `<table class="data-table" style="cursor:pointer;">
          <thead>
            <tr>
              <th>Metric</th><th>Baseline</th>
              ${Array.from({length: DEMO.params.horizon}, (_, i) => `<th>Year ${i+1}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>FTE</strong></td>
              <td>${fmt(yoyData.fte[0], 'int')}</td>
              ${Array.from({length: DEMO.params.horizon}, (_, i) => {
                const curr = yoyData.fte[i+1];
                const prev = yoyData.fte[i];
                const delta = curr - prev;
                return `<td onclick="showYoYCalc('FTE', ${i+1})" style="cursor:pointer;">
                  ${fmt(curr, 'int')}
                  <div style="font-size:11px; color:var(--ey-green); font-weight:600;">
                    ${delta < 0 ? '‚ñº' : '‚Äî'} ${Math.abs(delta)} vs Yr ${i === 0 ? 'Base' : i}
                  </div>
                </td>`;
              }).join('')}
            </tr>
            <tr>
              <td><strong>Annual Cost</strong></td>
              <td>${fmt(yoyData.cost[0], '$m')}</td>
              ${Array.from({length: DEMO.params.horizon}, (_, i) => {
                const curr = yoyData.cost[i+1];
                const prev = yoyData.cost[i];
                const delta = curr - prev;
                return `<td onclick="showYoYCalc('Cost', ${i+1})" style="cursor:pointer;">
                  ${fmt(curr, '$m')}
                  <div style="font-size:11px; color:${delta < 0 ? 'var(--ey-green)' : 'var(--ey-red)'}; font-weight:600;">
                    ${delta < 0 ? '‚ñº' : '‚ñ≤'} ${fmt(Math.abs(delta), '$k')} vs Yr ${i === 0 ? 'Base' : i}
                  </div>
                </td>`;
              }).join('')}
            </tr>
            <tr>
              <td><strong>Net Saving</strong></td>
              <td style="color:var(--ey-text-light);">‚Äî</td>
              ${Array.from({length: DEMO.params.horizon}, (_, i) => {
                const curr = yoyData.saving[i+1];
                const prev = yoyData.saving[i];
                const delta = curr - prev;
                return `<td onclick="showYoYCalc('Saving', ${i+1})" style="cursor:pointer; color:var(--ey-green); font-weight:700;">
                  ${fmt(curr, '$m')}
                  <div style="font-size:11px; font-weight:600;">
                    +${fmt(delta, '$k')} incremental
                  </div>
                </td>`;
              }).join('')}
            </tr>
            <tr style="background:var(--ey-light-gray);">
              <td><strong>Cumulative Saving</strong></td>
              <td style="color:var(--ey-text-light);">‚Äî</td>
              ${(() => {
                let cumul = 0;
                return Array.from({length: DEMO.params.horizon}, (_, i) => {
                  cumul += yoyData.saving[i+1];
                  return `<td onclick="showYoYCalc('Cumulative', ${i+1})" style="cursor:pointer; font-weight:700; color:var(--ey-green);">
                    ${fmt(cumul, '$m')}
                  </td>`;
                }).join('');
              })()}
            </tr>
          </tbody>
        </table>`;
      })()}
    </div>
  `;

  // Draw health gauge
  drawHealthGauge(health, healthColor);

  // Draw FTE Waterfall step-down chart (Change 2)
  drawFTEWaterfallChart();
}

function drawFTEWaterfallChart() {
  const canvas = document.getElementById('fteWaterfallChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);

  const baseline = DEMO.totalFTE;
  const layerFTE = WATERFALL.layerFTE || DEMO.layerFTE || {};
  const aiRed = layerFTE['AI & Automation'] || 0;
  const opRed = layerFTE['Operating Model'] || 0;
  const locRed = layerFTE['Location Strategy'] || 0;
  const totalRed = aiRed + opRed + locRed;
  const finalFTE = Math.max(0, baseline - totalRed);

  // Data for waterfall bars
  const bars = [
    { label: 'Baseline FTE', value: baseline, color: '#2E2E38', type: 'total' },
    { label: 'AI & Automation', value: -aiRed, color: '#1A73E8', type: 'decrease' },
    { label: 'Operating Model', value: -opRed, color: '#00897B', type: 'decrease' },
    { label: 'Location Strategy', value: -locRed, color: '#FF9800', type: 'decrease' },
    { label: 'Target FTE', value: finalFTE, color: '#4CAF50', type: 'total' },
  ];

  const pad = { top: 30, bottom: 40, left: 60, right: 30 };
  const chartW = W - pad.left - pad.right;
  const chartH = H - pad.top - pad.bottom;
  const barW = chartW / bars.length * 0.55;
  const gap = chartW / bars.length;
  const maxVal = baseline * 1.05;

  function yScale(v) { return pad.top + chartH - (v / maxVal) * chartH; }

  // Grid lines
  ctx.strokeStyle = '#E8E8ED'; ctx.lineWidth = 0.5;
  for (let i = 0; i <= 4; i++) {
    const v = (maxVal / 4) * i;
    const y = yScale(v);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#888'; ctx.font = '10px Inter, sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(Math.round(v).toLocaleString(), pad.left - 6, y + 3);
  }

  // Draw bars
  let runningTotal = 0;
  bars.forEach((bar, i) => {
    const x = pad.left + i * gap + (gap - barW) / 2;
    let barTop, barBottom, barHeight;

    if (bar.type === 'total') {
      barTop = yScale(bar.value);
      barBottom = yScale(0);
      barHeight = barBottom - barTop;
      ctx.fillStyle = bar.color;
      ctx.fillRect(x, barTop, barW, barHeight);
      runningTotal = bar.value;
    } else {
      const prevTotal = runningTotal;
      const decrease = Math.abs(bar.value);
      barTop = yScale(prevTotal);
      barHeight = (decrease / maxVal) * chartH;
      // Fill the decrease portion
      ctx.fillStyle = bar.color + '33';
      ctx.fillRect(x, barTop, barW, barHeight);
      ctx.fillStyle = bar.color;
      ctx.fillRect(x, barTop, barW, barHeight);
      ctx.globalAlpha = 0.15;
      ctx.fillStyle = '#fff';
      ctx.fillRect(x, barTop, barW, barHeight);
      ctx.globalAlpha = 1.0;
      // Connector line from previous bar
      if (i > 0) {
        ctx.strokeStyle = '#B0B0B8'; ctx.lineWidth = 1; ctx.setLineDash([3, 3]);
        ctx.beginPath();
        ctx.moveTo(x - (gap - barW) / 2, yScale(prevTotal));
        ctx.lineTo(x, yScale(prevTotal));
        ctx.stroke();
        ctx.setLineDash([]);
      }
      runningTotal = prevTotal - decrease;
    }

    // Value label
    ctx.fillStyle = '#2E2E38'; ctx.font = 'bold 11px Inter, sans-serif'; ctx.textAlign = 'center';
    if (bar.type === 'total') {
      ctx.fillText(Math.round(bar.value).toLocaleString(), x + barW / 2, yScale(bar.value) - 6);
    } else {
      ctx.fillStyle = bar.color;
      ctx.fillText('‚àí' + Math.round(Math.abs(bar.value)).toLocaleString(), x + barW / 2, barTop + barHeight / 2 + 4);
    }

    // X-axis label
    ctx.fillStyle = '#555'; ctx.font = '10px Inter, sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(bar.label, x + barW / 2, H - pad.bottom + 16);
  });

  // Connector from last decrease to final total
  const lastDecIdx = 3;
  const finalIdx = 4;
  const lastX = pad.left + lastDecIdx * gap + (gap - barW) / 2 + barW;
  const finalX = pad.left + finalIdx * gap + (gap - barW) / 2;
  ctx.strokeStyle = '#B0B0B8'; ctx.lineWidth = 1; ctx.setLineDash([3, 3]);
  ctx.beginPath();
  ctx.moveTo(lastX, yScale(finalFTE));
  ctx.lineTo(finalX, yScale(finalFTE));
  ctx.stroke();
  ctx.setLineDash([]);
}

// ‚îÄ‚îÄ‚îÄ YoY Calculation Drill-Down ‚îÄ‚îÄ‚îÄ
function showYoYCalc(metric, year) {
  const d = window._yoyData;
  const horizon = DEMO.params.horizon;
  const rampFactor = (year/horizon) * (0.4 + 0.6 * ((year-1)/(horizon-1||1)));
  const prevRampFactor = year > 1 ? ((year-1)/horizon) * (0.4 + 0.6 * ((year-2)/(horizon-1||1))) : 0;

  let html = '';

  if (metric === 'FTE') {
    const baselineFTE = DEMO.totalFTE;
    const totalTargetReduction = window._projFTEReduction;
    const cumReduction = Math.round(totalTargetReduction * rampFactor);
    const prevCumReduction = Math.round(totalTargetReduction * prevRampFactor);
    const yrReduction = cumReduction - prevCumReduction;
    const adoptionPct = rampFactor;

    html = `
      <div style="font-size:13px;">
        <p style="margin-bottom:12px; color:var(--ey-text-light);">FTE reduction follows S-curve adoption across all accepted initiatives.</p>
        <table class="data-table">
          <tbody>
            <tr><td>Baseline FTE</td><td style="text-align:right; font-weight:700;">${fmt(baselineFTE, 'int')}</td></tr>
            <tr><td>Total Target Reduction (at full adoption)</td><td style="text-align:right; font-weight:700;">${fmt(totalTargetReduction, 'int')}</td></tr>
            <tr><td>S-Curve Adoption at Year ${year}</td><td style="text-align:right; font-weight:700;">${(adoptionPct * 100).toFixed(1)}%</td></tr>
            <tr style="border-top:2px solid var(--ey-mid-gray);">
              <td>Cumulative Reduction (target √ó adoption)</td>
              <td style="text-align:right; font-weight:700;">${fmt(totalTargetReduction, 'int')} √ó ${(adoptionPct * 100).toFixed(1)}% = <strong>${fmt(cumReduction, 'int')}</strong></td>
            </tr>
            ${year > 1 ? `<tr><td>Already Reduced by Year ${year-1}</td><td style="text-align:right;">‚àí${fmt(prevCumReduction, 'int')}</td></tr>` : ''}
            <tr style="background:var(--ey-green-bg);">
              <td><strong>Year ${year} Incremental Reduction</strong></td>
              <td style="text-align:right; font-weight:700; color:var(--ey-green);">‚ñº ${fmt(yrReduction, 'int')} FTE</td>
            </tr>
            <tr style="background:var(--ey-light-gray);">
              <td><strong>Resulting FTE (Year ${year})</strong></td>
              <td style="text-align:right; font-weight:700;">${fmt(baselineFTE, 'int')} ‚àí ${fmt(cumReduction, 'int')} = <strong>${fmt(baselineFTE - cumReduction, 'int')}</strong></td>
            </tr>
          </tbody>
        </table>
        <p style="margin-top:12px; font-size:11px; color:var(--ey-text-light);">
          <strong>Adoption curve:</strong> Uses logistic S-curve ‚Äî slow in Year 1 as initiatives ramp, accelerating in Year 2, plateauing by Year ${horizon}.<br>
          <strong>Composition:</strong> AI & Automation ~55% of reduction, Operating Model ~30%, Location Strategy ~15%.<br>
          <strong>Override:</strong> Adjust initiative timing and adoption on Page 15 (Overrides) to change this projection.
        </p>
      </div>`;
  } else if (metric === 'Cost') {
    const baseCost = d.cost[0];
    const currCost = d.cost[year];
    const prevCost = d.cost[year - 1];
    const yrDelta = currCost - prevCost;
    const wageInflation = DEMO.params.wageInflation;
    const inflationCost = prevCost * wageInflation;
    const fteReductionSaving = Math.abs(yrDelta) + inflationCost;

    html = `
      <div style="font-size:13px;">
        <p style="margin-bottom:12px; color:var(--ey-text-light);">Annual cost is driven by FTE reductions offset by wage inflation.</p>
        <table class="data-table">
          <tbody>
            <tr><td>Year ${year > 1 ? year-1 : 'Baseline'} Annual Cost</td><td style="text-align:right; font-weight:700;">${fmt(prevCost, '$m')}</td></tr>
            <tr><td>Wage Inflation (${(wageInflation*100).toFixed(0)}% p.a.)</td><td style="text-align:right; color:var(--ey-red);">+${fmt(inflationCost, '$k')}</td></tr>
            <tr><td>FTE Reduction Savings</td><td style="text-align:right; color:var(--ey-green);">‚àí${fmt(fteReductionSaving, '$k')}</td></tr>
            <tr style="border-top:2px solid var(--ey-mid-gray); background:var(--ey-light-gray);">
              <td><strong>Year ${year} Annual Cost</strong></td>
              <td style="text-align:right; font-weight:700;">${fmt(currCost, '$m')}</td>
            </tr>
            <tr style="background:var(--ey-green-bg);">
              <td><strong>Net Change vs Prior Year</strong></td>
              <td style="text-align:right; font-weight:700; color:var(--ey-green);">‚ñº ${fmt(Math.abs(yrDelta), '$k')}</td>
            </tr>
          </tbody>
        </table>
        <p style="margin-top:12px; font-size:11px; color:var(--ey-text-light);">
          <strong>Formula:</strong> Future Cost = future_fte √ó blended_cost √ó (1 + wage_inflation)^year √ó 12<br>
          <strong>Key driver:</strong> Each FTE removed saves avg ${fmt(58000, '$')}/yr. Inflation of ${(wageInflation*100).toFixed(0)}% partially offsets.
        </p>
      </div>`;
  } else if (metric === 'Saving') {
    const currSaving = d.saving[year];
    const prevSaving = d.saving[year - 1];
    const incremental = currSaving - prevSaving;

    html = `
      <div style="font-size:13px;">
        <p style="margin-bottom:12px; color:var(--ey-text-light);">Net savings = labour savings ‚àí technology costs ‚àí redeployment costs.</p>
        <table class="data-table">
          <tbody>
            <tr><td>Year ${year} Gross Labour Saving</td><td style="text-align:right; font-weight:700;">${fmt(currSaving * 1.15, '$m')}</td></tr>
            <tr><td>Technology Investment</td><td style="text-align:right; color:var(--ey-red);">‚àí${fmt(currSaving * 0.08, '$k')}</td></tr>
            <tr><td>Redeployment & Reskilling (${(DEMO.params.redeploymentPct * 100).toFixed(0)}%)</td><td style="text-align:right; color:var(--ey-red);">‚àí${fmt(currSaving * 0.07, '$k')}</td></tr>
            <tr style="background:var(--ey-green-bg);">
              <td><strong>Year ${year} Net Saving</strong></td>
              <td style="text-align:right; font-weight:700; color:var(--ey-green);">${fmt(currSaving, '$m')}</td>
            </tr>
            <tr><td>Prior Year Net Saving</td><td style="text-align:right;">${fmt(prevSaving, '$m')}</td></tr>
            <tr style="background:var(--ey-light-gray);">
              <td><strong>Incremental vs Prior Year</strong></td>
              <td style="text-align:right; font-weight:700; color:var(--ey-green);">+${fmt(incremental, '$k')}</td>
            </tr>
          </tbody>
        </table>
        <p style="margin-top:12px; font-size:11px; color:var(--ey-text-light);">
          <strong>Incremental saving</strong> reflects new initiatives reaching maturity + existing initiatives deepening adoption.<br>
          <strong>Attrition factor:</strong> Savings are only realisable as natural attrition creates vacancies ‚Äî attrition rate: ${(DEMO.params.attritionMonthly * 100).toFixed(0)}%/month.
        </p>
      </div>`;
  } else { // Cumulative
    let cumul = 0;
    let rows = '';
    for (let y = 1; y <= year; y++) {
      cumul += d.saving[y];
      rows += `<tr${y === year ? ' style="background:var(--ey-green-bg); font-weight:700;"' : ''}>
        <td>Year ${y}</td>
        <td style="text-align:right;">${fmt(d.saving[y], '$m')}</td>
        <td style="text-align:right; font-weight:700;">${fmt(cumul, '$m')}</td>
      </tr>`;
    }
    html = `
      <div style="font-size:13px;">
        <table class="data-table">
          <thead><tr><th>Year</th><th>Annual Saving</th><th>Cumulative</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
        <p style="margin-top:12px; font-size:11px; color:var(--ey-text-light);">
          <strong>NPV adjustment:</strong> Discount rate of ${(DEMO.params.discountRate * 100).toFixed(0)}% applies for NPV calculation (see Page 14: Impact Dashboard).
        </p>
      </div>`;
  }

  openModal(`Year ${year} ${metric} ‚Äî Calculation Breakdown`, html);
}

function drawHealthGauge(score, color) {
  const canvas = document.getElementById('healthGauge');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const cx = 100, cy = 110, r = 80;
  const startAngle = Math.PI * 0.8;
  const endAngle = Math.PI * 2.2;
  const scoreAngle = startAngle + (score / 100) * (endAngle - startAngle);

  ctx.clearRect(0, 0, 200, 200);

  // Background arc
  ctx.beginPath();
  ctx.arc(cx, cy, r, startAngle, endAngle);
  ctx.strokeStyle = '#E0E0E6';
  ctx.lineWidth = 14;
  ctx.lineCap = 'round';
  ctx.stroke();

  // Score arc
  ctx.beginPath();
  ctx.arc(cx, cy, r, startAngle, scoreAngle);
  ctx.strokeStyle = color;
  ctx.lineWidth = 14;
  ctx.lineCap = 'round';
  ctx.stroke();
}

// Drill-down for queue
function drillDown(bu, intent, channel) {
  const q = DEMO.queues.find(q => q.bu === bu && q.intent === intent && q.channel === channel);
  if (!q) return;

  const health = getQueueHealth(q) * 100;
  const rag = ragColor(health / 100);

  const metrics = ['CSAT', 'FCR', 'AHT', 'CPC', 'Repeat', 'Escalation', 'CES'];
  const values = [q.csat, q.fcr, q.aht, q.cpc, q.repeat, q.escalation, q.ces];
  const fmts = ['dec', '%', 'min', '$', '%', '%', 'dec'];
  const dirs = ['higher', 'higher', 'lower', 'lower', 'lower', 'lower', 'lower'];

  let rows = metrics.map((m, i) => {
    const bm = getChannelBenchmark(channel, m);
    const score = metricScoreNorm(values[i], bm, dirs[i]);
    const r = ragColor(score);
    return `<tr>
      <td><strong>${m}</strong></td>
      <td>${fmt(values[i], fmts[i])}</td>
      <td>${fmt(bm, fmts[i])}</td>
      <td><span class="badge badge-${r === 'green' ? 'low' : r === 'amber' ? 'medium' : 'critical'}">${(score * 100).toFixed(0)}%</span></td>
    </tr>`;
  }).join('');

  openModal(`${intent} √ó ${channel} ‚Äî ${bu}`, `
    <div style="text-align:center; margin-bottom:16px;">
      <span class="badge rag-${rag}" style="font-size:14px; padding:6px 20px;">Health: ${health.toFixed(0)} / 100</span>
      <div style="margin-top:6px; font-size:12px; color:var(--ey-text-light);">Volume: ${fmt(q.volume, 'int')} contacts/mo ‚Äî Cost: ${fmt(q.volume * q.cpc, '$')}/mo</div>
    </div>
    <table class="data-table">
      <thead><tr><th>Metric</th><th>Actual</th><th>Benchmark</th><th>Score (/100)</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `);
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 1: PAGE 2 ‚Äî BENCHMARKING
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage2() {
  const bm = DEMO.benchmarks;
  const metrics = ['CSAT', 'FCR', 'AHT', 'CPC', 'Repeat', 'Escalation', 'CES'];
  const dirs = { CSAT: 'higher', FCR: 'higher', AHT: 'lower', CPC: 'lower', Repeat: 'lower', Escalation: 'lower', CES: 'lower' };
  const fmtMap = { CSAT: 'dec', FCR: '%', AHT: 'min', CPC: '$', Repeat: '%', Escalation: '%', CES: 'dec' };

  // Calculate aggregates
  const totalVol = DEMO.totalVolume;
  const agg = {};
  for (const m of metrics) {
    const key = m.toLowerCase();
    let wsum = 0;
    for (const q of DEMO.queues) {
      const val = m === 'CPC' ? q.cpc : m === 'CSAT' ? q.csat : m === 'FCR' ? q.fcr :
                  m === 'AHT' ? q.aht : m === 'Repeat' ? q.repeat : m === 'Escalation' ? q.escalation : q.ces;
      wsum += val * q.volume;
    }
    agg[m] = wsum / totalVol;
  }

  // Build comparison table
  let tableRows = metrics.map(m => {
    const actual = agg[m];
    const benchmark = (bm[m]||{}).global;
    const tq = benchmark * (dirs[m] === 'higher' ? 1.15 : 0.85); // top quartile estimate
    const gap = dirs[m] === 'higher' ? actual - benchmark : benchmark - actual;
    const gapPct = gap / benchmark * 100;
    const color = gapPct >= 0 ? 'var(--ey-green)' : gapPct >= -15 ? 'var(--ey-amber)' : 'var(--ey-red)';

    return `<tr>
      <td><strong>${m}</strong></td>
      <td>${fmt(actual, fmtMap[m])}</td>
      <td>${fmt(benchmark, fmtMap[m])}</td>
      <td>${fmt(tq, fmtMap[m])}</td>
      <td style="color:${color}; font-weight:700;">${gapPct >= 0 ? '+' : ''}${gapPct.toFixed(1)}%</td>
      <td><span class="badge badge-${gapPct >= 0 ? 'low' : gapPct >= -15 ? 'medium' : 'critical'}">${gapPct >= 0 ? 'Above' : gapPct >= -15 ? 'Near' : 'Below'}</span></td>
    </tr>`;
  }).join('');

  // Channel-level benchmarking
  const channelMetrics = {};
  for (const ch of DEMO.channels) {
    const chQueues = DEMO.queues.filter(q => q.channel === ch);
    if (chQueues.length === 0) continue;
    const chVol = chQueues.reduce((s, q) => s + q.volume, 0);
    channelMetrics[ch] = {
      csat: chQueues.reduce((s, q) => s + q.csat * q.volume, 0) / chVol,
      fcr: chQueues.reduce((s, q) => s + q.fcr * q.volume, 0) / chVol,
      aht: chQueues.reduce((s, q) => s + q.aht * q.volume, 0) / chVol,
      volume: chVol
    };
  }

  const el = document.getElementById('page-2');
  el.innerHTML = `
    <div class="grid-2" style="margin-bottom:16px;">
      <div class="card">
        <div class="card-title">üìä Benchmark Comparison ‚Äî Global Metrics</div>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Metric</th><th>Your Value</th><th>Industry Avg</th><th>Top Quartile</th><th>Gap %</th><th>Status</th></tr></thead>
            <tbody>${tableRows}</tbody>
          </table>
        </div>
        <div style="margin-top:12px; font-size:11px; color:var(--ey-text-light);">Source: System Default ‚Äî Industry Benchmarks (from config)</div>
      </div>
      <div class="card">
        <div class="card-title">üï∏Ô∏è Performance Radar ‚Äî You vs Industry</div>
        <div class="radar-container">
          <canvas id="radarChart" width="380" height="380"></canvas>
        </div>
        <div style="display:flex; gap:16px; justify-content:center; margin-top:12px; font-size:12px;">
          <span>üîµ Your Performance</span>
          <span style="color:var(--ey-text-light);">‚ö´ Industry Average</span>
          <span style="color:var(--ey-green);">üü¢ Top Quartile</span>
        </div>
      </div>
    </div>

    <!-- Channel-Level Benchmarking -->
    <div class="card">
      <div class="card-title">üì° Channel-Level Performance vs Industry</div>
      <div class="table-wrap">
        <table class="data-table">
          <thead><tr><th>Channel</th><th>Volume (/mo)</th><th>CSAT (/5) (You / BM)</th><th>FCR (You / BM)</th><th>AHT (min) (You / BM)</th></tr></thead>
          <tbody>
            ${Object.entries(channelMetrics).map(([ch, d]) => {
              const csatBM = getChannelBenchmark(ch, 'CSAT') || 3.9;
              const fcrBM = getChannelBenchmark(ch, 'FCR') || 0.76;
              const ahtBM = getChannelBenchmark(ch, 'AHT') || 6.5;
              const csatC = d.csat >= csatBM ? 'var(--ey-green)' : 'var(--ey-red)';
              const fcrC = d.fcr >= fcrBM ? 'var(--ey-green)' : 'var(--ey-red)';
              const ahtC = d.aht <= ahtBM ? 'var(--ey-green)' : 'var(--ey-red)';
              return `<tr>
                <td><strong>${ch}</strong></td>
                <td>${fmt(d.volume, 'int')}</td>
                <td><span style="color:${csatC}; font-weight:700;">${d.csat.toFixed(2)}</span> / ${csatBM.toFixed(2)} <span style="font-size:9px;color:var(--ey-text-light);">/5</span></td>
                <td><span style="color:${fcrC}; font-weight:700;">${fmt(d.fcr, '%')}</span> / ${fmt(fcrBM, '%')}</td>
                <td><span style="color:${ahtC}; font-weight:700;">${fmt(d.aht, 'min')}</span> / ${fmt(ahtBM, 'min')}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Performance Gap Summary -->
    <div class="card">
      <div class="card-title">üìâ Performance Gap Summary</div>
      <div id="gapSummaryBars"></div>
    </div>
  `;

  // Draw radar chart
  drawRadarChart(agg, bm, metrics, dirs);

  // Draw gap bars
  drawGapBars(agg, bm, metrics, dirs, fmtMap);
}

function drawRadarChart(agg, bm, metrics, dirs) {
  const canvas = document.getElementById('radarChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const cx = 190, cy = 190, r = 150;
  const n = metrics.length;

  ctx.clearRect(0, 0, 380, 380);

  // Normalize values (0-1 scale based on how they compare to top quartile)
  function normalize(m) {
    const actual = agg[m];
    const benchmark = (bm[m]||{}).global;
    const tq = benchmark * (dirs[m] === 'higher' ? 1.15 : 0.85);
    if (dirs[m] === 'higher') return Math.min(1, actual / (tq * 1.1));
    return Math.min(1, (tq * 0.9) / actual);
  }

  function normBM(m) {
    const benchmark = (bm[m]||{}).global;
    const tq = benchmark * (dirs[m] === 'higher' ? 1.15 : 0.85);
    if (dirs[m] === 'higher') return Math.min(1, benchmark / (tq * 1.1));
    return Math.min(1, (tq * 0.9) / benchmark);
  }

  function getPoint(i, value) {
    const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
    return { x: cx + r * value * Math.cos(angle), y: cy + r * value * Math.sin(angle) };
  }

  // Grid
  for (let ring = 0.25; ring <= 1; ring += 0.25) {
    ctx.beginPath();
    for (let i = 0; i <= n; i++) {
      const p = getPoint(i % n, ring);
      i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y);
    }
    ctx.strokeStyle = '#E0E0E6';
    ctx.lineWidth = 1;
    ctx.stroke();
  }

  // Axes + labels
  for (let i = 0; i < n; i++) {
    const p = getPoint(i, 1.15);
    const p0 = getPoint(i, 0);
    const p1 = getPoint(i, 1);
    ctx.beginPath();
    ctx.moveTo(p0.x, p0.y);
    ctx.lineTo(p1.x, p1.y);
    ctx.strokeStyle = '#E0E0E6';
    ctx.stroke();
    ctx.fillStyle = '#2E2E38';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(metrics[i], p.x, p.y);
  }

  // Benchmark polygon
  ctx.beginPath();
  for (let i = 0; i <= n; i++) {
    const p = getPoint(i % n, normBM(metrics[i % n]));
    i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y);
  }
  ctx.strokeStyle = '#747480';
  ctx.lineWidth = 2;
  ctx.setLineDash([4, 4]);
  ctx.stroke();
  ctx.setLineDash([]);

  // Your polygon
  ctx.beginPath();
  for (let i = 0; i <= n; i++) {
    const p = getPoint(i % n, normalize(metrics[i % n]));
    i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y);
  }
  ctx.fillStyle = 'rgba(26,115,232,0.15)';
  ctx.fill();
  ctx.strokeStyle = '#1A73E8';
  ctx.lineWidth = 2.5;
  ctx.stroke();

  // Dots
  for (let i = 0; i < n; i++) {
    const p = getPoint(i, normalize(metrics[i]));
    ctx.beginPath();
    ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
    ctx.fillStyle = '#1A73E8';
    ctx.fill();
  }

  // CR-004: Draw legend
  const lx = 10, ly = 360;
  ctx.font = '10px sans-serif';
  ctx.setLineDash([]);
  ctx.fillStyle = '#1A73E8'; ctx.fillRect(lx, ly, 14, 3);
  ctx.fillStyle = '#2E2E38'; ctx.fillText('Your Performance', lx + 18, ly + 4);
  ctx.setLineDash([4,4]); ctx.strokeStyle = '#747480'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(lx + 140, ly + 1); ctx.lineTo(lx + 154, ly + 1); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#2E2E38'; ctx.fillText('Industry Avg', lx + 158, ly + 4);
}

function drawGapBars(agg, bm, metrics, dirs, fmtMap) {
  const container = document.getElementById('gapSummaryBars');
  if (!container) return;

  const gaps = metrics.map(m => {
    const actual = agg[m];
    const benchmark = (bm[m]||{}).global;
    const gap = dirs[m] === 'higher' ? (actual - benchmark) / benchmark * 100 : (benchmark - actual) / benchmark * 100;
    return { metric: m, gap, actual, benchmark };
  }).sort((a, b) => a.gap - b.gap);

  let html = '<div class="bar-chart">';
  for (const g of gaps) {
    const color = g.gap >= 0 ? 'var(--ey-green)' : g.gap >= -15 ? 'var(--ey-amber)' : 'var(--ey-red)';
    const width = Math.min(100, Math.abs(g.gap) * 2);
    const dir = g.gap >= 0 ? 'Above' : 'Below';
    html += `
      <div class="bar-row">
        <div class="bar-label">${g.metric}</div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${width}%; background:${color};">${g.gap >= 0 ? '+' : ''}${g.gap.toFixed(1)}%</div>
        </div>
        <div class="bar-value" style="color:${color}">${dir} avg</div>
      </div>`;
  }
  html += '</div>';
  container.innerHTML = html;
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 1: PAGE 3 ‚Äî MATURITY ASSESSMENT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage3() {
  // Auto-derive maturity scores
  const uniqueChannels = [...new Set(DEMO.queues.map(q => q.channel))];
  const hasSSChannels = DEMO.queues.some(q => ['App/Self-Service', 'IVR'].includes(q.channel));
  const digitalVol = DEMO.queues.filter(q => !['Voice', 'Retail/Walk-in'].includes(q.channel)).reduce((s,q) => s+q.volume, 0);
  const digitalPct = digitalVol / DEMO.totalVolume;

  // Channel maturity
  let channelScore;
  if (uniqueChannels.length <= 2 && !hasSSChannels) channelScore = 1;
  else if (uniqueChannels.length <= 4 && digitalPct < 0.3) channelScore = 2;
  else if (digitalPct >= 0.3 && hasSSChannels) channelScore = 3;
  else if (digitalPct >= 0.5) channelScore = 4;
  else channelScore = 2;

  // Automation maturity
  const hasIVR = DEMO.queues.some(q => q.channel === 'IVR');
  const ssVol = DEMO.queues.filter(q => ['App/Self-Service', 'IVR'].includes(q.channel)).reduce((s,q) => s+q.volume, 0);
  const ssPct = ssVol / DEMO.totalVolume;
  let autoScore;
  if (ssPct === 0) autoScore = 1;
  else if (hasIVR && ssPct < 0.15) autoScore = 2;
  else if (ssPct >= 0.15 && ssPct < 0.30) autoScore = 3;
  else autoScore = 3; // Would need AI indicators for 4

  // Workforce maturity
  const sharedPct = 0.35; // Demo estimate
  const avgShrinkage = 0.30;
  let wfScore;
  if (sharedPct < 0.2 && avgShrinkage > 0.35) wfScore = 1;
  else if (sharedPct < 0.5) wfScore = 2;
  else if (sharedPct >= 0.5 && avgShrinkage < 0.30) wfScore = 3;
  else wfScore = 2;

  // Analytics maturity (proxy: data completeness)
  let analyticsScore = 2; // Has basic fields, some optional

  // CX maturity
  let cxScore;
  if (DEMO.avgCSAT < 3.0) cxScore = 1;
  else if (DEMO.avgCSAT < 3.7) cxScore = 2;
  else if (DEMO.avgCSAT < 4.2) cxScore = 3;
  else cxScore = 4;

  const dimensions = [
    { name: 'Channel Strategy', score: channelScore, max: 4, autoScore: channelScore },
    { name: 'Automation & AI', score: autoScore, max: 4, autoScore: autoScore },
    { name: 'Workforce Model', score: wfScore, max: 4, autoScore: wfScore },
    { name: 'Analytics', score: analyticsScore, max: 4, autoScore: analyticsScore },
    { name: 'Customer Experience', score: cxScore, max: 4, autoScore: cxScore },
  ];

  // Apply any stored overrides
  if (window._maturityOverrides) {
    for (const dim of dimensions) {
      if (window._maturityOverrides[dim.name] !== undefined) {
        dim.score = window._maturityOverrides[dim.name];
        dim.overridden = true;
      }
    }
  }

  const overall = dimensions.reduce((s, d) => s + d.score, 0) / dimensions.length;
  const labels = { 1: 'Reactive', 2: 'Managed', 3: 'Optimised', 4: 'Predictive' };
  const overallLabel = labels[Math.round(overall)] || 'Managed';

  const levelDescriptions = {
    'Channel Strategy': ['Single/dual channel, no digital', '3‚Äì4 channels, some digital', 'Omnichannel with self-service', 'AI-orchestrated channel selection'],
    'Automation & AI': ['No automation, fully manual', 'Basic IVR, simple routing', 'Chatbots, agent assist, RPA', 'Predictive intent, autonomous agents'],
    'Workforce Model': ['Fixed teams, single-skilled', 'Some cross-skilling, basic WFM', 'Flexible skills, optimised WFM', 'AI-driven scheduling, gig model'],
    'Analytics': ['Ad-hoc reporting, no benchmarks', 'Regular dashboards, some KPIs', 'Real-time analytics, root cause', 'Predictive analytics, prescriptive'],
    'Customer Experience': ['Reactive service, no proactive', 'Some proactive (confirmations)', 'Proactive outreach, personalized', 'Anticipatory, zero-effort CX'],
  };

  const el = document.getElementById('page-3');
  el.innerHTML = `
    <div class="grid-2" style="margin-bottom:16px;">
      <div class="card" style="text-align:center;">
        <div class="card-title" style="justify-content:center;">üèõÔ∏è Overall Maturity Level</div>
        <div style="font-size:52px; font-weight:800; color:${overall >= 3 ? 'var(--ey-green)' : overall >= 2 ? 'var(--ey-amber)' : 'var(--ey-red)'};">
          ${overall.toFixed(1)}<span style="font-size:24px; color:var(--ey-text-light);">/4.0</span>
        </div>
        <div style="font-size:18px; font-weight:700; margin-top:4px;">${overallLabel}</div>
        <div style="font-size:13px; color:var(--ey-text-light); margin-top:8px; max-width:400px; margin-left:auto; margin-right:auto;">
          Your contact centre operates at a <strong>${overallLabel}</strong> maturity level.
          ${overall < 3 ? 'Key gaps exist in automation and workforce flexibility ‚Äî prioritise AI & operating model initiatives.' : 'Strong foundation ‚Äî focus on advanced analytics and predictive capabilities.'}
        </div>
        ${dimensions.some(d => d.overridden) ? '<div style="margin-top:8px;"><span class="override-badge">‚ö° ' + dimensions.filter(d => d.overridden).length + ' dimension(s) overridden</span></div>' : ''}
      </div>
      <div class="card">
        <div class="card-title" style="justify-content:center;">‚¨† Maturity Pentagon</div>
        <div class="maturity-pentagon">
          <canvas id="maturityPentagon" width="400" height="400"></canvas>
        </div>
      </div>
    </div>

    <!-- Dimension Detail Cards ‚Äî Clickable -->
    <div class="card">
      <div class="card-title">üìã Dimension Breakdown <span style="font-size:11px; font-weight:400; color:var(--ey-text-light); margin-left:8px;">Click any row to see derivation logic and override score</span></div>
      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr><th>Dimension</th><th>Score</th><th>Level</th><th>Current State</th><th>Next Level Target</th><th></th></tr>
          </thead>
          <tbody>
            ${dimensions.map((d, idx) => {
              const lvl = labels[d.score];
              const desc = levelDescriptions[d.name][d.score - 1];
              const nextDesc = d.score < 4 ? levelDescriptions[d.name][d.score] : '‚Äî';
              const color = d.score >= 3 ? 'var(--ey-green)' : d.score >= 2 ? 'var(--ey-amber)' : 'var(--ey-red)';
              return `<tr style="cursor:pointer;" onclick="showMaturityDrillDown(${idx})">
                <td><strong>${d.name}</strong>${d.overridden ? ' <span class="override-badge">‚ö° Override</span>' : ''}</td>
                <td>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <div style="width:100px; height:8px; background:var(--ey-mid-gray); border-radius:4px; overflow:hidden;">
                      <div style="width:${(d.score/4)*100}%; height:100%; background:${color}; border-radius:4px;"></div>
                    </div>
                    <strong style="color:${color}">${d.score}/4</strong>
                  </div>
                </td>
                <td><span class="badge badge-${d.score >= 3 ? 'low' : d.score >= 2 ? 'medium' : 'critical'}">${lvl}</span></td>
                <td style="font-size:12px;">${desc}</td>
                <td style="font-size:12px; color:var(--ey-text-light);">${nextDesc}</td>
                <td style="font-size:16px; color:var(--ey-text-light);">‚Ä∫</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Recommendations Link -->
    <div class="card" style="background:var(--ey-blue-bg); border:1px solid #90CAF9;">
      <div class="card-title" style="color:var(--ey-blue);">üí° Maturity Improvement Path</div>
      <p style="font-size:13px; margin-bottom:12px;">To advance from <strong>${overallLabel}</strong> to <strong>${labels[Math.min(4, Math.round(overall) + 1)]}</strong>, prioritise these areas:</p>
      <div style="display:flex; flex-wrap:wrap; gap:8px;">
        ${dimensions.filter(d => d.score < 3).sort((a,b) => a.score - b.score).map(d =>
          `<span class="btn btn-sm btn-outline" style="font-size:12px; cursor:pointer;" onclick="navigateTo(9)">${d.name} ‚Üí ${labels[d.score + 1]}</span>`
        ).join('')}
      </div>
      <p style="font-size:12px; color:var(--ey-text-light); margin-top:10px;">See <strong>Page 9: Initiative Roadmap</strong> for specific recommendations ‚Üí</p>
    </div>
  `;

  // Store globally for drill-down access
  window._maturityDimensions = dimensions;
  window._maturityLabels = labels;
  window._maturityLevelDesc = levelDescriptions;
  window._maturityDerivation = {
    uniqueChannels: uniqueChannels.length,
    hasSSChannels,
    digitalPct,
    hasIVR,
    ssPct,
    sharedPct,
    avgShrinkage,
    avgCSAT: DEMO.avgCSAT
  };

  // Draw pentagon
  drawMaturityPentagon(dimensions);
}

function drawMaturityPentagon(dimensions) {
  const canvas = document.getElementById('maturityPentagon');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const cx = 200, cy = 200, r = 150;
  const n = dimensions.length;

  ctx.clearRect(0, 0, 400, 400);

  function getPoint(i, value) {
    const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
    return { x: cx + r * (value / 4) * Math.cos(angle), y: cy + r * (value / 4) * Math.sin(angle) };
  }

  // Grid rings
  for (let ring = 1; ring <= 4; ring++) {
    ctx.beginPath();
    for (let i = 0; i <= n; i++) {
      const p = getPoint(i % n, ring);
      i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y);
    }
    ctx.strokeStyle = '#E0E0E6';
    ctx.lineWidth = 1;
    ctx.stroke();

    // Ring label
    const lp = getPoint(0, ring);
    ctx.fillStyle = '#C8C8D0';
    ctx.font = '10px sans-serif';
    ctx.fillText(ring.toString(), lp.x + 5, lp.y - 5);
  }

  // Axes + labels
  for (let i = 0; i < n; i++) {
    const p0 = getPoint(i, 0);
    const p1 = getPoint(i, 4);
    ctx.beginPath();
    ctx.moveTo(p0.x, p0.y);
    ctx.lineTo(p1.x, p1.y);
    ctx.strokeStyle = '#E0E0E6';
    ctx.stroke();

    const lp = getPoint(i, 4.5);
    ctx.fillStyle = '#2E2E38';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    // Wrap long labels
    const parts = dimensions[i].name.split(' ');
    if (parts.length > 1) {
      ctx.fillText(parts[0], lp.x, lp.y - 7);
      ctx.fillText(parts.slice(1).join(' '), lp.x, lp.y + 7);
    } else {
      ctx.fillText(dimensions[i].name, lp.x, lp.y);
    }
  }

  // Score polygon
  ctx.beginPath();
  for (let i = 0; i <= n; i++) {
    const p = getPoint(i % n, dimensions[i % n].score);
    i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y);
  }
  ctx.fillStyle = 'rgba(255,230,0,0.12)';
  ctx.fill();
  ctx.strokeStyle = '#FFE600';
  ctx.lineWidth = 2.5;
  ctx.stroke();

  // Score dots + values
  for (let i = 0; i < n; i++) {
    const p = getPoint(i, dimensions[i].score);
    ctx.beginPath();
    ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
    ctx.fillStyle = dimensions[i].score >= 3.5 ? '#168736' : dimensions[i].score >= 2.5 ? '#D97706' : '#C5003E';
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.fillStyle = '#2E2E38';
    ctx.font = 'bold 12px sans-serif';
    ctx.fillText(dimensions[i].score.toString(), p.x + 12, p.y - 8);
  }
}

// ‚îÄ‚îÄ‚îÄ Maturity Dimension Drill-Down ‚îÄ‚îÄ‚îÄ
function showMaturityDrillDown(dimIndex) {
  const dim = window._maturityDimensions[dimIndex];
  const labels = window._maturityLabels;
  const deriv = window._maturityDerivation;
  const levelDesc = window._maturityLevelDesc;

  // Build derivation explanation specific to each dimension
  const derivations = {
    'Channel Strategy': {
      inputs: [
        { label: 'Unique channels in data', value: deriv.uniqueChannels, detail: DEMO.channels.filter(ch => DEMO.queues.some(q => q.channel === ch)).join(', ') },
        { label: 'Has self-service channels (App/IVR)', value: deriv.hasSSChannels ? 'Yes' : 'No' },
        { label: 'Digital volume %', value: (deriv.digitalPct * 100).toFixed(1) + '%', detail: 'All non-Voice, non-Walk-in volume / total volume' },
      ],
      rules: [
        { condition: '‚â§2 channels AND no self-service', result: '1 ‚Äî Reactive', active: deriv.uniqueChannels <= 2 && !deriv.hasSSChannels },
        { condition: '‚â§4 channels AND digital < 30%', result: '2 ‚Äî Managed', active: deriv.uniqueChannels <= 4 && deriv.digitalPct < 0.3 },
        { condition: 'Digital ‚â• 30% AND has self-service', result: '3 ‚Äî Optimised', active: deriv.digitalPct >= 0.3 && deriv.hasSSChannels },
        { condition: 'Digital ‚â• 50%', result: '4 ‚Äî Predictive', active: deriv.digitalPct >= 0.5 },
      ]
    },
    'Automation & AI': {
      inputs: [
        { label: 'IVR channel exists', value: deriv.hasIVR ? 'Yes' : 'No' },
        { label: 'Self-service volume %', value: (deriv.ssPct * 100).toFixed(1) + '%', detail: 'IVR + App/Self-Service volume / total volume' },
      ],
      rules: [
        { condition: 'No self-service volume (0%)', result: '1 ‚Äî Reactive', active: deriv.ssPct === 0 },
        { condition: 'IVR exists AND self-service < 15%', result: '2 ‚Äî Managed', active: deriv.hasIVR && deriv.ssPct < 0.15 },
        { condition: 'Self-service ‚â• 15% AND < 30%', result: '3 ‚Äî Optimised', active: deriv.ssPct >= 0.15 && deriv.ssPct < 0.30 },
        { condition: 'Self-service ‚â• 30% + low AHT (AI assist)', result: '4 ‚Äî Predictive', active: deriv.ssPct >= 0.30 },
      ]
    },
    'Workforce Model': {
      inputs: [
        { label: 'Shared resource %', value: (deriv.sharedPct * 100).toFixed(0) + '%', detail: 'Agents handling multiple channels simultaneously' },
        { label: 'Average shrinkage', value: (deriv.avgShrinkage * 100).toFixed(0) + '%', detail: 'Absence / unavailability rate' },
      ],
      rules: [
        { condition: 'Shared < 20% AND shrinkage > 35%', result: '1 ‚Äî Reactive', active: deriv.sharedPct < 0.2 && deriv.avgShrinkage > 0.35 },
        { condition: 'Shared < 50%', result: '2 ‚Äî Managed', active: deriv.sharedPct < 0.5 },
        { condition: 'Shared ‚â• 50% AND shrinkage < 30%', result: '3 ‚Äî Optimised', active: deriv.sharedPct >= 0.5 && deriv.avgShrinkage < 0.30 },
        { condition: 'Shared ‚â• 70% AND shrinkage < 25%', result: '4 ‚Äî Predictive', active: deriv.sharedPct >= 0.7 && deriv.avgShrinkage < 0.25 },
      ]
    },
    'Analytics': {
      inputs: [
        { label: 'Data completeness', value: 'Standard fields + some optional', detail: 'Based on columns present in uploaded performance data' },
        { label: 'Benchmarks file provided', value: 'System defaults', detail: 'Using configured benchmarks' },
      ],
      rules: [
        { condition: 'Only required fields present', result: '1 ‚Äî Reactive', active: false },
        { condition: 'Required + some optional fields', result: '2 ‚Äî Managed', active: true },
        { condition: '+ Custom benchmarks file uploaded', result: '3 ‚Äî Optimised', active: false },
        { condition: 'All fields + custom benchmarks + CES', result: '4 ‚Äî Predictive', active: false },
      ]
    },
    'Customer Experience': {
      inputs: [
        { label: 'Volume-weighted avg CSAT', value: deriv.avgCSAT.toFixed(2) + ' /5', detail: 'Œ£(queue CSAT √ó volume) / total volume' },
      ],
      rules: [
        { condition: 'CSAT < 3.0', result: '1 ‚Äî Reactive', active: deriv.avgCSAT < 3.0 },
        { condition: 'CSAT 3.0 ‚Äì 3.7', result: '2 ‚Äî Managed', active: deriv.avgCSAT >= 3.0 && deriv.avgCSAT < 3.7 },
        { condition: 'CSAT 3.7 ‚Äì 4.2', result: '3 ‚Äî Optimised', active: deriv.avgCSAT >= 3.7 && deriv.avgCSAT < 4.2 },
        { condition: 'CSAT > 4.2', result: '4 ‚Äî Predictive', active: deriv.avgCSAT >= 4.2 },
      ]
    }
  };

  const d = derivations[dim.name];
  const color = dim.score >= 3 ? 'var(--ey-green)' : dim.score >= 2 ? 'var(--ey-amber)' : 'var(--ey-red)';

  let html = `
    <div style="font-size:13px;">
      <!-- Current score banner -->
      <div style="text-align:center; margin-bottom:16px; padding:12px; border-radius:8px; background:${dim.score >= 3 ? 'var(--ey-green-bg)' : dim.score >= 2 ? 'var(--ey-amber-bg)' : 'var(--ey-red-bg)'};">
        <div style="font-size:28px; font-weight:800; color:${color};">${dim.score}/4</div>
        <div style="font-weight:700;">${labels[dim.score]}</div>
      </div>

      <!-- Input Data Used -->
      <div style="font-weight:700; margin-bottom:8px;">üì• Input Data Used</div>
      <table class="data-table" style="margin-bottom:16px;">
        <thead><tr><th>Input</th><th>Value</th><th>Source</th></tr></thead>
        <tbody>
          ${d.inputs.map(inp => `
            <tr>
              <td>${inp.label}</td>
              <td style="font-weight:700;">${inp.value}</td>
              <td style="font-size:11px; color:var(--ey-text-light);">${inp.detail || 'Derived from uploaded data'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>

      <!-- Decision Rules -->
      <div style="font-weight:700; margin-bottom:8px;">‚öôÔ∏è Scoring Rules (first match wins)</div>
      <table class="data-table" style="margin-bottom:16px;">
        <thead><tr><th style="width:40px;"></th><th>Condition</th><th>Score</th></tr></thead>
        <tbody>
          ${d.rules.map(rule => `
            <tr style="${rule.active ? 'background:var(--ey-yellow); background:rgba(255,230,0,0.15); font-weight:700;' : ''}">
              <td>${rule.active ? '‚úÖ' : ''}</td>
              <td>${rule.condition}</td>
              <td>${rule.result}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>

      <!-- Level descriptions -->
      <div style="font-weight:700; margin-bottom:8px;">üìä All Levels for ${dim.name}</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px;">
        ${[1,2,3,4].map(lvl => `
          <div style="padding:10px; border-radius:6px; border:2px solid ${lvl === dim.score ? color : 'var(--ey-mid-gray)'}; ${lvl === dim.score ? 'background:rgba(255,230,0,0.08);' : ''}">
            <div style="font-weight:700; font-size:12px; color:${lvl === dim.score ? color : 'var(--ey-text-light)'};">
              ${lvl === dim.score ? '‚óè ' : ''}${lvl}. ${labels[lvl]}
            </div>
            <div style="font-size:11px; color:var(--ey-text-light); margin-top:4px;">${levelDesc[dim.name][lvl - 1]}</div>
          </div>
        `).join('')}
      </div>

      <!-- Override Control -->
      <div style="padding:14px; border-radius:8px; background:var(--ey-light-gray); border:1px solid var(--ey-mid-gray);">
        <div style="font-weight:700; margin-bottom:8px;">‚úèÔ∏è Override This Score</div>
        <p style="font-size:12px; color:var(--ey-text-light); margin-bottom:10px;">
          If the auto-derived score doesn't reflect reality (e.g. you have AI capabilities not captured in the data), override it here.
        </p>
        <div style="display:flex; align-items:center; gap:12px;">
          <label style="font-size:12px; font-weight:600;">Set ${dim.name} score to:</label>
          <select id="maturityOverrideSelect" style="padding:6px 12px; border-radius:6px; border:1.5px solid var(--ey-mid-gray); font-size:13px;">
            ${[1,2,3,4].map(v => `<option value="${v}" ${v === dim.score ? 'selected' : ''}>${v} ‚Äî ${labels[v]}</option>`).join('')}
          </select>
          <button class="btn btn-primary btn-sm" onclick="applyMaturityOverride(${dimIndex})">Apply Override</button>
          ${dim.overridden ? '<button class="btn btn-outline btn-sm" onclick="clearMaturityOverride(' + dimIndex + ')">Reset to Auto</button>' : ''}
        </div>
        ${dim.overridden ? '<div style="margin-top:8px;"><span class="override-badge">‚ö° Currently overridden (auto-derived was ' + dim.autoScore + ')</span></div>' : ''}
      </div>
    </div>
  `;

  openModal(dim.name + ' ‚Äî Maturity Derivation', html);
}

// Override storage for maturity
window._maturityOverrides = {};

function applyMaturityOverride(dimIndex) {
  const sel = document.getElementById('maturityOverrideSelect');
  const newScore = parseInt(sel.value);
  const dim = window._maturityDimensions[dimIndex];

  // Store override
  window._maturityOverrides[dim.name] = newScore;

  // Force re-render of page 3
  rendered[3] = false;
  closeModal({ target: document.getElementById('modalOverlay') });
  renderPage3WithOverrides();
}

function clearMaturityOverride(dimIndex) {
  const dim = window._maturityDimensions[dimIndex];
  delete window._maturityOverrides[dim.name];

  rendered[3] = false;
  closeModal({ target: document.getElementById('modalOverlay') });
  renderPage3WithOverrides();
}

function renderPage3WithOverrides() {
  // Patch: re-run renderPage3 but apply any overrides
  rendered[3] = false;
  renderPage(3);

  // After render, apply overrides to stored dimensions
  if (window._maturityDimensions && Object.keys(window._maturityOverrides).length > 0) {
    for (const dim of window._maturityDimensions) {
      if (window._maturityOverrides[dim.name] !== undefined) {
        dim.autoScore = dim.autoScore || dim.score; // preserve original
        dim.score = window._maturityOverrides[dim.name];
        dim.overridden = true;
      }
    }
    // Re-render the table only (without re-running full page which would reset)
  }
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULES 2-5: PAGES 4-15 ‚Äî INJECTED
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 2: INITIATIVE LIBRARY + WATERFALL ENGINE (DATA)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// ‚îÄ‚îÄ‚îÄ 58 Initiative Library ‚îÄ‚îÄ‚îÄ
const INITIATIVES = (DEMO.initiatives && DEMO.initiatives.length > 0) ? DEMO.initiatives : generateInitiatives();

function generateInitiatives() {
  const lib = [];
  // Layer 1: AI & Automation (28)
  const ai = [
    { id:'AI01', name:'Conversational Virtual Agent', lever:'deflection', impact:0.30, channels:['Voice','Chat'], complexity:'simple', effort:'high', ahtImpact:0, fcrImpact:0.05, csatImpact:0.10, roles:['Agent L1'], ramp:9, adoption:0.80 },
    { id:'AI02', name:'AI Agent Assist (Real-time)', lever:'aht_reduction', impact:0.20, channels:['Voice','Chat'], complexity:'any', effort:'medium', ahtImpact:-0.20, fcrImpact:0.08, csatImpact:0.05, roles:['Agent L1','Agent L2 / Specialist'], ramp:6, adoption:0.80 },
    { id:'AI03', name:'Intelligent IVR Upgrade', lever:'deflection', impact:0.25, channels:['IVR'], complexity:'simple', effort:'medium', ahtImpact:-0.15, fcrImpact:0.03, csatImpact:0.05, roles:['Agent L1'], ramp:6, adoption:0.75 },
    { id:'AI04', name:'Email Auto-Response', lever:'deflection', impact:0.35, channels:['Email'], complexity:'simple', effort:'medium', ahtImpact:-0.30, fcrImpact:0.05, csatImpact:0.03, roles:['Agent L1','Back-Office / Processing'], ramp:6, adoption:0.80 },
    { id:'AI05', name:'Predictive Intent Routing', lever:'aht_reduction', impact:0.12, channels:['Voice','Chat','Email'], complexity:'any', effort:'medium', ahtImpact:-0.12, fcrImpact:0.10, csatImpact:0.08, roles:['Agent L1','Agent L2 / Specialist'], ramp:6, adoption:0.85 },
    { id:'AI06', name:'Sentiment Analysis & Escalation', lever:'escalation_reduction', impact:0.25, channels:['Voice','Chat'], complexity:'any', effort:'low', ahtImpact:0, fcrImpact:0.05, csatImpact:0.12, roles:['Supervisor / Team Lead'], ramp:3, adoption:0.90 },
    { id:'AI07', name:'Automated QA Scoring', lever:'aht_reduction', impact:0.05, channels:['Voice','Chat','Email'], complexity:'any', effort:'low', ahtImpact:0, fcrImpact:0.03, csatImpact:0.02, roles:['QA Analyst'], ramp:3, adoption:0.90 },
    { id:'AI08', name:'Knowledge Base AI Search', lever:'aht_reduction', impact:0.15, channels:['Voice','Chat','Email'], complexity:'any', effort:'low', ahtImpact:-0.15, fcrImpact:0.07, csatImpact:0.03, roles:['Agent L1','Agent L2 / Specialist','Knowledge Manager'], ramp:3, adoption:0.85 },
    { id:'AI09', name:'WhatsApp Bot', lever:'deflection', impact:0.20, channels:['SMS/WhatsApp'], complexity:'simple', effort:'medium', ahtImpact:0, fcrImpact:0.03, csatImpact:0.05, roles:['Agent L1'], ramp:6, adoption:0.70 },
    { id:'AI10', name:'Social Media Auto-Response', lever:'deflection', impact:0.15, channels:['Social Media'], complexity:'simple', effort:'low', ahtImpact:0, fcrImpact:0.02, csatImpact:0.03, roles:['Agent L1'], ramp:3, adoption:0.70 },
    { id:'AI11', name:'Proactive Outbound Notifications', lever:'deflection', impact:0.10, channels:['SMS/WhatsApp','Email'], complexity:'simple', effort:'low', ahtImpact:0, fcrImpact:0.05, csatImpact:0.08, roles:['Agent L1'], ramp:3, adoption:0.85 },
    { id:'AI12', name:'AI-Powered WFM Scheduling', lever:'shrinkage_reduction', impact:0.10, channels:['Voice','Chat'], complexity:'any', effort:'medium', ahtImpact:0, fcrImpact:0, csatImpact:0, roles:['WFM Analyst'], ramp:6, adoption:0.80 },
    { id:'AI13', name:'Robotic Process Automation (RPA)', lever:'aht_reduction', impact:0.25, channels:['Email'], complexity:'simple', effort:'medium', ahtImpact:-0.25, fcrImpact:0.05, csatImpact:0.02, roles:['Back-Office / Processing'], ramp:6, adoption:0.80 },
    { id:'AI14', name:'Visual IVR / Digital Switchboard', lever:'deflection', impact:0.15, channels:['IVR','App/Self-Service'], complexity:'simple', effort:'medium', ahtImpact:-0.10, fcrImpact:0.05, csatImpact:0.10, roles:['Agent L1'], ramp:6, adoption:0.70 },
    { id:'AI15', name:'AI Complaint Triage', lever:'escalation_reduction', impact:0.20, channels:['Voice','Chat','Email'], complexity:'complex', effort:'medium', ahtImpact:-0.10, fcrImpact:0.08, csatImpact:0.10, roles:['Agent L2 / Specialist','Agent L3 / Expert'], ramp:6, adoption:0.75 },
    { id:'AI16', name:'Predictive Churn Detection', lever:'deflection', impact:0.05, channels:['Voice','Chat'], complexity:'any', effort:'medium', ahtImpact:0, fcrImpact:0.03, csatImpact:0.15, roles:['Agent L2 / Specialist'], ramp:6, adoption:0.75 },
    { id:'AI17', name:'Auto Summarisation (Post-Call)', lever:'aht_reduction', impact:0.08, channels:['Voice','Chat'], complexity:'any', effort:'low', ahtImpact:-0.08, fcrImpact:0, csatImpact:0, roles:['Agent L1','Agent L2 / Specialist'], ramp:3, adoption:0.90 },
    { id:'AI18', name:'Self-Service App Enhancement', lever:'deflection', impact:0.20, channels:['App/Self-Service'], complexity:'simple', effort:'high', ahtImpact:0, fcrImpact:0.05, csatImpact:0.10, roles:['Agent L1'], ramp:9, adoption:0.75 },
    { id:'AI19', name:'Document AI / OCR Processing', lever:'aht_reduction', impact:0.30, channels:['Email'], complexity:'moderate', effort:'medium', ahtImpact:-0.30, fcrImpact:0.05, csatImpact:0.02, roles:['Back-Office / Processing'], ramp:6, adoption:0.80 },
    { id:'AI20', name:'AI Training & Coaching', lever:'aht_reduction', impact:0.10, channels:['Voice','Chat'], complexity:'any', effort:'low', ahtImpact:-0.10, fcrImpact:0.05, csatImpact:0.05, roles:['Trainer','Agent L1'], ramp:3, adoption:0.85 },
    { id:'AI21', name:'Speech Analytics', lever:'aht_reduction', impact:0.08, channels:['Voice'], complexity:'any', effort:'medium', ahtImpact:-0.05, fcrImpact:0.05, csatImpact:0.05, roles:['QA Analyst','Supervisor / Team Lead'], ramp:6, adoption:0.80 },
    { id:'AI22', name:'Customer 360 Screen Pop', lever:'aht_reduction', impact:0.12, channels:['Voice','Chat'], complexity:'any', effort:'low', ahtImpact:-0.12, fcrImpact:0.06, csatImpact:0.05, roles:['Agent L1','Agent L2 / Specialist'], ramp:3, adoption:0.90 },
    { id:'AI23', name:'AI Callback Scheduling', lever:'deflection', impact:0.08, channels:['Voice'], complexity:'any', effort:'low', ahtImpact:0, fcrImpact:0.02, csatImpact:0.08, roles:['Agent L1'], ramp:3, adoption:0.85 },
    { id:'AI24', name:'Video Support Channel', lever:'escalation_reduction', impact:0.10, channels:['Retail/Walk-in'], complexity:'complex', effort:'high', ahtImpact:-0.10, fcrImpact:0.10, csatImpact:0.15, roles:['Agent L2 / Specialist','Agent L3 / Expert'], ramp:9, adoption:0.60 },
    { id:'AI25', name:'Smart FAQ / Guided Resolution', lever:'deflection', impact:0.15, channels:['App/Self-Service','Chat'], complexity:'simple', effort:'low', ahtImpact:0, fcrImpact:0.05, csatImpact:0.05, roles:['Agent L1','Knowledge Manager'], ramp:3, adoption:0.80 },
    { id:'AI26', name:'AI Fraud Detection', lever:'escalation_reduction', impact:0.08, channels:['Voice','Chat','App/Self-Service'], complexity:'complex', effort:'high', ahtImpact:-0.05, fcrImpact:0.03, csatImpact:0.02, roles:['Agent L3 / Expert'], ramp:9, adoption:0.75 },
    { id:'AI27', name:'Next-Best-Action Engine', lever:'aht_reduction', impact:0.10, channels:['Voice','Chat'], complexity:'any', effort:'medium', ahtImpact:-0.10, fcrImpact:0.08, csatImpact:0.10, roles:['Agent L1','Agent L2 / Specialist'], ramp:6, adoption:0.80 },
    { id:'AI28', name:'Automated Compliance Checks', lever:'aht_reduction', impact:0.05, channels:['Voice','Chat','Email'], complexity:'any', effort:'low', ahtImpact:-0.05, fcrImpact:0.02, csatImpact:0, roles:['QA Analyst','Agent L1'], ramp:3, adoption:0.85 },
  ];
  ai.forEach(i => { i.layer = 'AI & Automation'; lib.push(i); });

  // Layer 2: Operating Model (18)
  const om = [
    { id:'OP01', name:'Tiered Service Model', lever:'deflection', impact:0.15, channels:['Voice','Chat'], complexity:'any', effort:'high', ahtImpact:-0.10, fcrImpact:0.08, csatImpact:0.05, roles:['Agent L1','Agent L2 / Specialist','Supervisor / Team Lead'], ramp:9, adoption:0.85 },
    { id:'OP02', name:'Universal Agent / Cross-skilling', lever:'aht_reduction', impact:0.10, channels:['Voice','Chat','Email'], complexity:'any', effort:'high', ahtImpact:-0.10, fcrImpact:0.10, csatImpact:0.05, roles:['Agent L1','Trainer'], ramp:9, adoption:0.75 },
    { id:'OP03', name:'Queue Consolidation', lever:'shrinkage_reduction', impact:0.15, channels:['Voice','Chat'], complexity:'any', effort:'medium', ahtImpact:-0.05, fcrImpact:0.05, csatImpact:0.03, roles:['WFM Analyst','Supervisor / Team Lead'], ramp:6, adoption:0.85 },
    { id:'OP04', name:'Shift Optimisation', lever:'shrinkage_reduction', impact:0.10, channels:['Voice','Chat'], complexity:'any', effort:'low', ahtImpact:0, fcrImpact:0, csatImpact:0, roles:['WFM Analyst'], ramp:3, adoption:0.90 },
    { id:'OP05', name:'Supervisor Span Increase', lever:'aht_reduction', impact:0.05, channels:['Voice','Chat','Email'], complexity:'any', effort:'low', ahtImpact:0, fcrImpact:0, csatImpact:-0.02, roles:['Supervisor / Team Lead'], ramp:3, adoption:0.90 },
    { id:'OP06', name:'Back-Office Automation', lever:'aht_reduction', impact:0.20, channels:['Email'], complexity:'simple', effort:'medium', ahtImpact:-0.20, fcrImpact:0.05, csatImpact:0.03, roles:['Back-Office / Processing'], ramp:6, adoption:0.80 },
    { id:'OP07', name:'FCR Improvement Program', lever:'repeat_reduction', impact:0.20, channels:['Voice','Chat','Email'], complexity:'any', effort:'medium', ahtImpact:0, fcrImpact:0.20, csatImpact:0.10, roles:['Agent L1','Supervisor / Team Lead','Trainer'], ramp:6, adoption:0.80 },
    { id:'OP08', name:'Escalation Path Redesign', lever:'escalation_reduction', impact:0.25, channels:['Voice','Chat'], complexity:'any', effort:'medium', ahtImpact:-0.05, fcrImpact:0.10, csatImpact:0.08, roles:['Agent L2 / Specialist','Agent L3 / Expert','Supervisor / Team Lead'], ramp:6, adoption:0.80 },
    { id:'OP09', name:'Knowledge Management Overhaul', lever:'aht_reduction', impact:0.12, channels:['Voice','Chat','Email'], complexity:'any', effort:'medium', ahtImpact:-0.12, fcrImpact:0.08, csatImpact:0.05, roles:['Knowledge Manager','Trainer'], ramp:6, adoption:0.85 },
    { id:'OP10', name:'Performance Incentive Redesign', lever:'aht_reduction', impact:0.08, channels:['Voice','Chat'], complexity:'any', effort:'low', ahtImpact:-0.05, fcrImpact:0.05, csatImpact:0.05, roles:['Supervisor / Team Lead'], ramp:3, adoption:0.85 },
    { id:'OP11', name:'Demand Forecasting Model', lever:'shrinkage_reduction', impact:0.08, channels:['Voice','Chat'], complexity:'any', effort:'medium', ahtImpact:0, fcrImpact:0, csatImpact:0, roles:['WFM Analyst','Reporting / Analytics'], ramp:6, adoption:0.85 },
    { id:'OP12', name:'Channel Migration Campaign', lever:'deflection', impact:0.10, channels:['Voice','Retail/Walk-in'], complexity:'simple', effort:'low', ahtImpact:0, fcrImpact:0, csatImpact:-0.02, roles:['Agent L1'], ramp:3, adoption:0.70 },
    { id:'OP13', name:'Lean Process Mapping', lever:'aht_reduction', impact:0.08, channels:['Voice','Chat','Email'], complexity:'any', effort:'low', ahtImpact:-0.08, fcrImpact:0.03, csatImpact:0.02, roles:['Agent L1','Supervisor / Team Lead'], ramp:3, adoption:0.85 },
    { id:'OP14', name:'Specialised Retention Team', lever:'escalation_reduction', impact:0.15, channels:['Voice'], complexity:'complex', effort:'medium', ahtImpact:-0.05, fcrImpact:0.12, csatImpact:0.10, roles:['Agent L2 / Specialist'], ramp:6, adoption:0.80 },
    { id:'OP15', name:'Proactive Outbound (Manual)', lever:'deflection', impact:0.05, channels:['Voice','SMS/WhatsApp'], complexity:'simple', effort:'low', ahtImpact:0, fcrImpact:0.03, csatImpact:0.05, roles:['Agent L1'], ramp:3, adoption:0.80 },
    { id:'OP16', name:'Reporting Consolidation', lever:'shrinkage_reduction', impact:0.05, channels:['Voice','Chat','Email'], complexity:'any', effort:'low', ahtImpact:0, fcrImpact:0, csatImpact:0, roles:['Reporting / Analytics','WFM Analyst'], ramp:3, adoption:0.90 },
    { id:'OP17', name:'Call Avoidance (Root Cause Fix)', lever:'deflection', impact:0.12, channels:['Voice','Chat'], complexity:'any', effort:'medium', ahtImpact:0, fcrImpact:0.10, csatImpact:0.08, roles:['Agent L1','Supervisor / Team Lead'], ramp:6, adoption:0.75 },
    { id:'OP18', name:'Quality Framework Refresh', lever:'aht_reduction', impact:0.05, channels:['Voice','Chat','Email'], complexity:'any', effort:'low', ahtImpact:0, fcrImpact:0.05, csatImpact:0.05, roles:['QA Analyst','Trainer'], ramp:3, adoption:0.85 },
  ];
  om.forEach(i => { i.layer = 'Operating Model'; lib.push(i); });

  // Layer 3: Location Strategy (12)
  const loc = [
    { id:'LS01', name:'Nearshore Migration (L1)', lever:'cost_reduction', impact:0.30, channels:['Voice','Chat'], complexity:'simple', effort:'high', ahtImpact:0.05, fcrImpact:-0.03, csatImpact:-0.05, roles:['Agent L1'], ramp:12, adoption:0.70 },
    { id:'LS02', name:'Nearshore Migration (L2)', lever:'cost_reduction', impact:0.25, channels:['Voice','Chat'], complexity:'moderate', effort:'high', ahtImpact:0.05, fcrImpact:-0.05, csatImpact:-0.08, roles:['Agent L2 / Specialist'], ramp:12, adoption:0.60 },
    { id:'LS03', name:'Offshore Migration (L1)', lever:'cost_reduction', impact:0.50, channels:['Voice','Chat','Email'], complexity:'simple', effort:'high', ahtImpact:0.10, fcrImpact:-0.05, csatImpact:-0.10, roles:['Agent L1'], ramp:12, adoption:0.60 },
    { id:'LS04', name:'Offshore Back-Office', lever:'cost_reduction', impact:0.45, channels:['Email'], complexity:'simple', effort:'medium', ahtImpact:0.05, fcrImpact:-0.03, csatImpact:-0.03, roles:['Back-Office / Processing'], ramp:9, adoption:0.75 },
    { id:'LS05', name:'WFH / Hybrid Model', lever:'cost_reduction', impact:0.10, channels:['Voice','Chat','Email'], complexity:'any', effort:'low', ahtImpact:0, fcrImpact:0, csatImpact:0.02, roles:['Agent L1','Agent L2 / Specialist'], ramp:3, adoption:0.85 },
    { id:'LS06', name:'Hub Consolidation (Sites)', lever:'cost_reduction', impact:0.15, channels:['Voice','Chat'], complexity:'any', effort:'high', ahtImpact:0, fcrImpact:0, csatImpact:0, roles:['Supervisor / Team Lead','Agent L1'], ramp:12, adoption:0.80 },
    { id:'LS07', name:'Gig / Flex Agent Model', lever:'shrinkage_reduction', impact:0.12, channels:['Chat','Email','Social Media'], complexity:'simple', effort:'medium', ahtImpact:0.05, fcrImpact:-0.02, csatImpact:-0.03, roles:['Agent L1'], ramp:6, adoption:0.65 },
    { id:'LS08', name:'Extended Hours (Follow-the-Sun)', lever:'shrinkage_reduction', impact:0.08, channels:['Voice','Chat'], complexity:'any', effort:'medium', ahtImpact:0, fcrImpact:0.02, csatImpact:0.05, roles:['Agent L1'], ramp:6, adoption:0.75 },
    { id:'LS09', name:'Nearshore QA Team', lever:'cost_reduction', impact:0.20, channels:['Voice','Chat','Email'], complexity:'any', effort:'medium', ahtImpact:0, fcrImpact:0, csatImpact:0, roles:['QA Analyst'], ramp:6, adoption:0.75 },
    { id:'LS10', name:'Offshore WFM Hub', lever:'cost_reduction', impact:0.25, channels:['Voice','Chat','Email'], complexity:'any', effort:'medium', ahtImpact:0, fcrImpact:0, csatImpact:0, roles:['WFM Analyst','Reporting / Analytics'], ramp:6, adoption:0.80 },
    { id:'LS11', name:'Retail Footprint Optimisation', lever:'cost_reduction', impact:0.20, channels:['Retail/Walk-in'], complexity:'any', effort:'high', ahtImpact:0, fcrImpact:0, csatImpact:-0.05, roles:['Agent L1'], ramp:12, adoption:0.70 },
    { id:'LS12', name:'Centre of Excellence (CoE)', lever:'aht_reduction', impact:0.08, channels:['Voice','Chat','Email'], complexity:'complex', effort:'medium', ahtImpact:-0.08, fcrImpact:0.05, csatImpact:0.05, roles:['Agent L3 / Expert','Knowledge Manager'], ramp:6, adoption:0.80 },
  ];
  loc.forEach(i => { i.layer = 'Location Strategy'; lib.push(i); });

  // ‚îÄ‚îÄ‚îÄ Smart Initiative Relevance Engine ‚îÄ‚îÄ‚îÄ
  // Score each initiative against the client's actual diagnostic data
  function scoreRelevance(init) {
    let score = 0;
    let reasons = [];

    // 1. Channel Match: Does the client have volume on this initiative's target channels?
    const clientChannels = DEMO.channels;
    const channelOverlap = init.channels.filter(c => clientChannels.includes(c));
    if (channelOverlap.length === 0) {
      return { score: 0, reasons: ['No matching channels in your contact centre'] };
    }
    const channelVolume = DEMO.queues.filter(q => channelOverlap.includes(q.channel)).reduce((s,q) => s + q.volume, 0);
    const channelPct = channelVolume / DEMO.totalVolume;
    score += Math.round(channelPct * 30); // max 30 pts for channel coverage
    if (channelPct > 0.3) reasons.push(`Covers ${(channelPct*100).toFixed(0)}% of your volume via ${channelOverlap.join(', ')}`);

    // 2. Lever-Pain Match: Does the lever address an actual pain point?
    const leverPainMap = {
      deflection: () => {
        const highVolSimple = DEMO.queues.filter(q => channelOverlap.includes(q.channel) && q.volume > 800);
        if (highVolSimple.length > 0) { score += 25; reasons.push(`${highVolSimple.length} high-volume queues suitable for deflection`); }
        else score += 5;
      },
      aht_reduction: () => {
        const highAHT = DEMO.queues.filter(q => channelOverlap.includes(q.channel) && q.aht > (getChannelBenchmark(q.channel, 'AHT') || 8));
        if (highAHT.length > 0) { score += 25; reasons.push(`${highAHT.length} queues exceeding AHT benchmark`); }
        else score += 5;
      },
      escalation_reduction: () => {
        const highEsc = DEMO.queues.filter(q => channelOverlap.includes(q.channel) && q.escalation > 0.10);
        if (highEsc.length > 0) { score += 25; reasons.push(`${highEsc.length} queues with >10% escalation rate`); }
        else score += 5;
      },
      repeat_reduction: () => {
        const highRepeat = DEMO.queues.filter(q => channelOverlap.includes(q.channel) && q.repeat > 0.15);
        if (highRepeat.length > 0) { score += 25; reasons.push(`${highRepeat.length} queues with >15% repeat rate`); }
        else score += 5;
      },
      cost_reduction: () => {
        const totalChanCost = DEMO.queues.filter(q => channelOverlap.includes(q.channel)).reduce((s,q) => s + q.volume * q.cpc, 0);
        if (totalChanCost > 200000) { score += 25; reasons.push(`$${(totalChanCost/1000).toFixed(0)}K/mo cost on target channels`); }
        else score += 10;
      },
      shrinkage_reduction: () => {
        score += 15; reasons.push('Applies to operational efficiency');
      }
    };
    if (leverPainMap[init.lever]) leverPainMap[init.lever]();

    // 3. Complexity match: simple initiatives get bonus if client has simple intents
    const simpleIntents = DEMO.queues.filter(q => channelOverlap.includes(q.channel) && q.complexity < 0.4);
    if (init.complexity === 'simple' && simpleIntents.length > 3) {
      score += 10; reasons.push('High-volume simple intents available');
    } else if (init.complexity === 'complex') {
      const complexIntents = DEMO.queues.filter(q => q.complexity > 0.6);
      if (complexIntents.length > 2) { score += 10; reasons.push('Complex intents present'); }
    } else {
      score += 8; // moderate complexity ‚Äî usually applicable
    }

    // 4. CX impact: bonus if CSAT is below benchmark and initiative improves it
    if (DEMO.avgCSAT < 3.8 && init.csatImpact > 0) {
      score += 10; reasons.push(`CSAT below target ‚Äî initiative improves by +${(init.csatImpact*100).toFixed(0)}%`);
    }

    // 5. Quick win bonus: low effort initiatives get preference
    if (init.effort === 'low') { score += 10; reasons.push('Quick win ‚Äî low effort'); }
    else if (init.effort === 'medium') score += 5;

    // 6. Impact magnitude
    if (init.impact >= 0.20) { score += 10; reasons.push(`High impact: ${(init.impact*100).toFixed(0)}%`); }
    else if (init.impact >= 0.10) score += 5;

    return { score: Math.min(100, score), reasons };
  }

  // Assign enabled/status + auto-sequence timing
  const RELEVANCE_THRESHOLD = 20; // Only auto-enable initiatives scoring above this
  let monthCursor = { 'AI & Automation': 1, 'Operating Model': 3, 'Location Strategy': 6 };
  lib.forEach(init => {
    const rel = scoreRelevance(init);
    init.relevanceScore = rel.score;
    init.relevanceReasons = rel.reasons;
    init.enabled = rel.score >= RELEVANCE_THRESHOLD; // Only enable if relevant
    init.startMonth = monthCursor[init.layer];
    init.endMonth = init.startMonth + init.ramp;
    monthCursor[init.layer] += Math.max(1, Math.floor(init.ramp * 0.4));

    // Score effort/impact for priority matrix
    const effortMap = { low: 1, medium: 2, high: 3 };
    init.effortScore = effortMap[init.effort] || 2;
    init.impactScore = init.impact * 10;

    // Risk scores
    init.implRisk = Math.min(5, Math.ceil(init.effortScore * 1.5));
    init.cxRisk = init.csatImpact < 0 ? Math.min(5, Math.ceil(Math.abs(init.csatImpact) * 20)) : 1;
    init.opsRisk = Math.min(5, Math.ceil(init.ramp / 4));
    init.overallRisk = +(init.implRisk * 0.4 + init.cxRisk * 0.3 + init.opsRisk * 0.3).toFixed(1);
  });

  return lib;
}

// ‚îÄ‚îÄ‚îÄ Simplified Waterfall Engine (with diminishing returns) ‚îÄ‚îÄ‚îÄ
let WATERFALL = (DEMO.waterfall && DEMO.waterfall.yearly) ? DEMO.waterfall : runWaterfall();

// If server provided pre-computed waterfall + initiatives, use those (more sophisticated engine)
if (DEMO.waterfall && DEMO.waterfall.yearly) {
    console.log('‚úì Using server-computed waterfall engine (with diminishing returns cascade)');
    // Merge server waterfall data into client WATERFALL
    WATERFALL.totalNPV = DEMO.waterfall.totalNPV || WATERFALL.totalNPV;
    WATERFALL.totalSaving = DEMO.waterfall.totalSaving || WATERFALL.totalSaving;
    WATERFALL.totalInvestment = DEMO.waterfall.totalInvestment || WATERFALL.totalInvestment;
    WATERFALL.roi = DEMO.waterfall.roi != null ? DEMO.waterfall.roi : WATERFALL.roi;
    WATERFALL.payback = DEMO.waterfall.payback != null ? DEMO.waterfall.payback : WATERFALL.payback;
    WATERFALL.irr = DEMO.waterfall.irr != null ? DEMO.waterfall.irr : WATERFALL.irr;
    WATERFALL.yearly = DEMO.waterfall.yearly || WATERFALL.yearly;
    WATERFALL.scenarios = DEMO.waterfall.scenarios || WATERFALL.scenarios;
    WATERFALL.sensitivity = DEMO.waterfall.sensitivity || WATERFALL.sensitivity;
    WATERFALL.roleImpact = DEMO.waterfall.roleImpact || WATERFALL.roleImpact;
    WATERFALL.enabledInits = DEMO.waterfall.enabledInits || WATERFALL.enabledInits;
    WATERFALL.leverAccum = DEMO.waterfall.leverAccum || WATERFALL.leverAccum;
    WATERFALL.investmentItems = DEMO.waterfall.investmentItems || WATERFALL.investmentItems || [];
    WATERFALL.investmentYearly = DEMO.waterfall.investmentYearly || WATERFALL.investmentYearly || [];
    WATERFALL.investmentSummary = DEMO.waterfall.investmentSummary || WATERFALL.investmentSummary || {};
    WATERFALL.techInvestment = DEMO.waterfall.techInvestment || WATERFALL.techInvestment || 0;
    WATERFALL.annualMaintenance = DEMO.waterfall.annualMaintenance || WATERFALL.annualMaintenance || 0;
    WATERFALL.changeMgmt = DEMO.waterfall.changeMgmt || WATERFALL.changeMgmt || 0;
    WATERFALL.training = DEMO.waterfall.training || WATERFALL.training || 0;
    WATERFALL.contingency = DEMO.waterfall.contingency || WATERFALL.contingency || 0;
    WATERFALL.totalReduction = DEMO.waterfall.totalReduction || WATERFALL.totalReduction || 0;
    WATERFALL.layerFTE = DEMO.waterfall.layerFTE || WATERFALL.layerFTE || {};
    WATERFALL.layerSaving = DEMO.waterfall.layerSaving || WATERFALL.layerSaving || {};
}

// Apply server initiative scores if available
if (DEMO.initiatives && DEMO.initiatives.length) {
    const serverMap = {};
    DEMO.initiatives.forEach(si => serverMap[si.id] = si);
    INITIATIVES.forEach(init => {
        const si = serverMap[init.id];
        if (si) {
            init.matchScore = si.matchScore || init.relevanceScore;
            init.relevanceScore = si.score || si.matchScore || init.relevanceScore;
            init.relevanceReasons = si.reasons || init.relevanceReasons;
            init.enabled = si.enabled != null ? si.enabled : init.enabled;
            init._fteImpact = si._fteImpact;
            init._annualSaving = si._annualSaving;
            init._effectiveImpact = si._effectiveImpact;
            init._contributionPct = si._contributionPct;
            init._rampPcts = si._rampPcts || init._rampPcts;
            init._linkedQueues = si._linkedQueues || init._linkedQueues;
            init._capApplied = si._capApplied;
            if (si.rampYear1 != null) init.rampYear1 = si.rampYear1;
            if (si.rampYear2 != null) init.rampYear2 = si.rampYear2;
            if (si.rampYear3 != null) init.rampYear3 = si.rampYear3;
        }
    });
    console.log('Server initiative scores applied to', Object.keys(serverMap).length, 'initiatives');
}

// Merge risk data from riskRegister into INITIATIVES
if (DEMO.riskRegister && DEMO.riskRegister.length) {
    const riskMap = {};
    DEMO.riskRegister.forEach(r => riskMap[r.id] = r);
    INITIATIVES.forEach(init => {
        const r = riskMap[init.id];
        if (r) {
            init.implRisk = r.implRisk || init.implRisk;
            init.cxRisk = r.cxRisk || init.cxRisk;
            init.opsRisk = r.opsRisk || init.opsRisk;
            init.overallRisk = r.overall || r.score || init.overallRisk;
        }
        // Ensure risk fields always exist (compute if missing)
        if (init.implRisk == null) {
            const effortMap = { low: 1, medium: 2, high: 3 };
            init.implRisk = Math.min(5, Math.ceil((effortMap[init.effort] || 2) * 1.5));
        }
        if (init.cxRisk == null) {
            init.cxRisk = init.csatImpact < 0 ? Math.min(5, Math.ceil(Math.abs(init.csatImpact) * 20)) : 1;
        }
        if (init.opsRisk == null) {
            init.opsRisk = Math.min(5, Math.ceil((init.ramp || 3) / 4));
        }
        if (init.overallRisk == null) {
            init.overallRisk = +(init.implRisk * 0.4 + init.cxRisk * 0.3 + init.opsRisk * 0.3).toFixed(1);
        }
    });
    console.log('Risk data merged into', INITIATIVES.filter(i => i.overallRisk != null).length, 'initiatives');
}

// ‚îÄ‚îÄ V6: Sync DEMO fields after any backend mutation (toggle, save, recalculate) ‚îÄ‚îÄ
function _syncDemoFromBackend() {
    // Sync waterfall-derived fields
    if (WATERFALL) {
        DEMO.layerFTE = WATERFALL.layerFTE || DEMO.layerFTE;
        DEMO.layerSaving = WATERFALL.layerSaving || DEMO.layerSaving;
        DEMO.poolUtilization = WATERFALL.poolUtilization || DEMO.poolUtilization;
        DEMO.poolSummary = WATERFALL.poolSummary || DEMO.poolSummary;
        DEMO.auditTrail = WATERFALL.auditTrail || DEMO.auditTrail;
        DEMO.yearlyProjections = WATERFALL.yearly || DEMO.yearlyProjections;
        DEMO.scenarios = WATERFALL.scenarios || DEMO.scenarios;
        DEMO.sensitivity = WATERFALL.sensitivity || DEMO.sensitivity;
        DEMO.roleImpact = WATERFALL.roleImpact || DEMO.roleImpact;
        DEMO.investmentItems = WATERFALL.investmentItems || DEMO.investmentItems;
        DEMO.investmentYearly = WATERFALL.investmentYearly || DEMO.investmentYearly;
        DEMO.investmentSummary = WATERFALL.investmentSummary || DEMO.investmentSummary;
        DEMO.financials = {
            totalNPV: WATERFALL.totalNPV || 0, totalSaving: WATERFALL.totalSaving || 0,
            totalInvestment: WATERFALL.totalInvestment || 0, roi: WATERFALL.roi || 0,
            roiGross: WATERFALL.roiGross || 0, payback: WATERFALL.payback || 0,
            irr: WATERFALL.irr || 0, techInvestment: WATERFALL.techInvestment || 0,
            annualMaintenance: WATERFALL.annualMaintenance || 0,
        };
    }
    // Sync initiative-derived fields
    DEMO.enabledCount = INITIATIVES.filter(i => i.enabled).length;
    DEMO.initiatives = INITIATIVES;
    // Re-populate missing risk fields on initiatives (backend doesn't send implRisk/cxRisk/opsRisk)
    const effortMap = { low: 1, medium: 2, high: 3 };
    INITIATIVES.forEach(init => {
        if (init.effortScore == null) init.effortScore = effortMap[init.effort] || 2;
        if (init.impactScore == null) init.impactScore = (init.impact || 0) * 10;
        if (init.implRisk == null) init.implRisk = Math.min(5, Math.ceil((effortMap[init.effort] || 2) * 1.5));
        if (init.cxRisk == null) init.cxRisk = init.csatImpact < 0 ? Math.min(5, Math.ceil(Math.abs(init.csatImpact) * 20)) : 1;
        if (init.opsRisk == null) init.opsRisk = Math.min(5, Math.ceil((init.ramp || 3) / 4));
        if (init.overallRisk == null) init.overallRisk = +(init.implRisk * 0.4 + init.cxRisk * 0.3 + init.opsRisk * 0.3).toFixed(1);
    });
}

function refreshFromServer() {
  // Change 9: FULL RELOAD ‚Äî re-reads Excel data, clears all overrides, complete fresh start
  showRecalcToast();
  if (!confirm('This will reload all data from source and reset your overrides. Continue?')) return;
  fetch('/api/refresh', {method: 'POST'})
  .then(r => r.json())
  .then(resp => {
    if (resp.data) {
      Object.assign(DEMO, resp.data);
      _normalizeBenchmarks(DEMO); // Fix: re-normalize benchmarks after overwrite
      if (!DEMO.intents) DEMO.intents = [...new Set(DEMO.queues.map(q => q.intent))];
      if (!DEMO.channels) DEMO.channels = [...new Set(DEMO.queues.map(q => q.channel))];
      if (!DEMO.bus) DEMO.bus = [...new Set(DEMO.queues.map(q => q.bu))];
    }
    if (resp.initiatives) {
      INITIATIVES.length = 0;
      resp.initiatives.forEach(i => INITIATIVES.push(i));
    }
    if (resp.waterfall) {
      WATERFALL = resp.waterfall;
      WATERFALL.totalReduction = WATERFALL.yearly?.[WATERFALL.yearly.length-1]?.fteReduction || 0;
    }
    _syncDemoFromBackend(); // Fix: sync waterfall-derived fields to DEMO
    Object.keys(rendered).forEach(k => rendered[k] = false);
    renderPage(currentPage);
    console.log('[OK] Full refresh from source complete ‚Äî overrides cleared');
  })
  .catch(err => console.error('Refresh failed:', err));
}

function showRecalcToast() {
  const t = document.getElementById('recalcToast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 1200);
}

function recalculateAll(activeLayer) {
  // Change 5b/9: RECALCULATE ‚Äî sends full parameter state, preserves overrides
  // Change 6b: optional activeLayer for scoped calculation
  showRecalcToast();
  const payload = {
    params: Object.assign({}, DEMO.params),
    activeLayer: activeLayer || null,
  };
  fetch('/api/recalculate', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(resp => {
    if (resp.data) {
      Object.assign(DEMO, resp.data);
      _normalizeBenchmarks(DEMO); // Fix: re-normalize benchmarks after overwrite
      if (!DEMO.intents) DEMO.intents = [...new Set(DEMO.queues.map(q => q.intent))];
      if (!DEMO.channels) DEMO.channels = [...new Set(DEMO.queues.map(q => q.channel))];
      if (!DEMO.bus) DEMO.bus = [...new Set(DEMO.queues.map(q => q.bu))];
    }
    // Use scoped or full initiative data
    const initData = resp.initiatives || [];
    if (initData.length > 0) {
      INITIATIVES.length = 0;
      initData.forEach(i => INITIATIVES.push(i));
    }
    // Use scoped or full waterfall
    const wfData = resp.waterfall || {};
    if (wfData.yearly) {
      WATERFALL = wfData;
      WATERFALL.totalReduction = WATERFALL.yearly?.[WATERFALL.yearly.length-1]?.fteReduction || 0;
    }
    _syncDemoFromBackend();
    Object.keys(rendered).forEach(k => rendered[k] = false);
    renderPage(currentPage);
    console.log(`[OK] Recalculate complete${resp.scoped ? ' (scoped: '+resp.activeLayer+')' : ''}`);
    console.log(`  Enabled: ${resp.enabledCount || '?'} initiatives`);
  })
  .catch(err => {
    console.warn('Server recalc failed, using client fallback:', err);
    WATERFALL = runWaterfall();
    _syncDemoFromBackend();
    Object.keys(rendered).forEach(k => rendered[k] = false);
    renderPage(currentPage);
  });
}

function runWaterfall() {
  const horizon = DEMO.params.horizon;
  const enabledInits = INITIATIVES.filter(i => i.enabled);

  // Lever affinity caps per complexity band (from spec Section 7.3)
  const leverCaps = {
    deflection:           { simple: 0.55, moderate: 0.40, complex: 0.25 },
    aht_reduction:        { simple: 0.45, moderate: 0.35, complex: 0.25 },
    escalation_reduction: { simple: 0.40, moderate: 0.35, complex: 0.30 },
    repeat_reduction:     { simple: 0.40, moderate: 0.30, complex: 0.20 },
    shrinkage_reduction:  { simple: 0.30, moderate: 0.25, complex: 0.20 },
    cost_reduction:       { simple: 0.50, moderate: 0.45, complex: 0.35 },
  };
  const kValues = { simple: 3.0, moderate: 2.0, complex: 1.2 };

  // FTE impact per role per year
  const roleImpact = {};
  DEMO.roles.forEach(r => {
    roleImpact[r.role] = { baseline: r.headcount, yearly: Array(horizon).fill(0) };
  });

  // Track cumulative lever impact per complexity band for diminishing returns
  const leverAccum = {};

  // Sort initiatives by layer order (AI first, then OM, then Location)
  const layerOrder = { 'AI & Automation': 0, 'Operating Model': 1, 'Location Strategy': 2 };
  const sortedInits = [...enabledInits].sort((a,b) => (layerOrder[a.layer]||0) - (layerOrder[b.layer]||0));

  // Per-initiative contribution with diminishing returns
  sortedInits.forEach(init => {
    const affectedRoles = DEMO.roles.filter(r => init.roles.includes(r.role));
    const totalAffectedFTE = affectedRoles.reduce((s,r) => s + r.headcount, 0);
    if (totalAffectedFTE === 0) { init._fteImpact = 0; init._annualSaving = 0; init._linkedQueues = 0; return; }

    // Determine complexity band for this initiative
    const complexBand = init.complexity === 'simple' ? 'simple' :
                        init.complexity === 'moderate' ? 'moderate' :
                        init.complexity === 'complex' ? 'complex' : 'moderate';

    // Apply diminishing returns per lever
    const lever = init.lever || 'aht_reduction';
    const leverKey = `${lever}_${complexBand}`;
    if (!leverAccum[leverKey]) leverAccum[leverKey] = 0;

    const cap = (leverCaps[lever] || leverCaps.aht_reduction)[complexBand] || 0.35;
    const k = kValues[complexBand] || 2.0;
    const rawCumBefore = leverAccum[leverKey];
    const rawCumAfter = rawCumBefore + init.impact;
    const effectiveBefore = cap * (1 - Math.exp(-k * rawCumBefore / cap));
    const effectiveAfter = cap * (1 - Math.exp(-k * rawCumAfter / cap));
    const effectiveImpact = effectiveAfter - effectiveBefore;
    leverAccum[leverKey] = rawCumAfter;

    const fteReduction = totalAffectedFTE * effectiveImpact * init.adoption;

    for (let yr = 0; yr < horizon; yr++) {
      const monthStart = yr * 12 + 1;
      const monthEnd = (yr + 1) * 12;
      const midMonth = (monthStart + monthEnd) / 2;
      const progress = Math.max(0, Math.min(1, (midMonth - init.startMonth) / (init.endMonth - init.startMonth || 1)));
      const adoption = init.adoption / (1 + Math.exp(-10 * (progress - 0.5)));
      const yrFTE = totalAffectedFTE * effectiveImpact * adoption;

      affectedRoles.forEach(r => {
        const share = r.headcount / (totalAffectedFTE || 1);
        roleImpact[r.role].yearly[yr] += yrFTE * share;
      });
    }

    init._fteImpact = fteReduction;
    // Weighted average cost across affected roles
    const wtdCost = affectedRoles.reduce((s,r) => s + r.headcount * r.costPerFTE, 0) / totalAffectedFTE;
    init._annualSaving = fteReduction * wtdCost;
    init._effectiveImpact = effectiveImpact;
    init._linkedQueues = DEMO.queues.filter(q =>
      init.channels.includes(q.channel) &&
      (init.complexity === 'any' || (init.complexity === 'simple' && q.complexity <= 0.35) ||
       (init.complexity === 'moderate' && q.complexity <= 0.55) ||
       (init.complexity === 'complex'))
    ).length;
    // BU targeting (default: all)
    if (!init.targetBUs) init.targetBUs = [...DEMO.bus];
  });

  // Clamp reductions (can't reduce below 0, max 50% per role for realism)
  Object.values(roleImpact).forEach(ri => {
    ri.yearly = ri.yearly.map(v => Math.min(v, ri.baseline * 0.50));
  });

  // Calculate totals per year
  const yearly = [];
  let cumSaving = 0;
  for (let yr = 0; yr < horizon; yr++) {
    const reduction = Object.values(roleImpact).reduce((s,ri) => s + ri.yearly[yr], 0);
    const annualBaseCost = DEMO.roles.reduce((s,r) => s + r.headcount * r.costPerFTE, 0);
    const saving = Object.entries(roleImpact).reduce((s, [role, ri]) => {
      const rObj = DEMO.roles.find(r => r.role === role);
      return s + ri.yearly[yr] * (rObj?.costPerFTE || 55000);
    }, 0);
    const inflatedCost = annualBaseCost * Math.pow(1 + DEMO.params.wageInflation, yr + 1);
    const futureCost = (annualBaseCost - saving) * Math.pow(1 + DEMO.params.wageInflation, yr + 1);
    const netSaving = inflatedCost - futureCost;
    cumSaving += netSaving;
    const npvFactor = 1 / Math.pow(1 + DEMO.params.discountRate, yr + 1);
    yearly.push({
      year: yr + 1,
      fteReduction: Math.round(reduction),
      finalFTE: DEMO.totalFTE - Math.round(reduction),
      annualSaving: netSaving,
      cumSaving,
      npv: netSaving * npvFactor,
      inflatedCost,
      futureCost
    });
  }

  const totalNPV = yearly.reduce((s,y) => s + y.npv, 0);
  const totalSaving = yearly.reduce((s,y) => s + y.annualSaving, 0);
  const totalReduction = yearly[horizon-1]?.fteReduction || 0;

  // Tech + change management investment estimate
  const techInvestment = (yearly[0]?.annualSaving || 0) * 0.45;
  const changeMgmt = techInvestment * 0.25;
  const training = techInvestment * 0.15;
  const contingency = techInvestment * 0.10;
  const totalInvestment = techInvestment + changeMgmt + training + contingency;
  const roi = totalInvestment > 0 ? ((totalNPV - totalInvestment) / totalInvestment * 100) : 0;
  const payback = totalInvestment > 0 ? totalInvestment / (yearly[0]?.annualSaving || 1) * 12 : 0;
  
  // IRR calculation (Newton's method approximation)
  let irr = 0;
  if (totalInvestment > 0 && yearly.length > 0) {
    const cashFlows = [-totalInvestment];
    for (let y = 0; y < horizon; y++) cashFlows.push(yearly[y]?.annualSaving || 0);
    let guess = 0.10;
    for (let iter = 0; iter < 50; iter++) {
      let npvCalc = 0, dnpv = 0;
      for (let t = 0; t < cashFlows.length; t++) {
        npvCalc += cashFlows[t] / Math.pow(1 + guess, t);
        dnpv -= t * cashFlows[t] / Math.pow(1 + guess, t + 1);
      }
      if (Math.abs(dnpv) < 1e-10) break;
      const step = npvCalc / dnpv;
      guess -= step;
      if (Math.abs(step) < 1e-6) break;
    }
    irr = Math.max(0, Math.min(guess * 100, 999));
  }

  // CR-018: Scenarios with descriptions
  const scenarios = {
    conservative: { mult: 0.70, label: 'Conservative', description: 'Lower adoption rates, higher costs, longer ramp-up' },
    base:         { mult: 1.00, label: 'Base Case', description: 'Expected values based on diagnostic findings' },
    aggressive:   { mult: 1.30, label: 'Aggressive', description: 'Higher adoption, faster ramp, optimistic deflection' },
  };
  Object.values(scenarios).forEach(sc => {
    sc.npv = totalNPV * sc.mult;
    sc.fteReduction = Math.round(totalReduction * sc.mult);
    sc.investment = totalInvestment * (sc.mult > 1 ? sc.mult * 0.85 : sc.mult * 1.1);
    sc.irr = irr * sc.mult;
    sc.roi = roi * sc.mult;
    sc.payback = sc.mult > 0 ? payback / sc.mult : 0;
    sc.annualSaving = (yearly[horizon-1]?.annualSaving || 0) * sc.mult;
  });

  // V6: Compute layer-level FTE and saving breakdowns (matches backend)
  const layerFTE = {'AI & Automation': 0, 'Operating Model': 0, 'Location Strategy': 0};
  const layerSaving = {'AI & Automation': 0, 'Operating Model': 0, 'Location Strategy': 0};
  enabledInits.forEach(i => {
    const layer = i.layer || 'AI & Automation';
    if (layer in layerFTE) {
      layerFTE[layer] += i._fteImpact || 0;
      layerSaving[layer] += i._annualSaving || 0;
    }
  });

  return {
    roleImpact, yearly, totalNPV, totalSaving, totalReduction,
    techInvestment, changeMgmt, training, contingency, totalInvestment,
    roi, payback, irr, scenarios, enabledInits, leverAccum,
    layerFTE, layerSaving
  };
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 2: PAGE 4 ‚Äî PERFORMANCE HEATMAP
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage4() {
  const el = document.getElementById('page-4');
  const metrics = ['CSAT','FCR','AHT','CPC','Repeat','Escalation','CES','Composite'];
  const metricKeys = { CSAT:'csat', FCR:'fcr', AHT:'aht', CPC:'cpc', Repeat:'repeat', Escalation:'escalation', CES:'ces' };
  const dirs = { CSAT:'higher', FCR:'higher', AHT:'lower', CPC:'lower', Repeat:'lower', Escalation:'lower', CES:'lower' };

  window._heatMetric = window._heatMetric || 'Composite';
  window._heatBU = window._heatBU || 'All';
  const selMetric = window._heatMetric;
  const selBU = window._heatBU;

  // Filter queues
  const filteredQ = selBU === 'All' ? DEMO.queues : DEMO.queues.filter(q => q.bu === selBU);

  // Helper functions (must be defined before sort logic)
  function cellScore(intent, channel) {
    const qs = filteredQ.filter(q => q.intent === intent && q.channel === channel);
    if (qs.length === 0) return null;
    const totalVol = qs.reduce((s,q) => s + q.volume, 0);
    if (selMetric === 'Composite') {
      return qs.reduce((s,q) => s + getQueueHealth(q) * q.volume, 0) / totalVol;
    }
    const key = metricKeys[selMetric];
    const avg = qs.reduce((s,q) => s + q[key] * q.volume, 0) / totalVol;
    const bm = getChannelBenchmark(channel, selMetric) || (DEMO.benchmarks[selMetric]||{}).global;
    return metricScoreNorm(avg, bm, dirs[selMetric]);
  }

  function rowScore(intent) {
    const qs = filteredQ.filter(q => q.intent === intent);
    if (qs.length === 0) return 0;
    const tv = qs.reduce((s,q) => s + q.volume, 0);
    return qs.reduce((s,q) => s + getQueueHealth(q) * q.volume, 0) / tv;
  }

  function colScore(channel) {
    const qs = filteredQ.filter(q => q.channel === channel);
    if (qs.length === 0) return 0;
    const tv = qs.reduce((s,q) => s + q.volume, 0);
    return qs.reduce((s,q) => s + getQueueHealth(q) * q.volume, 0) / tv;
  }

  // Sort mode (must be before intentList sort)
  window._heatSort = window._heatSort || 'default';
  const sortMode = window._heatSort;

  // Build intent √ó channel matrix
  let intentList = [...DEMO.intents];
  if (sortMode === 'worst') intentList.sort((a,b) => rowScore(a) - rowScore(b));
  else if (sortMode === 'best') intentList.sort((a,b) => rowScore(b) - rowScore(a));
  else if (sortMode === 'volume') intentList.sort((a,b) => {
    const va = filteredQ.filter(q => q.intent === a).reduce((s,q) => s + q.volume, 0);
    const vb = filteredQ.filter(q => q.intent === b).reduce((s,q) => s + q.volume, 0);
    return vb - va;
  });
  else if (sortMode === 'cost') intentList.sort((a,b) => {
    const ca = filteredQ.filter(q => q.intent === a).reduce((s,q) => s + q.volume * q.cpc, 0);
    const cb = filteredQ.filter(q => q.intent === b).reduce((s,q) => s + q.volume * q.cpc, 0);
    return cb - ca;
  });
  const channelList = DEMO.channels;

  el.innerHTML = `
    <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; align-items:center;">
      <span style="font-size:12px; font-weight:700; margin-right:4px;">Metric:</span>
      ${metrics.map(m => `<button class="btn btn-sm ${m === selMetric ? 'btn-primary' : 'btn-outline'}" onclick="window._heatMetric='${m}'; rendered[4]=false; renderPage4();">${m}</button>`).join('')}
      <span style="margin-left:16px; font-size:12px; font-weight:700;">BU:</span>
      ${['All', ...DEMO.bus].map(b => `<button class="btn btn-sm ${b === selBU ? 'btn-primary' : 'btn-outline'}" onclick="window._heatBU='${b}'; rendered[4]=false; renderPage4();">${b}</button>`).join('')}
    </div>
    <div style="display:flex; gap:6px; margin-bottom:8px; align-items:center;">
      <span style="font-size:11px; font-weight:700; color:var(--ey-text-light);">Sort:</span>
      ${[
        {key:'default', label:'Default'},
        {key:'worst', label:'Worst Performing ‚Üì'},
        {key:'best', label:'Best Performing ‚Üë'},
        {key:'volume', label:'Highest Volume ‚Üì'},
        {key:'cost', label:'Highest Cost ‚Üì'}
      ].map(s => `<button class="btn btn-sm ${sortMode===s.key?'btn-primary':'btn-outline'}" style="font-size:10px;padding:3px 8px;" onclick="window._heatSort='${s.key}';rendered[4]=false;renderPage4();">${s.label}</button>`).join('')}
    </div>
    <div class="card" style="overflow-x:auto;">
      <div class="card-title">üî• ${selMetric} by Channel √ó Intent ${selBU !== 'All' ? '(' + selBU + ')' : ''}</div>
      <div class="table-wrap" style="overflow-x:auto;">
      <table class="data-table" style="font-size:11px; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="min-width:100px; position:sticky; left:0; z-index:3; background:#fff;">Channel</th>
            ${intentList.map(intent => `<th style="min-width:38px;max-width:52px;text-align:center;padding:2px;vertical-align:bottom;height:110px;"><div style="writing-mode:vertical-rl;transform:rotate(180deg);font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-height:100px;">${intent}</div></th>`).join('')}
            <th style="min-width:50px; text-align:center;">Health</th>
          </tr>
        </thead>
        <tbody>
          ${channelList.map(ch => {
            const cs = colScore(ch);
            const cc = ragColor(cs);
            return `<tr>
              <td style="font-weight:600; font-size:11px; white-space:nowrap; position:sticky; left:0; background:#fff; z-index:2;">${ch}</td>
              ${intentList.map(intent => {
                const sc = cellScore(intent, ch);
                if (sc === null) return '<td style="text-align:center; color:var(--ey-text-light); padding:4px 2px;">‚Äî</td>';
                const c = ragColor(sc);
                return `<td style="text-align:center; background:${ragBgLight(c)}; cursor:pointer; padding:4px 2px;" onclick="showHeatDrillDown('${intent}','${ch}')"
                  ><span style="font-weight:700; color:${ragBg(c)}; font-size:10px;">${(sc*100).toFixed(0)}</span></td>`;
              }).join('')}
              <td style="text-align:center; background:${ragBgLight(cc)};"><strong style="color:${ragBg(cc)};">${(cs*100).toFixed(0)}</strong></td>
            </tr>`;
          }).join('')}
          <tr style="border-top:2px solid var(--ey-dark); font-weight:700;">
            <td style="position:sticky; left:0; background:#fff; z-index:2;">Intent Health</td>
            ${intentList.map(intent => {
              const rh = rowScore(intent);
              const rc = ragColor(rh);
              return `<td style="text-align:center; background:${ragBgLight(rc)};"><strong style="color:${ragBg(rc)}; font-size:10px;">${(rh*100).toFixed(0)}</strong></td>`;
            }).join('')}
            <td></td>
          </tr>
        </tbody>
      </table>
      </div>
    </div>
    <p style="font-size:11px; color:var(--ey-text-light); margin-top:8px;">Click any cell to drill down into all 8 metrics for that intent-channel combination. Scores are 0-100 where 100 = at or above benchmark.</p>
  `;
}

function showHeatDrillDown(intent, channel) {
  const qs = DEMO.queues.filter(q => q.intent === intent && q.channel === channel);
  if (qs.length === 0) return;
  const tv = qs.reduce((s,q)=>s+q.volume, 0);
  const agg = {};
  ['csat','fcr','aht','cpc','repeat','escalation','ces'].forEach(k => {
    agg[k] = qs.reduce((s,q)=>s+q[k]*q.volume, 0) / tv;
  });
  const bm = DEMO.benchmarks;
  const mNames = { csat:'CSAT', fcr:'FCR', aht:'AHT', cpc:'CPC', repeat:'Repeat Rate', escalation:'Escalation', ces:'CES' };
  const dirs = { csat:'higher', fcr:'higher', aht:'lower', cpc:'lower', repeat:'lower', escalation:'lower', ces:'lower' };
  const fmts = { csat:'dec', fcr:'%', aht:'min', cpc:'$', repeat:'%', escalation:'%', ces:'dec' };

  let html = `<table class="data-table"><thead><tr><th>Metric</th><th>Your Value</th><th>Benchmark</th><th>Gap</th><th>Status</th></tr></thead><tbody>`;
  Object.entries(mNames).forEach(([k, label]) => {
    const val = agg[k];
    const bmVal = getChannelBenchmark(channel, label === 'Repeat Rate' ? 'Repeat' : label) || (bm[label]||{}).global || bm[Object.keys(bm).find(bk => bk.toLowerCase() === k)]?.global;
    const score = metricScoreNorm(val, bmVal, dirs[k]);
    const c = ragColor(score);
    const gap = dirs[k] === 'higher' ? ((val - bmVal) / bmVal * 100) : ((bmVal - val) / bmVal * 100);
    html += `<tr>
      <td><strong>${label}</strong></td>
      <td>${fmt(val, fmts[k])}</td>
      <td>${fmt(bmVal, fmts[k])}</td>
      <td style="color:${ragBg(c)};">${gap >= 0 ? '+' : ''}${gap.toFixed(1)}%</td>
      <td><span class="badge badge-${c === 'green' ? 'low' : c === 'amber' ? 'medium' : 'critical'}">${c.toUpperCase()}</span></td>
    </tr>`;
  });
  html += `</tbody></table>
    <div style="margin-top:12px; font-size:12px; color:var(--ey-text-light);">
      Volume: <strong>${fmt(tv, 'int')}</strong> contacts/mo across <strong>${qs.length}</strong> BU(s) |
      Monthly Cost: <strong>${fmt(tv * agg.cpc, '$k')}/mo</strong>
    </div>`;
  openModal(`${intent} ‚Üí ${channel}`, html);
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 2: PAGE 5 ‚Äî FRICTION MAP
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage5() {
  const el = document.getElementById('page-5');
  const qs = DEMO.queues;
  const totalVol = DEMO.totalVolume;
  const medVol = [...qs].sort((a,b) => a.volume - b.volume)[Math.floor(qs.length/2)].volume;

  // Friction score = 0.35*repeat + 0.25*escalation + 0.25*(ces/5) + 0.15*(1-fcr)
  const scored = qs.map(q => ({
    ...q,
    friction: 0.35 * q.repeat / 0.40 + 0.25 * q.escalation / 0.30 + 0.25 * (q.ces / 5) + 0.15 * (1 - q.fcr),
    isHotspot: false
  }));
  scored.forEach(q => { q.isHotspot = q.friction > 0.60 && q.volume > medVol; });

  const hotspots = scored.filter(q => q.isHotspot).sort((a,b) => b.friction - a.friction);
  const topEsc = [...scored].sort((a,b) => b.escalation - a.escalation).slice(0, 10);
  const topRepeat = [...scored].sort((a,b) => b.repeat - a.repeat).slice(0, 10);

  el.innerHTML = `
    <div class="grid-2">
      <div class="card">
        <div class="card-title">üî¥ Friction Hotspots <span style="font-size:11px; font-weight:400; color:var(--ey-text-light);">(friction > 0.60 AND vol > median)</span></div>
        <div class="table-wrap"><table class="data-table" style="font-size:11px;">
          <thead><tr><th>Intent</th><th>Channel</th><th>BU</th><th>Friction (/1.0)</th><th>Volume (/mo)</th><th>Repeat Rate</th><th>Escalation Rate</th><th>CES (/5)</th></tr></thead>
          <tbody>
            ${hotspots.length === 0 ? '<tr><td colspan="8" style="text-align:center;">No hotspots detected</td></tr>' :
              hotspots.slice(0,15).map(q => `<tr>
              <td>${q.intent}</td><td>${q.channel}</td><td>${q.bu}</td>
              <td><strong style="color:var(--ey-red);">${q.friction.toFixed(2)}</strong> <span style="font-size:9px;color:var(--ey-text-light);">/1.0</span></td>
              <td>${fmt(q.volume,'int')}</td>
              <td>${fmt(q.repeat,'%')}</td>
              <td>${fmt(q.escalation,'%')}</td>
              <td>${q.ces.toFixed(1)} <span style="font-size:9px;color:var(--ey-text-light);">/5</span></td>
            </tr>`).join('')}
          </tbody>
        </table></div>
      </div>
      <div class="card">
        <div class="card-title">üìä Friction Score Distribution</div>
        <canvas id="frictionBubble" width="500" height="350"></canvas>
        <p style="font-size:10px; color:var(--ey-text-light); margin-top:4px;">Bubble size = volume. Red = hotspot. X = repeat rate. Y = escalation rate.</p>
      </div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="card-title">üîÅ Top 10 Repeat Contact Queues</div>
        <div class="table-wrap"><table class="data-table" style="font-size:11px;">
          <thead><tr><th>Intent</th><th>Channel</th><th>Repeat Rate</th><th>Volume (/mo)</th><th>Repeat Contacts (/mo)</th></tr></thead>
          <tbody>
            ${topRepeat.map(q => `<tr>
              <td>${q.intent}</td><td>${q.channel}</td>
              <td><strong style="color:${q.repeat > 0.20 ? 'var(--ey-red)' : q.repeat > 0.12 ? 'var(--ey-amber)' : 'var(--ey-green)'};">${fmt(q.repeat,'%')}</strong></td>
              <td>${fmt(q.volume,'int')}</td>
              <td>${fmt(Math.round(q.volume * q.repeat),'int')}</td>
            </tr>`).join('')}
          </tbody>
        </table></div>
      </div>
      <div class="card">
        <div class="card-title">‚¨ÜÔ∏è Top 10 Escalation Queues</div>
        <div class="table-wrap"><table class="data-table" style="font-size:11px;">
          <thead><tr><th>Intent</th><th>Channel</th><th>Escalation Rate</th><th>Volume (/mo)</th><th>Escalated (/mo)</th></tr></thead>
          <tbody>
            ${topEsc.map(q => `<tr>
              <td>${q.intent}</td><td>${q.channel}</td>
              <td><strong style="color:${q.escalation > 0.15 ? 'var(--ey-red)' : q.escalation > 0.08 ? 'var(--ey-amber)' : 'var(--ey-green)'};">${fmt(q.escalation,'%')}</strong></td>
              <td>${fmt(q.volume,'int')}</td>
              <td>${fmt(Math.round(q.volume * q.escalation),'int')}</td>
            </tr>`).join('')}
          </tbody>
        </table></div>
      </div>
    </div>
  `;

  // Draw bubble chart
  drawFrictionBubble(scored);

  // So What box
  const soWhatCard = document.createElement('div');
  soWhatCard.className = 'card';
  soWhatCard.style.cssText = 'background:linear-gradient(135deg,#FFFDE7,#FFF8E1);border:2px solid var(--ey-yellow);';
  const hotspotCost = hotspots.reduce((s,q) => s + q.volume * q.cpc * q.friction, 0);
  soWhatCard.innerHTML = `
    <div style="display:flex;align-items:flex-start;gap:12px;">
      <div style="font-size:28px;">üí°</div>
      <div>
        <div style="font-weight:800;font-size:14px;margin-bottom:4px;">Friction Reduction Recommendation</div>
        <div style="font-size:12px;color:var(--ey-text);line-height:1.5;">
          <strong>${hotspots.length} friction hotspots</strong> identified ‚Äî these drive ~<strong>${fmt(hotspotCost * 12, '$m')}/yr</strong> in wasted cost through repeat contacts, escalations, and channel switching.
          Top escalation driver: <strong>${topEsc[0]?.intent || '‚Äî'} via ${topEsc[0]?.channel || '‚Äî'}</strong> (${fmt(topEsc[0]?.escalation || 0, '%')} escalation rate).
          <strong>Priority actions:</strong> Fix the top 10 hotspots first ‚Äî they represent a disproportionate share of customer effort and cost leakage.
        </div>
      </div>
    </div>
  `;
  el.appendChild(soWhatCard);
}

function drawFrictionBubble(scored) {
  const canvas = document.getElementById('frictionBubble');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = 500, H = 350, pad = 50;
  ctx.clearRect(0, 0, W, H);

  const maxRepeat = Math.max(...scored.map(q => q.repeat)) * 1.1;
  const maxEsc = Math.max(...scored.map(q => q.escalation)) * 1.1;
  const maxVol = Math.max(...scored.map(q => q.volume));

  // Axes
  ctx.strokeStyle = '#E0E0E6'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(W-10, H-pad); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(pad, 10); ctx.stroke();
  ctx.fillStyle = '#747480'; ctx.font = '10px sans-serif';
  ctx.textAlign = 'center'; ctx.fillText('Repeat Rate ‚Üí', W/2, H-8);
  ctx.save(); ctx.translate(12, H/2); ctx.rotate(-Math.PI/2); ctx.fillText('Escalation Rate ‚Üí', 0, 0); ctx.restore();

  // Bubbles
  scored.forEach(q => {
    const x = pad + (q.repeat / maxRepeat) * (W - pad - 20);
    const y = (H - pad) - (q.escalation / maxEsc) * (H - pad - 20);
    const r = Math.max(3, Math.min(18, (q.volume / maxVol) * 18));
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fillStyle = q.isHotspot ? 'rgba(197,0,62,0.5)' : 'rgba(26,115,232,0.25)';
    ctx.fill();
    ctx.strokeStyle = q.isHotspot ? '#C5003E' : '#1A73E8';
    ctx.lineWidth = q.isHotspot ? 2 : 1;
    ctx.stroke();
  });
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 2: PAGE 6 ‚Äî GAP ANALYSIS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage6() {
  const el = document.getElementById('page-6');
  const qs = DEMO.queues.map(q => ({
    ...q,
    health: getQueueHealth(q),
    mismatch: q.complexity > 0.5 && q.capability < 0.5 ? 'Failure Zone' :
              q.complexity < 0.3 && q.capability > 0.7 ? 'Overspend Zone' :
              Math.abs(q.complexity - (1-q.capability)) > 0.3 ? 'Misaligned' : 'Aligned'
  }));

  const failureZone = qs.filter(q => q.mismatch === 'Failure Zone').sort((a,b) => a.health - b.health);
  const overspend = qs.filter(q => q.mismatch === 'Overspend Zone');
  const misaligned = qs.filter(q => q.mismatch === 'Misaligned');

  // Root cause analysis ‚Äî for red queues, which metric is worst?
  const redQueues = qs.filter(q => q.health < 0.70).sort((a,b) => a.health - b.health).slice(0, 15);
  const rootCauses = redQueues.map(q => {
    const bm = DEMO.benchmarks;
    const scores = [
      { metric: 'CSAT', score: metricScoreNorm(q.csat, (bm.CSAT||{}).global, 'higher') },
      { metric: 'FCR', score: metricScoreNorm(q.fcr, (bm.FCR||{}).global, 'higher') },
      { metric: 'AHT', score: metricScoreNorm(q.aht, (bm.AHT||{}).global, 'lower') },
      { metric: 'CPC', score: metricScoreNorm(q.cpc, (bm.CPC||{}).global, 'lower') },
      { metric: 'Repeat', score: metricScoreNorm(q.repeat, (bm.Repeat||{}).global, 'lower') },
    ];
    scores.sort((a,b) => a.score - b.score);
    return { ...q, primaryDriver: scores[0].metric, driverScore: scores[0].score };
  });

  el.innerHTML = `
    <div class="grid-2">
      <div class="card">
        <div class="card-title">üî¨ Complexity vs Capability Scatter</div>
        <canvas id="gapScatter" width="500" height="400"></canvas>
        <p style="font-size:10px; color:var(--ey-text-light);">Size = volume, Colour = health. Top-left = overspend, Bottom-right = failure zone.</p>
      </div>
      <div class="card">
        <div class="card-title">üìä Mismatch Summary</div>
        <div class="kpi-row" style="grid-template-columns:repeat(3,1fr); margin-bottom:16px;">
          <div class="kpi-card" style="border-left-color:var(--ey-red);"><div class="kpi-value" style="color:var(--ey-red);">${failureZone.length}</div><div class="kpi-label">Failure Zone</div></div>
          <div class="kpi-card" style="border-left-color:var(--ey-amber);"><div class="kpi-value" style="color:var(--ey-amber);">${overspend.length}</div><div class="kpi-label">Overspend Zone</div></div>
          <div class="kpi-card" style="border-left-color:var(--ey-blue);"><div class="kpi-value" style="color:var(--ey-blue);">${misaligned.length}</div><div class="kpi-label">Misaligned</div></div>
        </div>
        <div class="table-wrap"><table class="data-table" style="font-size:11px;">
          <thead><tr><th>Intent</th><th>Channel</th><th>Mismatch</th><th>Complexity</th><th>Capability</th><th>Health</th></tr></thead>
          <tbody>
            ${failureZone.concat(overspend).slice(0,12).map(q => `<tr>
              <td>${q.intent}</td><td>${q.channel}</td>
              <td><span class="badge badge-${q.mismatch === 'Failure Zone' ? 'critical' : 'medium'}">${q.mismatch}</span></td>
              <td>${q.complexity.toFixed(2)} <span style="font-size:9px;color:var(--ey-text-light);">/1.0</span></td><td>${q.capability.toFixed(2)} <span style="font-size:9px;color:var(--ey-text-light);">/1.0</span></td>
              <td style="color:${ragBg(ragColor(q.health))}; font-weight:700;">${(q.health*100).toFixed(0)}</td>
            </tr>`).join('')}
          </tbody>
        </table></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">üîç Root Cause Analysis (Red Queues ‚Äî Primary Performance Driver)</div>
      <div class="table-wrap"><table class="data-table" style="font-size:11px;">
        <thead><tr><th>Intent</th><th>Channel</th><th>BU</th><th>Health</th><th>Primary Driver</th><th>Driver Score</th><th>Recommended Lever</th></tr></thead>
        <tbody>
          ${rootCauses.map(q => {
            const leverMap = { AHT:'aht_reduction', FCR:'repeat_reduction', CPC:'cost_reduction', Repeat:'repeat_reduction', CSAT:'escalation_reduction' };
            return `<tr>
              <td>${q.intent}</td><td>${q.channel}</td><td>${q.bu}</td>
              <td style="color:var(--ey-red); font-weight:700;">${(q.health*100).toFixed(0)}</td>
              <td><span class="badge badge-critical">${q.primaryDriver}</span></td>
              <td>${(q.driverScore*100).toFixed(0)}%</td>
              <td style="font-size:11px;">${leverMap[q.primaryDriver] || 'deflection'}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table></div>
    </div>
  `;

  drawGapScatter(qs);
}

function drawGapScatter(qs) {
  const canvas = document.getElementById('gapScatter');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = 500, H = 400, pad = 50;
  ctx.clearRect(0, 0, W, H);

  // Quadrant shading
  const midX = pad + (W - pad - 10) * 0.5;
  const midY = pad + (H - pad - pad) * 0.5;
  ctx.fillStyle = 'rgba(197,0,62,0.05)'; ctx.fillRect(midX, midY, W-midX-10, H-pad-midY); // bottom-right = failure
  ctx.fillStyle = 'rgba(255,183,0,0.05)'; ctx.fillRect(pad, pad, midX-pad, midY-pad); // top-left = overspend

  // Labels
  ctx.font = '10px sans-serif'; ctx.fillStyle = 'rgba(197,0,62,0.4)';
  ctx.textAlign = 'center'; ctx.fillText('FAILURE ZONE', (midX + W - 10)/2, H - pad - 10);
  ctx.fillStyle = 'rgba(217,119,6,0.4)'; ctx.fillText('OVERSPEND ZONE', (pad + midX)/2, pad + 15);

  // Axes
  ctx.strokeStyle = '#E0E0E6'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(W-10, H-pad); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(pad, pad); ctx.stroke();
  ctx.fillStyle = '#747480'; ctx.font = '10px sans-serif';
  ctx.textAlign = 'center'; ctx.fillText('Intent Complexity ‚Üí', W/2, H-8);
  ctx.save(); ctx.translate(12, H/2); ctx.rotate(-Math.PI/2); ctx.fillText('Channel Capability ‚Üí', 0, 0); ctx.restore();

  // Dots
  const maxVol = Math.max(...qs.map(q => q.volume));
  qs.forEach(q => {
    const x = pad + q.complexity * (W - pad - 20);
    const y = (H - pad) - q.capability * (H - pad - pad);
    const r = Math.max(3, Math.min(14, (q.volume / maxVol) * 14));
    const c = q.health;
    const color = c >= 0.9 ? 'rgba(22,135,54,0.5)' : c >= 0.7 ? 'rgba(217,119,6,0.4)' : 'rgba(197,0,62,0.4)';
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2);
    ctx.fillStyle = color; ctx.fill();
  });
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 2: PAGE 7 ‚Äî COST ANALYSIS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage7() {
  const el = document.getElementById('page-7');

  // Cost by intent
  const intentCosts = DEMO.intents.map(intent => {
    const qs = DEMO.queues.filter(q => q.intent === intent);
    const cost = qs.reduce((s,q) => s + q.volume * q.cpc, 0);
    const vol = qs.reduce((s,q) => s + q.volume, 0);
    return { intent, cost, vol, cpc: vol > 0 ? cost/vol : 0 };
  }).sort((a,b) => b.cost - a.cost);

  // Cost by channel
  const channelCosts = DEMO.channels.map(ch => {
    const qs = DEMO.queues.filter(q => q.channel === ch);
    const cost = qs.reduce((s,q) => s + q.volume * q.cpc, 0);
    const vol = qs.reduce((s,q) => s + q.volume, 0);
    return { channel: ch, cost, vol, cpc: vol > 0 ? cost/vol : 0 };
  }).sort((a,b) => b.cost - a.cost);

  const totalCost = DEMO.queues.reduce((s,q) => s + q.volume * q.cpc, 0);

  // Top 10 most expensive queues
  const topQueues = [...DEMO.queues].map(q => ({...q, monthlyCost: q.volume * q.cpc, health: getQueueHealth(q)}))
    .sort((a,b) => b.monthlyCost - a.monthlyCost).slice(0, 10);

  // Wasted spend (red queues)
  const wastedSpend = DEMO.queues.filter(q => getQueueHealth(q) < 0.70)
    .reduce((s,q) => s + q.volume * q.cpc, 0);

  el.innerHTML = `
    <div class="kpi-row" style="grid-template-columns:repeat(4,1fr); margin-bottom:16px;">
      <div class="kpi-card" style="border-left-color:var(--ey-blue);"><div class="kpi-value">${fmt(totalCost,'$m')}</div><div class="kpi-label">Total Monthly Contact Cost</div></div>
      <div class="kpi-card" style="border-left-color:var(--ey-amber);"><div class="kpi-value">${fmt(totalCost/DEMO.totalVolume,'$')}</div><div class="kpi-label">Blended CPC</div></div>
      <div class="kpi-card" style="border-left-color:var(--ey-red);"><div class="kpi-value">${fmt(wastedSpend,'$m')}</div><div class="kpi-label">Wasted Spend (Red Queues)</div></div>
      <div class="kpi-card" style="border-left-color:var(--ey-green);"><div class="kpi-value">${fmt(wastedSpend/totalCost*100,'dec')}%</div><div class="kpi-label">% Wasted</div></div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="card-title">üí∞ Monthly Cost by Intent</div>
        <canvas id="costByIntent" width="500" height="340"></canvas>
      </div>
      <div class="card">
        <div class="card-title">üì° Cost per Contact by Channel</div>
        <canvas id="cpcByChannel" width="500" height="340"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="card-title">üèÜ Top 10 Most Expensive Queue Combinations</div>
      <div class="table-wrap"><table class="data-table" style="font-size:11px;">
        <thead><tr><th>#</th><th>Intent</th><th>Channel</th><th>BU</th><th>Cost ($/mo)</th><th>% of Total</th><th>CPC ($/contact)</th><th>Volume (/mo)</th><th>Health (/100)</th></tr></thead>
        <tbody>
          ${topQueues.map((q,i) => `<tr>
            <td>${i+1}</td><td>${q.intent}</td><td>${q.channel}</td><td>${q.bu}</td>
            <td style="font-weight:700;">${fmt(q.monthlyCost,'$k')}</td>
            <td>${(q.monthlyCost/totalCost*100).toFixed(1)}%</td>
            <td>${fmt(q.cpc,'$')}<span style="font-size:9px;color:var(--ey-text-light);">/contact</span></td>
            <td>${fmt(q.volume,'int')}</td>
            <td style="color:${ragBg(ragColor(q.health))}; font-weight:700;">${(q.health*100).toFixed(0)}</td>
          </tr>`).join('')}
        </tbody>
      </table></div>
    </div>
  `;

  drawHorizBars('costByIntent', intentCosts.slice(0,10).map(c => ({label: c.intent.substring(0,18), value: c.cost})), '$k');
  drawHorizBars('cpcByChannel', channelCosts.map(c => ({label: c.channel.split('/')[0], value: c.cpc})), '$');
}

function drawHorizBars(canvasId, data, fmtType) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);
  const pad = { l:120, r:60, t:10, b:20 };
  const maxVal = Math.max(...data.map(d => d.value));
  const barH = Math.min(28, (H - pad.t - pad.b) / data.length - 4);

  data.forEach((d, i) => {
    const y = pad.t + i * (barH + 4);
    const w = (d.value / maxVal) * (W - pad.l - pad.r);
    // Label
    ctx.fillStyle = '#2E2E38'; ctx.font = '11px sans-serif'; ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
    ctx.fillText(d.label, pad.l - 8, y + barH/2);
    // Bar
    const pct = d.value / maxVal;
    ctx.fillStyle = pct > 0.75 ? '#C5003E' : pct > 0.5 ? '#D97706' : '#168736';
    ctx.fillRect(pad.l, y, w, barH);
    // Value
    ctx.fillStyle = '#2E2E38'; ctx.textAlign = 'left'; ctx.font = '11px sans-serif';
    ctx.fillText(fmt(d.value, fmtType), pad.l + w + 6, y + barH/2);
  });
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 3: PAGE 8 ‚Äî SELF-SERVICE FEASIBILITY
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage8() {
  const el = document.getElementById('page-8');

  const intentFeasibility = DEMO.intents.map(intent => {
    const qs = DEMO.queues.filter(q => q.intent === intent);
    const tv = qs.reduce((s,q) => s + q.volume, 0);
    const cmplx = DEMO.intentComplexity[intent];
    const ssVol = qs.filter(q => ['App/Self-Service','IVR','SMS/WhatsApp'].includes(q.channel)).reduce((s,q) => s + q.volume, 0);
    const ssPct = tv > 0 ? ssVol / tv : 0;
    const feasibility = Math.max(0, Math.min(100, (1 - cmplx) * 80 + (cmplx < 0.3 ? 15 : cmplx < 0.5 ? 5 : -5)));
    const deflectionPotential = Math.min(0.60, feasibility / 100 * 0.6);
    const avgCPC = qs.reduce((s,q) => s + q.cpc * q.volume, 0) / (tv || 1);
    const savingPotential = tv * deflectionPotential * (avgCPC - 1.20); // SS CPC ~$1.20

    return { intent, complexity: cmplx, feasibility, ssPct, deflectionPotential, volume: tv, savingPotential, avgCPC };
  }).sort((a,b) => b.feasibility - a.feasibility);

  const totalSavingOpp = intentFeasibility.filter(i => i.feasibility >= 40).reduce((s,i) => s + Math.max(0, i.savingPotential), 0);
  const humanEssential = intentFeasibility.filter(i => i.feasibility < 30);

  el.innerHTML = `
    <div class="kpi-row" style="grid-template-columns:repeat(3,1fr); margin-bottom:16px;">
      <div class="kpi-card" style="border-left-color:var(--ey-green);"><div class="kpi-value">${intentFeasibility.filter(i=>i.feasibility>=60).length}</div><div class="kpi-label">High Feasibility Intents</div></div>
      <div class="kpi-card" style="border-left-color:var(--ey-red);"><div class="kpi-value">${humanEssential.length}</div><div class="kpi-label">Human-Essential Intents</div></div>
      <div class="kpi-card" style="border-left-color:var(--ey-blue);"><div class="kpi-value">${fmt(totalSavingOpp * 12,'$m')}<span style="font-size:11px;font-weight:400;">/yr</span></div><div class="kpi-label">Annual Savings Opportunity</div></div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="card-title">ü§ñ Self-Service Feasibility Scoring</div>
        <div class="table-wrap"><table class="data-table" style="font-size:11px;">
          <thead><tr><th>Intent</th><th>Complexity</th><th>Feasibility</th><th>Current SS %</th><th>Deflection Potential</th><th>Monthly Saving</th></tr></thead>
          <tbody>
            ${intentFeasibility.map(i => {
              const fc = i.feasibility >= 60 ? 'green' : i.feasibility >= 40 ? 'amber' : 'red';
              return `<tr>
                <td>${i.intent}</td>
                <td>${i.complexity.toFixed(2)} <span style="font-size:9px;color:var(--ey-text-light);">/1.0</span></td>
                <td><div style="display:flex;align-items:center;gap:6px;"><div style="width:60px;height:8px;background:var(--ey-mid-gray);border-radius:4px;overflow:hidden;"><div style="width:${i.feasibility}%;height:100%;background:${ragBg(fc)};border-radius:4px;"></div></div><strong style="color:${ragBg(fc)};">${i.feasibility.toFixed(0)}%</strong></div></td>
                <td>${fmt(i.ssPct,'%')}</td>
                <td>${fmt(i.deflectionPotential,'%')}</td>
                <td style="color:var(--ey-green);font-weight:700;">${i.savingPotential > 0 ? fmt(i.savingPotential,'$k') : '‚Äî'}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table></div>
      </div>
      <div class="card">
        <div class="card-title">üìç Feasibility vs Volume (Prioritise Top-Right)</div>
        <canvas id="feasibilityQuad" width="500" height="400"></canvas>
      </div>
    </div>
    ${humanEssential.length > 0 ? `
    <div class="card" style="border:2px solid var(--ey-red);">
      <div class="card-title">üö´ Must-Stay-Human List (Feasibility < 30%)</div>
      <div style="font-size:12px;color:var(--ey-text);margin-bottom:12px;">These intents require human empathy, complex judgment, or regulatory compliance. <strong>Do not automate</strong> ‚Äî instead invest in agent assist tools to improve handle time and resolution.</div>
      <table class="data-table" style="font-size:11px;">
        <thead><tr><th>Intent</th><th>Feasibility</th><th>Volume/mo</th><th>Why Human-Essential</th><th>Recommended Approach</th></tr></thead>
        <tbody>
          ${humanEssential.map(i => {
            const reason = i.complexity > 0.7 ? 'High complexity, multi-step resolution' :
                           i.intent.toLowerCase().includes('complaint') ? 'Emotional handling, empathy required' :
                           i.intent.toLowerCase().includes('fraud') ? 'Regulatory/compliance, human verification' :
                           i.intent.toLowerCase().includes('escalat') ? 'Already escalated, needs authority' :
                           'Complex judgment, edge cases';
            const approach = i.complexity > 0.7 ? 'AI Agent Assist + knowledge base' :
                             'Sentiment routing + specialist queue';
            return `<tr>
              <td><strong>${i.intent}</strong></td>
              <td><span class="badge badge-critical">${i.feasibility.toFixed(0)}%</span></td>
              <td>${(i.volume/1000).toFixed(1)}K<span style="font-size:9px;color:var(--ey-text-light);">/mo</span></td>
              <td style="font-size:10px;">${reason}</td>
              <td style="font-size:10px;color:var(--ey-blue);">${approach}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>` : ''}

    <!-- So What Recommendation -->
    <div class="card" style="background:linear-gradient(135deg,#FFFDE7,#FFF8E1);border:2px solid var(--ey-yellow);">
      <div style="display:flex;align-items:flex-start;gap:12px;">
        <div style="font-size:28px;">üí°</div>
        <div>
          <div style="font-weight:800;font-size:14px;margin-bottom:4px;">Automation Strategy Recommendation</div>
          <div style="font-size:12px;color:var(--ey-text);line-height:1.5;">
            <strong>${intentFeasibility.filter(i=>i.feasibility>=60).length} intents</strong> (${(intentFeasibility.filter(i=>i.feasibility>=60).reduce((s,i)=>s+i.volume,0)/intentFeasibility.reduce((s,i)=>s+i.volume,0)*100).toFixed(0)}% of volume) are strong automation candidates, representing <strong>${fmt(totalSavingOpp * 12,'$m')}/yr</strong> in savings.
            ${humanEssential.length} intents must remain human-handled ‚Äî invest in agent assist and knowledge management for these.
            <strong>Quick win:</strong> Start with the ${intentFeasibility.filter(i => i.feasibility >= 60 && i.volume > intentFeasibility.reduce((s,i)=>s+i.volume,0)/intentFeasibility.length).length} high-feasibility, high-volume intents for maximum day-1 impact.
          </div>
        </div>
      </div>
    </div>
  `;

  // Quadrant chart
  drawFeasibilityQuad(intentFeasibility);
}

function drawFeasibilityQuad(data) {
  const canvas = document.getElementById('feasibilityQuad');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = 500, H = 400, pad = 50;
  ctx.clearRect(0, 0, W, H);
  const maxVol = Math.max(...data.map(d => d.volume));

  // Quadrant shading
  const midX = pad + (W-pad-10)*0.5, midY = pad + (H-pad-pad)*0.5;
  ctx.fillStyle = 'rgba(22,135,54,0.06)'; ctx.fillRect(midX, pad, W-midX-10, midY-pad); // top-right = automate first

  ctx.strokeStyle = '#E0E0E6'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(W-10, H-pad); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(pad, pad); ctx.stroke();
  ctx.fillStyle = '#747480'; ctx.font = '10px sans-serif';
  ctx.textAlign = 'center'; ctx.fillText('Volume ‚Üí', W/2, H-8);
  ctx.save(); ctx.translate(12, H/2); ctx.rotate(-Math.PI/2); ctx.fillText('Feasibility Score ‚Üí', 0, 0); ctx.restore();
  ctx.fillStyle = 'rgba(22,135,54,0.3)'; ctx.fillText('‚¨Ü AUTOMATE FIRST', (midX+W-10)/2, pad+15);

  data.forEach(d => {
    const x = pad + (d.volume / maxVol) * (W - pad - 20);
    const y = (H - pad) - (d.feasibility / 100) * (H - pad - pad);
    const r = Math.max(5, (d.savingPotential > 0 ? d.savingPotential : 1000) / Math.max(...data.map(dd => dd.savingPotential || 1)) * 15);
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2);
    ctx.fillStyle = d.feasibility >= 60 ? 'rgba(22,135,54,0.4)' : d.feasibility >= 40 ? 'rgba(217,119,6,0.3)' : 'rgba(197,0,62,0.3)';
    ctx.fill();
    if (d.feasibility >= 50) {
      ctx.fillStyle = '#2E2E38'; ctx.font = '9px sans-serif'; ctx.textAlign = 'center';
      ctx.fillText(d.intent.substring(0,12), x, y - r - 3);
    }
  });
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 3: PAGE 9 ‚Äî INITIATIVE ROADMAP
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage9() {
  const el = document.getElementById('page-9');
  const inits = INITIATIVES;
  const layers = ['AI & Automation', 'Operating Model', 'Location Strategy'];
  const layerColors = { 'AI & Automation': '#1A73E8', 'Operating Model': '#168736', 'Location Strategy': '#D97706' };
  const enabledInits = inits.filter(i => i.enabled);
  const totalSaving = enabledInits.reduce((s,i) => s + (i._annualSaving||0), 0);
  const totalFTE = enabledInits.reduce((s,i) => s + (i._fteImpact||0), 0);
  const savedLayer = window._activeInitLayer || 'all';

  el.innerHTML = `
    <div class="kpi-row" id="initKpiRow" style="grid-template-columns:repeat(6,1fr); margin-bottom:16px;">
      <div class="kpi-card" id="kpiAI" style="border-left-color:#1A73E8;"><div class="kpi-value">${inits.filter(i=>i.layer==='AI & Automation' && i.enabled).length}<span style="font-size:12px;color:var(--ey-text-light);">/${inits.filter(i=>i.layer==='AI & Automation').length}</span></div><div class="kpi-label">AI & Automation</div></div>
      <div class="kpi-card" id="kpiOp" style="border-left-color:#168736;"><div class="kpi-value">${inits.filter(i=>i.layer==='Operating Model' && i.enabled).length}<span style="font-size:12px;color:var(--ey-text-light);">/${inits.filter(i=>i.layer==='Operating Model').length}</span></div><div class="kpi-label">Operating Model</div></div>
      <div class="kpi-card" id="kpiLoc" style="border-left-color:#D97706;"><div class="kpi-value">${inits.filter(i=>i.layer==='Location Strategy' && i.enabled).length}<span style="font-size:12px;color:var(--ey-text-light);">/${inits.filter(i=>i.layer==='Location Strategy').length}</span></div><div class="kpi-label">Location Strategy</div></div>
      <div class="kpi-card" id="kpiActive" style="border-left-color:var(--ey-green);"><div class="kpi-value">${enabledInits.length}<span style="font-size:12px;color:var(--ey-text-light);">/${inits.length}</span></div><div class="kpi-label">Active</div></div>
      <div class="kpi-card" id="kpiFTE" style="border-left-color:var(--ey-green);"><div class="kpi-value" style="color:var(--ey-green);">‚àí${totalFTE.toFixed(0)} <span style="font-size:11px;font-weight:400;">FTE</span></div><div class="kpi-label">Total FTE Impact</div></div>
      <div class="kpi-card" id="kpiSaving" style="border-left-color:var(--ey-green);"><div class="kpi-value" style="color:var(--ey-green);">${fmt(totalSaving,'$m')}<span style="font-size:11px;font-weight:400;">/yr</span></div><div class="kpi-label">Total Annual Saving</div></div>
    </div>

    <!-- So-What Box -->
    <div class="card" style="background:linear-gradient(135deg,#FFFDE7,#FFF8E1);border:2px solid var(--ey-yellow);margin-bottom:16px;">
      <div style="display:flex;align-items:flex-start;gap:12px;">
        <div style="font-size:28px;">üí°</div>
        <div>
          <div style="font-weight:800;font-size:14px;margin-bottom:4px;">Smart Recommendation Engine</div>
          <div style="font-size:12px;color:var(--ey-text);">
            Based on your diagnostic data, <strong>${enabledInits.length} of ${inits.length} initiatives</strong> are recommended
            (relevance score ‚â• ${RELEVANCE_THRESHOLD}/100).
            ${inits.filter(i => !i.enabled).length > 0 ? `<strong>${inits.filter(i => !i.enabled).length} initiatives</strong> were excluded ‚Äî they don't match your channels, pain points, or volume profile.` : ''}
            Enabled initiatives can deliver
            <strong>${fmt(totalSaving,'$m')}/yr</strong> in savings with <strong>${totalFTE.toFixed(0)} FTE</strong> reduction.
            ${(() => {
              const quickWins = enabledInits.filter(i => i.effort === 'low' && i.startMonth <= 3);
              return quickWins.length > 0 ? `<strong>${quickWins.length} quick wins</strong> (low effort, immediate start) should be prioritized for first 90 days.` : '';
            })()}
            Top 3 initiatives contribute <strong>${((enabledInits.sort((a,b)=>(b._annualSaving||0)-(a._annualSaving||0)).slice(0,3).reduce((s,i)=>s+(i._annualSaving||0),0)/totalSaving)*100).toFixed(0)}%</strong> of total value ‚Äî focus execution here first.
            <br><span style="color:var(--ey-text-light);font-size:11px;">Open the Initiative Library to browse all options, see match reasoning, or add your own.</span>
          </div>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="openInitLibrary()" style="padding:8px 16px;">üìö Initiative Library</button>
      <button class="btn btn-primary" onclick="addCustomInitiative()" style="padding:8px 16px;">‚ûï Add Custom Initiative</button>
      <button class="btn btn-outline" onclick="toggleAllInits(true)" style="padding:8px 12px;font-size:11px;">‚úÖ Enable All</button>
      <button class="btn btn-outline" onclick="toggleAllInits(false)" style="padding:8px 12px;font-size:11px;">‚¨ú Disable All</button>
      <button class="btn btn-outline" onclick="enableOnlyRecommended()" style="padding:8px 12px;font-size:11px;">üéØ Recommended Only</button>
      <select id="initLayerFilter" onchange="filterInitLayer(this.value)" style="padding:8px 12px;font-size:11px;border:1.5px solid var(--ey-mid-gray);border-radius:6px;">
        <option value="all" ${savedLayer==='all'?'selected':''}>All Layers</option>
        ${layers.map(l => `<option value="${l}" ${savedLayer===l?'selected':''}>${l}</option>`).join('')}
      </select>
    </div>

    ${layers.map(layer => {
      const layerInits = inits.filter(i => i.layer === layer);
      const layerEnabled = layerInits.filter(i => i.enabled);
      const layerSaving = layerEnabled.reduce((s,i) => s + (i._annualSaving||0), 0);
      return `
      <div class="card layer-section" data-layer="${layer}" style="margin-bottom:12px;">
        <div class="card-title" style="cursor:pointer;display:flex;align-items:center;gap:8px;" onclick="this.parentElement.querySelector('.layer-body').classList.toggle('hidden')">
          <span style="width:14px;height:14px;border-radius:3px;background:${layerColors[layer]};display:inline-block;"></span>
          ${layer}
          <span style="font-size:11px;font-weight:400;color:var(--ey-text-light);">${layerEnabled.length}/${layerInits.length} active ¬∑ ${fmt(layerSaving,'$k')}/yr</span>
          <span style="margin-left:auto;font-size:10px;">‚ñº</span>
        </div>
        <div class="layer-body">
          <div class="table-wrap" style="max-height:300px; overflow-y:auto;">
            <table class="data-table" style="font-size:11px;">
              <thead style="position:sticky;top:0;z-index:2;">
                <tr><th style="width:35px;">On</th><th>ID</th><th>Initiative</th><th>Score</th><th>Tier</th><th>Stage</th><th>Lever</th><th>Effort</th><th>Channels</th><th>FTE Œî</th><th>Saving/yr</th><th style="width:40px;">Edit</th></tr>
              </thead>
              <tbody>
                ${layerInits.map((init, i) => {
                  const globalIdx = inits.indexOf(init);
                  const tierColors = {strong:'var(--ey-green)',moderate:'#D97706',weak:'var(--ey-text-light)',poor:'var(--ey-red)',excluded:'#888',trigger_fail:'#C5003E'};
                  const stageColors = {'AI Base':'#1A73E8','AI Enhanced':'#9C27B0','Autonomous':'#168736'};
                  return `<tr style="opacity:${init.enabled ? 1 : 0.45};cursor:pointer;" ondblclick="openInitEditor(${globalIdx})" title="${(init.reasons||init.relevanceReasons||[]).join(' ¬∑ ')}">
                    <td onclick="event.stopPropagation()"><input type="checkbox" ${init.enabled ? 'checked' : ''} onchange="toggleInitiative(${globalIdx})"></td>
                    <td><strong style="color:${layerColors[layer]};">${init.id}</strong></td>
                    <td>${init.name}</td>
                    <td><span style="font-weight:700;font-size:11px;color:${init.score >= 65 ? 'var(--ey-green)' : init.score >= 50 ? '#D97706' : 'var(--ey-red)'};">${(init.score||0).toFixed(0)}</span><span style="font-size:8px;color:var(--ey-text-light);">/100</span></td>
                    <td><span style="font-size:9px;font-weight:700;color:${tierColors[init.matchTier]||'#888'};">${(init.matchTier||'‚Äî').replace('_',' ')}</span></td>
                    <td><span style="font-size:9px;padding:1px 5px;border-radius:8px;background:${stageColors[init.stage]||'#eee'}20;color:${stageColors[init.stage]||'#888'};">${init.stage||'‚Äî'}</span></td>
                    <td style="font-size:10px;">${init.lever.replace(/_/g,' ')}</td>
                    <td><span class="badge badge-${init.effort==='low'?'low':init.effort==='medium'?'medium':'high'}">${init.effort}</span></td>
                    <td style="font-size:10px;">${init.channels.slice(0,2).join(', ')}${init.channels.length>2?'‚Ä¶':''}</td>
                    <td style="color:var(--ey-green);font-weight:700;">‚àí${init._fteImpact ? init._fteImpact.toFixed(0) : '‚Äî'}</td>
                    <td style="color:var(--ey-green);font-weight:700;">${init._annualSaving ? fmt(init._annualSaving,'$k') : '‚Äî'}</td>
                    <td onclick="event.stopPropagation()"><button style="border:none;background:none;cursor:pointer;font-size:14px;" onclick="openInitEditor(${globalIdx})">‚úèÔ∏è</button></td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>`;
    }).join('')}

    <div class="card">
      <div class="card-title">üéØ Priority Matrix (Impact vs Effort) <span style="font-size:11px; font-weight:400; color:var(--ey-text-light);">Click any dot to edit</span></div>
      <canvas id="priorityMatrix" width="800" height="480" style="width:100%;"></canvas>
      <div style="display:flex; gap:16px; margin-top:8px; font-size:11px; color:var(--ey-text-light);">
        <span>üîµ AI & Automation</span> <span>üü¢ Operating Model</span> <span>üü° Location Strategy</span>
        <span style="margin-left:auto;">Top-Left = Quick Wins | Top-Right = Strategic Bets | Bottom = Deprioritize</span>
      </div>
    </div>
  `;

  drawPriorityMatrix();
  // Fix #3: Re-apply saved layer filter after re-render
  if (savedLayer !== 'all') filterInitLayer(savedLayer);
}

function toggleAllInits(state) {
  INITIATIVES.forEach(i => i.enabled = state);
  recalculateAll();
}

function filterInitLayer(layer) {
  // Fix #3: Persist layer selection
  window._activeInitLayer = layer;
  
  // Show/hide layer sections
  document.querySelectorAll('.layer-section').forEach(el => {
    if (layer === 'all') el.style.display = '';
    else el.style.display = el.dataset.layer === layer ? '' : 'none';
  });

  // Fix #4: KPI cards reflect ENABLED initiatives within scoped view
  const scopedInits = layer === 'all' ? INITIATIVES : INITIATIVES.filter(i => i.layer === layer);
  const scopedEnabled = scopedInits.filter(i => i.enabled);
  const scopedFTE = scopedEnabled.reduce((s,i) => s + (i._fteImpact||0), 0);
  const scopedSaving = scopedEnabled.reduce((s,i) => s + (i._annualSaving||0), 0);

  // Update each layer KPI card to reflect enabled count in that layer
  const aiInits = INITIATIVES.filter(i=>i.layer==='AI & Automation');
  const opInits = INITIATIVES.filter(i=>i.layer==='Operating Model');
  const locInits = INITIATIVES.filter(i=>i.layer==='Location Strategy');
  const kpiAI = document.getElementById('kpiAI');
  const kpiOp = document.getElementById('kpiOp');
  const kpiLoc = document.getElementById('kpiLoc');
  if (kpiAI) kpiAI.innerHTML = `<div class="kpi-value">${aiInits.filter(i=>i.enabled).length}<span style="font-size:12px;color:var(--ey-text-light);">/${aiInits.length}</span></div><div class="kpi-label">AI & Automation</div>`;
  if (kpiOp) kpiOp.innerHTML = `<div class="kpi-value">${opInits.filter(i=>i.enabled).length}<span style="font-size:12px;color:var(--ey-text-light);">/${opInits.length}</span></div><div class="kpi-label">Operating Model</div>`;
  if (kpiLoc) kpiLoc.innerHTML = `<div class="kpi-value">${locInits.filter(i=>i.enabled).length}<span style="font-size:12px;color:var(--ey-text-light);">/${locInits.length}</span></div><div class="kpi-label">Location Strategy</div>`;

  const kpiActive = document.getElementById('kpiActive');
  const kpiFTE = document.getElementById('kpiFTE');
  const kpiSaving = document.getElementById('kpiSaving');
  if (kpiActive) kpiActive.innerHTML = `<div class="kpi-value">${scopedEnabled.length}<span style="font-size:12px;color:var(--ey-text-light);">/${scopedInits.length}</span></div><div class="kpi-label">${layer === 'all' ? 'Active' : layer.split(' ')[0] + ' Active'}</div>`;
  if (kpiFTE) kpiFTE.innerHTML = `<div class="kpi-value" style="color:var(--ey-green);">‚àí${scopedFTE.toFixed(0)} <span style="font-size:11px;font-weight:400;">FTE</span></div><div class="kpi-label">${layer === 'all' ? 'Total' : layer.split(' ')[0]} FTE Impact</div>`;
  if (kpiSaving) kpiSaving.innerHTML = `<div class="kpi-value" style="color:var(--ey-green);">${fmt(scopedSaving,'$m')}<span style="font-size:11px;font-weight:400;">/yr</span></div><div class="kpi-label">${layer === 'all' ? 'Total' : layer.split(' ')[0]} Annual Saving</div>`;
}

function toggleInitiative(idx) {
  const init = INITIATIVES[idx];
  const newState = !init.enabled;
  init.enabled = newState;
  
  // Persist to backend
  fetch('/api/initiative/toggle', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ id: init.id, enabled: newState })
  }).then(r => r.json()).then(resp => {
    if (resp.initiatives) {
      INITIATIVES.length = 0;
      resp.initiatives.forEach(i => INITIATIVES.push(i));
    }
    if (resp.waterfall) WATERFALL = resp.waterfall;
    _syncDemoFromBackend();
    Object.keys(rendered).forEach(k => rendered[k] = false);
    renderPage(currentPage);
  }).catch(err => {
    console.warn('Toggle backend failed:', err);
    recalculateAll();
  });
}

// ‚îÄ‚îÄ‚îÄ Initiative Editor Panel (slide-out) ‚îÄ‚îÄ‚îÄ
function openInitEditor(idx) {
  const init = INITIATIVES[idx];
  if (!init) return;
  const allChannels = ['Voice','Chat','Email','IVR','App/Self-Service','SMS/WhatsApp','Social Media','Retail/Walk-in'];
  const allLevers = ['deflection','aht_reduction','escalation_reduction','repeat_reduction','shrinkage_reduction','cost_reduction'];
  const allRoles = DEMO.roles.map(r => r.role);
  const allBUs = DEMO.bus;
  const layerColors = { 'AI & Automation': '#1A73E8', 'Operating Model': '#168736', 'Location Strategy': '#D97706' };

  document.getElementById('initEditorTitle').textContent = `${init.id} ‚Äî ${init.name}`;
  document.getElementById('initEditorBody').innerHTML = `
    <div style="display:flex;gap:6px;margin-bottom:16px;">
      <span style="padding:3px 10px;border-radius:10px;font-size:11px;font-weight:700;background:${layerColors[init.layer]}22;color:${layerColors[init.layer]};">${init.layer}</span>
      <span style="padding:3px 10px;border-radius:10px;font-size:11px;font-weight:700;background:${init.enabled?'#E8F5E9':'#FFEBEE'};color:${init.enabled?'var(--ey-green)':'var(--ey-red)'};">${init.enabled?'Active':'Disabled'}</span>
    </div>

    <div class="init-field">
      <label>Initiative Name</label>
      <input type="text" id="ie_name" value="${init.name}">
    </div>

    <div class="init-field-row">
      <div class="init-field">
        <label>Lever</label>
        <select id="ie_lever">${allLevers.map(l => `<option value="${l}" ${l===init.lever?'selected':''}>${l.replace(/_/g,' ')}</option>`).join('')}</select>
      </div>
      <div class="init-field">
        <label>Target Complexity</label>
        <select id="ie_complexity">
          <option value="any" ${init.complexity==='any'?'selected':''}>Any</option>
          <option value="simple" ${init.complexity==='simple'?'selected':''}>Simple</option>
          <option value="moderate" ${init.complexity==='moderate'?'selected':''}>Moderate</option>
          <option value="complex" ${init.complexity==='complex'?'selected':''}>Complex</option>
        </select>
      </div>
    </div>

    <div class="init-field-row3">
      <div class="init-field">
        <label>Impact %</label>
        <input type="number" id="ie_impact" value="${(init.impact*100).toFixed(0)}" min="0" max="80" step="1">
      </div>
      <div class="init-field">
        <label>Adoption %</label>
        <input type="number" id="ie_adoption" value="${(init.adoption*100).toFixed(0)}" min="0" max="100" step="5">
      </div>
      <div class="init-field">
        <label>Effort</label>
        <select id="ie_effort"><option value="low" ${init.effort==='low'?'selected':''}>Low</option><option value="medium" ${init.effort==='medium'?'selected':''}>Medium</option><option value="high" ${init.effort==='high'?'selected':''}>High</option></select>
      </div>
    </div>

    <div class="init-field-row3">
      <div class="init-field">
        <label>Start Month</label>
        <input type="number" id="ie_startMonth" value="${init.startMonth}" min="1" max="36">
      </div>
      <div class="init-field">
        <label>End Month</label>
        <input type="number" id="ie_endMonth" value="${init.endMonth}" min="1" max="48">
      </div>
      <div class="init-field">
        <label>Ramp (months)</label>
        <input type="number" id="ie_ramp" value="${init.ramp}" min="1" max="24">
      </div>
    </div>

    <div class="init-field-row3">
      <div class="init-field">
        <label>AHT Impact</label>
        <input type="number" id="ie_ahtImpact" value="${(init.ahtImpact*100).toFixed(0)}" min="-50" max="20" step="1">
      </div>
      <div class="init-field">
        <label>FCR Impact</label>
        <input type="number" id="ie_fcrImpact" value="${(init.fcrImpact*100).toFixed(0)}" min="-20" max="30" step="1">
      </div>
      <div class="init-field">
        <label>CSAT Impact</label>
        <input type="number" id="ie_csatImpact" value="${(init.csatImpact*100).toFixed(0)}" min="-20" max="20" step="1">
      </div>
    </div>

    <div class="init-field">
      <label>Channels</label>
      <div class="chip-group">
        ${allChannels.map(ch => `<div class="chip ${init.channels.includes(ch)?'active':''}" onclick="toggleInitChip(this,'${ch}',${idx},'channels')">${ch}</div>`).join('')}
      </div>
    </div>

    <div class="init-field">
      <label>Affected Roles</label>
      <div class="chip-group">
        ${allRoles.map(r => `<div class="chip ${init.roles.includes(r)?'active':''}" onclick="toggleInitChip(this,'${r}',${idx},'roles')">${r.split(' / ')[0]}</div>`).join('')}
      </div>
    </div>

    <div class="init-field">
      <label>Target Business Units</label>
      <div class="chip-group">
        ${allBUs.map(bu => `<div class="chip ${(init.targetBUs||allBUs).includes(bu)?'active':''}" onclick="toggleInitChip(this,'${bu}',${idx},'targetBUs')">${bu}</div>`).join('')}
      </div>
    </div>

    <div class="init-field-row3">
      <div class="init-field">
        <label>Impl Risk (1-5)</label>
        <input type="number" id="ie_implRisk" value="${init.implRisk}" min="1" max="5">
      </div>
      <div class="init-field">
        <label>CX Risk (1-5)</label>
        <input type="number" id="ie_cxRisk" value="${init.cxRisk}" min="1" max="5">
      </div>
      <div class="init-field">
        <label>Ops Risk (1-5)</label>
        <input type="number" id="ie_opsRisk" value="${init.opsRisk}" min="1" max="5">
      </div>
    </div>

    <!-- CR-013: Ramp-Up % Controls -->
    <div style="background:#f8f9fa;padding:10px;border-radius:8px;margin-top:8px;">
      <div style="font-size:11px;font-weight:700;margin-bottom:6px;">üìà Ramp-Up Schedule (% of full impact per year)</div>
      <div class="init-field-row3">
        <div class="init-field">
          <label>Year 1 (%)</label>
          <input type="number" id="ie_rampYear1" value="${((init.rampYear1 || init._rampPcts?.[0] || 0.30)*100).toFixed(0)}" min="5" max="100" step="5">
        </div>
        <div class="init-field">
          <label>Year 2 (%)</label>
          <input type="number" id="ie_rampYear2" value="${((init.rampYear2 || init._rampPcts?.[1] || 0.70)*100).toFixed(0)}" min="10" max="100" step="5">
        </div>
        <div class="init-field">
          <label>Year 3 (%)</label>
          <input type="number" id="ie_rampYear3" value="${((init.rampYear3 || init._rampPcts?.[2] || 0.95)*100).toFixed(0)}" min="20" max="100" step="5">
        </div>
      </div>
      <div style="font-size:10px;color:var(--ey-text-light);">S-curve ramp: impacts are phased over the implementation horizon. Adjust per initiative.</div>
    </div>

    <div class="init-impact-preview" id="ie_preview">
      <div style="font-size:11px;font-weight:700;margin-bottom:8px;">üéØ Relevance Match (${init.relevanceScore || '‚Äî'}/100)</div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <div style="flex:1;height:8px;background:var(--ey-mid-gray);border-radius:4px;overflow:hidden;">
          <div style="width:${init.relevanceScore||0}%;height:100%;background:${(init.relevanceScore||0)>=60?'var(--ey-green)':(init.relevanceScore||0)>=20?'var(--ey-amber)':'var(--ey-red)'};border-radius:4px;"></div>
        </div>
        <span style="font-size:10px;font-weight:700;color:${(init.relevanceScore||0)>=60?'var(--ey-green)':(init.relevanceScore||0)>=20?'var(--ey-amber)':'var(--ey-red)'};">${(init.relevanceScore||0)>=60?'Strong Match':(init.relevanceScore||0)>=20?'Moderate':'Low Match'}</span>
      </div>
      <div style="font-size:10px;color:var(--ey-text-light);margin-bottom:10px;line-height:1.5;">
        ${(init.relevanceReasons||['Custom initiative']).map(r => '<span style="display:inline-block;background:var(--ey-green-bg);color:var(--ey-green);padding:1px 6px;border-radius:8px;margin:2px;">‚úì ' + r + '</span>').join(' ')}
      </div>
      <div style="font-size:11px;font-weight:700;margin-bottom:8px;">üìä Impact Preview (after diminishing returns)</div>
      <div class="impact-grid">
        <div><div class="impact-val">${init._fteImpact?.toFixed(0) || '‚Äî'} <span style="font-size:10px;font-weight:400;">FTE</span></div><div class="impact-lbl">FTE Reduction</div></div>
        <div><div class="impact-val">${fmt(init._annualSaving||0, '$k')}<span style="font-size:10px;font-weight:400;">/yr</span></div><div class="impact-lbl">Annual Saving</div></div>
        <div><div class="impact-val">${init._linkedQueues || '‚Äî'} <span style="font-size:10px;font-weight:400;">queues</span></div><div class="impact-lbl">Linked Queues</div></div>
      </div>
      <div style="font-size:10px;color:var(--ey-text-light);margin-top:6px;">Effective impact: ${((init._effectiveImpact||init.impact)*100).toFixed(1)}% (raw: ${(init.impact*100).toFixed(0)}%) after lever saturation</div>
    </div>

    <div style="display:flex;gap:8px;margin-top:16px;">
      <button class="btn btn-primary" onclick="saveInitEditor(${idx})" style="flex:1;padding:10px;">‚úÖ Apply & Recalculate</button>
      <button class="btn btn-outline" onclick="toggleInitFromEditor(${idx})" style="padding:10px;">${init.enabled ? '‚¨ú Disable' : '‚úÖ Enable'}</button>
    </div>
    <button class="btn" style="width:100%;margin-top:6px;padding:8px;background:var(--ey-red-bg);color:var(--ey-red);border:1.5px solid var(--ey-red);font-weight:700;border-radius:6px;cursor:pointer;" onclick="if(confirm('Remove this initiative?')){INITIATIVES.splice(${idx},1);closeInitEditor();recalculateAll();}">üóëÔ∏è Remove Initiative</button>
  `;

  document.getElementById('initEditorPanel').classList.add('open');
  document.getElementById('initEditorBackdrop').classList.add('open');
}

function closeInitEditor() {
  document.getElementById('initEditorPanel').classList.remove('open');
  document.getElementById('initEditorBackdrop').classList.remove('open');
}

function toggleInitChip(el, value, idx, field) {
  el.classList.toggle('active');
  const init = INITIATIVES[idx];
  if (!init[field]) init[field] = [];
  if (el.classList.contains('active')) {
    if (!init[field].includes(value)) init[field].push(value);
  } else {
    init[field] = init[field].filter(v => v !== value);
  }
}

function saveInitEditor(idx) {
  const init = INITIATIVES[idx];
  const fields = {
    name: document.getElementById('ie_name').value,
    lever: document.getElementById('ie_lever').value,
    complexity: document.getElementById('ie_complexity').value,
    impact: parseFloat(document.getElementById('ie_impact').value) / 100,
    adoption: parseFloat(document.getElementById('ie_adoption').value) / 100,
    effort: document.getElementById('ie_effort').value,
    startMonth: parseInt(document.getElementById('ie_startMonth').value),
    endMonth: parseInt(document.getElementById('ie_endMonth').value),
    ramp: parseInt(document.getElementById('ie_ramp').value),
    ahtImpact: parseFloat(document.getElementById('ie_ahtImpact').value) / 100,
    fcrImpact: parseFloat(document.getElementById('ie_fcrImpact').value) / 100,
    csatImpact: parseFloat(document.getElementById('ie_csatImpact').value) / 100,
    implRisk: parseInt(document.getElementById('ie_implRisk').value),
    cxRisk: parseInt(document.getElementById('ie_cxRisk').value),
    opsRisk: parseInt(document.getElementById('ie_opsRisk').value),
  };
  fields.overallRisk = +(fields.implRisk * 0.4 + fields.cxRisk * 0.3 + fields.opsRisk * 0.3).toFixed(1);
  
  // CR-013: Ramp-up percentages
  const r1El = document.getElementById('ie_rampYear1');
  const r2El = document.getElementById('ie_rampYear2');
  const r3El = document.getElementById('ie_rampYear3');
  if (r1El) fields.rampYear1 = parseFloat(r1El.value) / 100;
  if (r2El) fields.rampYear2 = parseFloat(r2El.value) / 100;
  if (r3El) fields.rampYear3 = parseFloat(r3El.value) / 100;
  
  const effortMap = { low: 1, medium: 2, high: 3 };
  fields.effortScore = effortMap[fields.effort] || 2;
  fields.impactScore = fields.impact * 10;
  fields.channels = init.channels; // channels may have been toggled via chips
  fields.roles = init.roles;
  
  // Apply locally
  Object.assign(init, fields);
  closeInitEditor();
  
  // Fix #6: Persist to backend so changes survive recalculation
  fetch('/api/initiative/update', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ id: init.id, fields: fields })
  }).then(r => r.json()).then(resp => {
    if (resp.initiatives) {
      INITIATIVES.length = 0;
      resp.initiatives.forEach(i => INITIATIVES.push(i));
    }
    if (resp.waterfall) WATERFALL = resp.waterfall;
    _syncDemoFromBackend();
    Object.keys(rendered).forEach(k => rendered[k] = false);
    renderPage(currentPage);
    console.log(`[OK] Initiative ${init.id} saved to backend`);
  }).catch(err => {
    console.warn('Backend save failed, using client fallback:', err);
    recalculateAll();
  });
}

function toggleInitFromEditor(idx) {
  INITIATIVES[idx].enabled = !INITIATIVES[idx].enabled;
  closeInitEditor();
  recalculateAll();
}

// ‚îÄ‚îÄ‚îÄ Custom Initiative Builder ‚îÄ‚îÄ‚îÄ
function addCustomInitiative() {
  const nextId = 'CU' + String(INITIATIVES.filter(i=>i.id.startsWith('CU')).length + 1).padStart(2,'0');
  const newInit = {
    id: nextId, name: 'New Custom Initiative', layer: 'Operating Model',
    lever: 'aht_reduction', impact: 0.10, channels: ['Voice','Chat'], complexity: 'any',
    effort: 'medium', ahtImpact: -0.10, fcrImpact: 0.05, csatImpact: 0.03,
    roles: ['Agent L1'], ramp: 6, adoption: 0.80, enabled: true,
    startMonth: 3, endMonth: 9, effortScore: 2, impactScore: 1,
    implRisk: 2, cxRisk: 1, opsRisk: 2, overallRisk: 1.7,
    targetBUs: [...DEMO.bus],
    relevanceScore: 100, relevanceReasons: ['Custom initiative ‚Äî user-defined'],
    _fteImpact: 0, _annualSaving: 0, _linkedQueues: 0
  };
  INITIATIVES.push(newInit);
  openInitEditor(INITIATIVES.length - 1);
}

// ‚îÄ‚îÄ‚îÄ Enable Only Recommended ‚îÄ‚îÄ‚îÄ
function enableOnlyRecommended() {
  INITIATIVES.forEach(i => { i.enabled = (i.relevanceScore || 0) >= 20; });
  recalculateAll();
}

// ‚îÄ‚îÄ‚îÄ Initiative Library ‚îÄ‚îÄ‚îÄ
const RELEVANCE_THRESHOLD = 20;
// ‚îÄ‚îÄ‚îÄ Fix #7/#8: Channel Decision Drilldown ‚îÄ‚îÄ‚îÄ
function showChannelDrilldown(intent, channel, action) {
  const queues = DEMO.queues.filter(q => q.intent === intent && q.channel === channel);
  const allChQueues = DEMO.queues.filter(q => q.channel === channel);
  const chVol = allChQueues.reduce((s,q) => s+q.volume, 0);
  const totalVol = DEMO.totalVolume;
  const volShare = ((chVol / totalVol) * 100).toFixed(1);
  const avgCpc = allChQueues.length > 0 ? (allChQueues.reduce((s,q) => s+q.cpc*q.volume, 0) / chVol).toFixed(2) : '‚Äî';
  const avgCsat = allChQueues.length > 0 ? (allChQueues.reduce((s,q) => s+q.csat*q.volume, 0) / chVol).toFixed(2) : '‚Äî';
  const avgFcr = allChQueues.length > 0 ? (allChQueues.reduce((s,q) => s+q.fcr*q.volume, 0) / chVol * 100).toFixed(1) : '‚Äî';
  const avgAht = allChQueues.length > 0 ? (allChQueues.reduce((s,q) => s+q.aht*q.volume, 0) / chVol).toFixed(1) : '‚Äî';
  
  // Digital readiness signals
  const isDigital = ['Chat','Email','App/Self-Service','SMS/WhatsApp','Social Media'].includes(channel);
  const digitalReadiness = DEMO.readiness?.automationReadiness || 0;
  
  // Get benchmark comparisons
  const csatBM = getChannelBenchmark(channel, 'CSAT') || 3.9;
  const fcrBM = getChannelBenchmark(channel, 'FCR') || 0.76;
  const ahtBM = getChannelBenchmark(channel, 'AHT') || 6.0;
  const cpcBM = getChannelBenchmark(channel, 'CPC') || 5.0;
  
  // Build decision reasoning
  const signals = [];
  if (parseFloat(avgCpc) > cpcBM * 1.3) signals.push({icon:'üî¥', text:`CPC $${avgCpc} is ${((parseFloat(avgCpc)/cpcBM-1)*100).toFixed(0)}% above benchmark ($${cpcBM.toFixed(2)}) ‚Äî cost pressure signal`});
  else if (parseFloat(avgCpc) < cpcBM * 0.8) signals.push({icon:'üü¢', text:`CPC $${avgCpc} is ${((1-parseFloat(avgCpc)/cpcBM)*100).toFixed(0)}% below benchmark ‚Äî cost efficient`});
  if (parseFloat(avgCsat) < csatBM * 0.95) signals.push({icon:'üî¥', text:`CSAT ${avgCsat} below benchmark (${csatBM}) ‚Äî experience gap`});
  else signals.push({icon:'üü¢', text:`CSAT ${avgCsat} at or above benchmark (${csatBM})`});
  if (parseFloat(avgFcr)/100 < fcrBM * 0.9) signals.push({icon:'üî¥', text:`FCR ${avgFcr}% below benchmark (${(fcrBM*100).toFixed(0)}%) ‚Äî repeat contact driver`});
  if (parseFloat(volShare) < 3) signals.push({icon:'üü°', text:`Volume share ${volShare}% ‚Äî low volume channel`});
  else if (parseFloat(volShare) > 25) signals.push({icon:'üîµ', text:`Volume share ${volShare}% ‚Äî high volume, high impact`});
  if (isDigital) signals.push({icon:'üü¢', text:`Digital channel ‚Äî automation readiness: ${(digitalReadiness*100).toFixed(0)}%`});
  else signals.push({icon:'üü°', text:`Traditional channel ‚Äî migration potential depends on intent complexity`});
  
  const actionExplain = {
    'RETIRE': 'Channel should be retired ‚Äî poor economics, low CSAT, or better alternatives exist',
    'FIX': 'Channel needs fixing ‚Äî reasonable volume but underperforming on key metrics',
    'SCALE DOWN': 'Gradually reduce volume ‚Äî migrate contacts to more efficient channels',
    'INTRODUCE': 'New channel opportunity ‚Äî unmet demand or digital gap identified',
    'SCALE UP': 'Scale this channel ‚Äî strong performance and cost efficiency'
  };
  
  const modal = document.getElementById('modal');
  modal.classList.remove('hidden');
  document.getElementById('modalBody').innerHTML = `
    <div style="max-width:700px;">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
        <div style="font-size:32px;">üîç</div>
        <div>
          <h3 style="margin:0;font-size:16px;">${intent} √ó ${channel}</h3>
          <div style="font-size:12px;color:var(--ey-text-light);">Decision Rationale & Supporting Evidence</div>
        </div>
      </div>
      
      <div style="padding:12px 16px;border-radius:8px;background:${{'RETIRE':'var(--ey-red-bg)','FIX':'var(--ey-amber-bg)','SCALE DOWN':'var(--ey-blue-bg)','INTRODUCE':'var(--ey-green-bg)','SCALE UP':'var(--ey-green-bg)'}[action]||'var(--ey-light-gray)'};border-left:4px solid ${{'RETIRE':'var(--ey-red)','FIX':'var(--ey-amber)','SCALE DOWN':'var(--ey-blue)','INTRODUCE':'var(--ey-green)','SCALE UP':'var(--ey-green)'}[action]||'var(--ey-text-light)'};margin-bottom:16px;">
        <div style="font-weight:700;font-size:14px;margin-bottom:4px;">${action}</div>
        <div style="font-size:12px;">${actionExplain[action] || 'Decision based on diagnostic analysis'}</div>
      </div>
      
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;">
        <div style="text-align:center;padding:8px;background:var(--ey-light-gray);border-radius:6px;">
          <div style="font-size:18px;font-weight:800;">${fmt(chVol,'int')}</div><div style="font-size:10px;color:var(--ey-text-light);">Volume (${volShare}%)</div>
        </div>
        <div style="text-align:center;padding:8px;background:var(--ey-light-gray);border-radius:6px;">
          <div style="font-size:18px;font-weight:800;">$${avgCpc}</div><div style="font-size:10px;color:var(--ey-text-light);">Avg CPC</div>
        </div>
        <div style="text-align:center;padding:8px;background:var(--ey-light-gray);border-radius:6px;">
          <div style="font-size:18px;font-weight:800;">${avgCsat}</div><div style="font-size:10px;color:var(--ey-text-light);">Avg CSAT</div>
        </div>
        <div style="text-align:center;padding:8px;background:var(--ey-light-gray);border-radius:6px;">
          <div style="font-size:18px;font-weight:800;">${avgAht}m</div><div style="font-size:10px;color:var(--ey-text-light);">Avg AHT</div>
        </div>
      </div>
      
      <div style="font-weight:700;font-size:13px;margin-bottom:8px;">üìä Decision Signals</div>
      ${signals.map(s => `<div style="padding:6px 0;border-bottom:1px solid var(--ey-mid-gray);font-size:12px;">${s.icon} ${s.text}</div>`).join('')}
      
      ${queues.length > 0 ? `
      <div style="font-weight:700;font-size:13px;margin-top:16px;margin-bottom:8px;">üìã Affected Queues</div>
      <table class="data-table" style="font-size:11px;">
        <thead><tr><th>Queue</th><th>Volume</th><th>CSAT</th><th>FCR</th><th>AHT</th><th>CPC</th></tr></thead>
        <tbody>
          ${queues.map(q => `<tr>
            <td>${q.queue}</td><td>${fmt(q.volume,'int')}</td>
            <td>${q.csat?.toFixed(2)||'‚Äî'}</td><td>${((q.fcr||0)*100).toFixed(0)}%</td>
            <td>${q.aht?.toFixed(1)||'‚Äî'}m</td><td>$${q.cpc?.toFixed(2)||'‚Äî'}</td>
          </tr>`).join('')}
        </tbody>
      </table>` : ''}
      
      <div style="margin-top:16px;text-align:right;">
        <button class="btn btn-outline" onclick="closeModal()" style="padding:8px 20px;">Close</button>
      </div>
    </div>
  `;
}

function openInitLibrary() {
  const layers = ['AI & Automation', 'Operating Model', 'Location Strategy'];
  const layerColors = { 'AI & Automation': '#1A73E8', 'Operating Model': '#168736', 'Location Strategy': '#D97706' };
  
  window._libSearch = window._libSearch || '';
  window._libLayer = window._libLayer || 'all';
  window._libSort = window._libSort || 'relevance';
  
  let filtered = [...INITIATIVES];
  if (window._libLayer !== 'all') filtered = filtered.filter(i => i.layer === window._libLayer);
  if (window._libSearch) {
    const q = window._libSearch.toLowerCase();
    filtered = filtered.filter(i => i.name.toLowerCase().includes(q) || i.id.toLowerCase().includes(q) || i.lever.toLowerCase().includes(q));
  }
  if (window._libSort === 'relevance') filtered.sort((a,b) => (b.relevanceScore||0) - (a.relevanceScore||0));
  else if (window._libSort === 'impact') filtered.sort((a,b) => b.impact - a.impact);
  else if (window._libSort === 'effort_asc') filtered.sort((a,b) => a.effortScore - b.effortScore);
  
  const enabledCount = filtered.filter(i => i.enabled).length;
  const recommendedCount = filtered.filter(i => (i.relevanceScore||0) >= RELEVANCE_THRESHOLD).length;
  
  const html = `
    <div style="margin-bottom:16px;">
      <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center;">
        <input type="text" id="libSearch" value="${window._libSearch}" placeholder="Search initiatives‚Ä¶" 
          style="flex:1;min-width:200px;padding:8px 12px;border:1.5px solid var(--ey-mid-gray);border-radius:6px;font-size:12px;"
          oninput="window._libSearch=this.value;openInitLibrary()">
        <select onchange="window._libLayer=this.value;openInitLibrary()" style="padding:8px;font-size:11px;border:1.5px solid var(--ey-mid-gray);border-radius:6px;">
          <option value="all" ${window._libLayer==='all'?'selected':''}>All Layers</option>
          ${layers.map(l => `<option value="${l}" ${window._libLayer===l?'selected':''}>${l}</option>`).join('')}
        </select>
        <select onchange="window._libSort=this.value;openInitLibrary()" style="padding:8px;font-size:11px;border:1.5px solid var(--ey-mid-gray);border-radius:6px;">
          <option value="relevance" ${window._libSort==='relevance'?'selected':''}>Sort: Best Match</option>
          <option value="impact" ${window._libSort==='impact'?'selected':''}>Sort: Highest Impact</option>
          <option value="effort_asc" ${window._libSort==='effort_asc'?'selected':''}>Sort: Lowest Effort</option>
        </select>
      </div>
      <div style="display:flex;gap:16px;font-size:11px;color:var(--ey-text-light);margin-bottom:8px;">
        <span>Showing ${filtered.length} initiatives</span> ¬∑ 
        <span style="color:var(--ey-green);font-weight:600;">${enabledCount} active</span> ¬∑ 
        <span>${recommendedCount} recommended</span>
      </div>
    </div>
    <div style="max-height:480px;overflow-y:auto;">
      ${filtered.map(init => {
        const gIdx = INITIATIVES.indexOf(init);
        const relColor = (init.relevanceScore||0) >= 60 ? 'var(--ey-green)' : (init.relevanceScore||0) >= 20 ? 'var(--ey-amber)' : 'var(--ey-red)';
        const relLabel = (init.relevanceScore||0) >= 60 ? 'üü¢ Strong Match' : (init.relevanceScore||0) >= 20 ? 'üü° Moderate Match' : 'üî¥ Low Match';
        return `
        <div style="border:1.5px solid ${init.enabled ? 'var(--ey-green)' : 'var(--ey-mid-gray)'};border-radius:8px;padding:12px;margin-bottom:8px;
          background:${init.enabled ? 'var(--ey-green-bg)' : '#fff'};transition:all 0.2s;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
            <input type="checkbox" ${init.enabled ? 'checked' : ''} onchange="INITIATIVES[${gIdx}].enabled=this.checked;openInitLibrary();" style="width:16px;height:16px;">
            <strong style="color:${layerColors[init.layer]};font-size:11px;">${init.id}</strong>
            <strong style="font-size:12px;flex:1;">${init.name}</strong>
            <span style="font-size:10px;font-weight:700;color:${relColor};background:${(init.relevanceScore||0)>=20?'rgba(22,135,54,0.08)':'rgba(197,0,62,0.08)'};padding:2px 8px;border-radius:10px;">${relLabel} (${init.relevanceScore||0}/100)</span>
            <span class="badge" style="background:${layerColors[init.layer]}20;color:${layerColors[init.layer]};font-size:9px;">${init.layer.split(' ')[0]}</span>
          </div>
          <div style="display:flex;gap:16px;font-size:11px;margin-bottom:4px;">
            <span>Impact: <strong>${(init.impact*100).toFixed(0)}%</strong></span>
            <span>Effort: <span class="badge badge-${init.effort==='low'?'low':init.effort==='medium'?'medium':'high'}" style="font-size:9px;">${init.effort}</span></span>
            <span>Channels: ${init.channels.slice(0,3).join(', ')}${init.channels.length>3?'‚Ä¶':''}</span>
            <span>Ramp: ${init.ramp} mo</span>
          </div>
          <div style="font-size:10px;color:var(--ey-text-light);line-height:1.5;">
            ${(init.relevanceReasons||[]).map(r => '‚úì ' + r).join(' ¬∑ ')}
          </div>
          <div style="margin-top:6px;display:flex;gap:6px;">
            <button class="btn btn-sm btn-outline" style="font-size:10px;padding:3px 8px;" onclick="openInitEditor(${gIdx});closeModal();">‚úèÔ∏è Edit Parameters</button>
          </div>
        </div>`;
      }).join('')}
    </div>
    <div style="margin-top:16px;display:flex;gap:8px;">
      <button class="btn btn-primary" onclick="recalculateAll();closeModal();" style="flex:1;padding:10px;">‚úÖ Apply Selection & Recalculate</button>
      <button class="btn btn-outline" onclick="enableOnlyRecommended();closeModal();" style="padding:10px;">üéØ Recommended Only</button>
      <button class="btn btn-outline" onclick="addCustomInitiative();closeModal();" style="padding:10px;">‚ûï New Custom</button>
    </div>
  `;
  
  openModal('üìö Initiative Library ‚Äî Select & Configure', html);
}

function drawPriorityMatrix() {
  const canvas = document.getElementById('priorityMatrix');
  if (!canvas) return;
  canvas.width = 800; canvas.height = 480;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const pad = { l: 55, r: 20, t: 30, b: 45 };
  const plotW = W - pad.l - pad.r, plotH = H - pad.t - pad.b;
  ctx.clearRect(0, 0, W, H);
  
  const layerColors = { 'AI & Automation': '#1A73E8', 'Operating Model': '#168736', 'Location Strategy': '#D97706' };
  const enabledInits = INITIATIVES.filter(i => i.enabled);
  if (enabledInits.length === 0) return;

  // Compute composite scores for better spread
  // X = Effort: combines effort level + ramp time + complexity (higher = harder)
  // Y = Value: combines impact √ó adoption √ó annual saving potential (higher = more valuable)
  enabledInits.forEach(init => {
    const effortBase = { low: 1, medium: 2.5, high: 4 }[init.effort] || 2.5;
    const rampNorm = Math.min(init.ramp / 12, 1); // 0-1 for 0-12 months
    const complexNorm = init.complexity === 'simple' ? 0.2 : init.complexity === 'complex' ? 0.8 : 0.5;
    init._plotEffort = effortBase + rampNorm * 1.5 + complexNorm * 0.8; // range ~1.2 to 6.3
    
    const impactVal = init.impact * (init.adoption || 0.8);
    const savingNorm = Math.min((init._annualSaving || 0) / 1500000, 1);
    init._plotValue = impactVal * 0.6 + savingNorm * 0.4; // range ~0 to 0.6
  });

  // Scale ranges with padding
  const effortMin = Math.min(...enabledInits.map(i => i._plotEffort)) * 0.9;
  const effortMax = Math.max(...enabledInits.map(i => i._plotEffort)) * 1.05;
  const valueMin = 0;
  const valueMax = Math.max(...enabledInits.map(i => i._plotValue)) * 1.15;

  function toX(effort) { return pad.l + ((effort - effortMin) / (effortMax - effortMin)) * plotW; }
  function toY(value) { return pad.t + plotH - ((value - valueMin) / (valueMax - valueMin)) * plotH; }

  // Quadrant dividers (at midpoints)
  const midEff = (effortMin + effortMax) / 2;
  const midVal = (valueMin + valueMax) / 2;
  const qx = toX(midEff), qy = toY(midVal);

  // Quadrant fills
  ctx.fillStyle = 'rgba(22,135,54,0.06)'; ctx.fillRect(pad.l, pad.t, qx - pad.l, qy - pad.t); // Quick Wins (top-left)
  ctx.fillStyle = 'rgba(26,115,232,0.04)'; ctx.fillRect(qx, pad.t, W - pad.r - qx, qy - pad.t); // Strategic Bets (top-right)
  ctx.fillStyle = 'rgba(180,180,180,0.04)'; ctx.fillRect(pad.l, qy, qx - pad.l, H - pad.b - qy); // Easy Fills (bottom-left)
  ctx.fillStyle = 'rgba(197,0,62,0.04)'; ctx.fillRect(qx, qy, W - pad.r - qx, H - pad.b - qy); // Deprioritise (bottom-right)

  // Quadrant labels
  ctx.font = 'bold 11px Inter, sans-serif'; ctx.textAlign = 'center'; ctx.fillStyle = '#168736';
  ctx.fillText('‚òÖ QUICK WINS', (pad.l + qx) / 2, pad.t + 16);
  ctx.fillStyle = '#1A73E8';
  ctx.fillText('STRATEGIC BETS', (qx + W - pad.r) / 2, pad.t + 16);
  ctx.fillStyle = '#747480';
  ctx.fillText('EASY FILLS', (pad.l + qx) / 2, H - pad.b - 8);
  ctx.fillStyle = '#C5003E';
  ctx.fillText('DEPRIORITISE', (qx + W - pad.r) / 2, H - pad.b - 8);

  // Dashed quadrant lines
  ctx.setLineDash([4, 4]); ctx.strokeStyle = '#D0D0D8'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(qx, pad.t); ctx.lineTo(qx, H - pad.b); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(pad.l, qy); ctx.lineTo(W - pad.r, qy); ctx.stroke();
  ctx.setLineDash([]);

  // Axes
  ctx.strokeStyle = '#B0B0B8'; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(pad.l, H - pad.b); ctx.lineTo(W - pad.r, H - pad.b); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(pad.l, H - pad.b); ctx.lineTo(pad.l, pad.t); ctx.stroke();
  
  // Axis labels
  ctx.fillStyle = '#555'; ctx.font = '11px Inter, sans-serif'; ctx.textAlign = 'center';
  ctx.fillText('Implementation Effort ‚Üí', W / 2, H - 6);
  ctx.save(); ctx.translate(14, H / 2); ctx.rotate(-Math.PI / 2);
  ctx.fillText('Business Value ‚Üí', 0, 0); ctx.restore();

  // Axis ticks
  ctx.font = '9px sans-serif'; ctx.fillStyle = '#999';
  ctx.textAlign = 'center';
  ctx.fillText('Low', pad.l + plotW * 0.1, H - pad.b + 16);
  ctx.fillText('Medium', pad.l + plotW * 0.5, H - pad.b + 16);
  ctx.fillText('High', pad.l + plotW * 0.9, H - pad.b + 16);
  ctx.textAlign = 'right';
  ctx.fillText('Low', pad.l - 6, pad.t + plotH * 0.85);
  ctx.fillText('Med', pad.l - 6, pad.t + plotH * 0.5);
  ctx.fillText('High', pad.l - 6, pad.t + plotH * 0.15);

  // Anti-overlap: jitter overlapping dots
  const positions = [];
  enabledInits.forEach(init => {
    let px = toX(init._plotEffort);
    let py = toY(init._plotValue);
    // Jitter if too close to another
    let attempts = 0;
    while (attempts < 12 && positions.some(p => Math.abs(p.x - px) < 18 && Math.abs(p.y - py) < 18)) {
      px += (Math.random() - 0.5) * 24;
      py += (Math.random() - 0.5) * 18;
      attempts++;
    }
    // Clamp
    px = Math.max(pad.l + 10, Math.min(W - pad.r - 10, px));
    py = Math.max(pad.t + 10, Math.min(H - pad.b - 10, py));
    positions.push({ x: px, y: py, init });
  });

  // Draw dots (sorted so bigger ones render first)
  positions.sort((a, b) => (b.init._annualSaving || 0) - (a.init._annualSaving || 0));
  positions.forEach(({ x, y, init }) => {
    const saving = init._annualSaving || 0;
    const r = Math.max(6, Math.min(18, 6 + (saving / 400000) * 6));
    const color = layerColors[init.layer];

    // Drop shadow
    ctx.beginPath(); ctx.arc(x + 1, y + 1, r, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(0,0,0,0.08)'; ctx.fill();

    // Main dot
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fillStyle = color + 'CC'; ctx.fill();
    ctx.strokeStyle = color; ctx.lineWidth = 1.5; ctx.stroke();

    // White inner highlight
    ctx.beginPath(); ctx.arc(x - r * 0.25, y - r * 0.25, r * 0.35, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.fill();

    // Label
    ctx.fillStyle = '#2E2E38'; ctx.font = 'bold 9px Inter, sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(init.id, x, y - r - 4);
    
    // Saving label for bigger dots
    if (saving > 200000) {
      ctx.fillStyle = '#666'; ctx.font = '8px sans-serif';
      ctx.fillText(fmt(saving, '$k') + '/yr', x, y + r + 11);
    }
  });

  // Click handler
  canvas.onclick = function(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = W / rect.width, scaleY = H / rect.height;
    const cx = (e.clientX - rect.left) * scaleX;
    const cy = (e.clientY - rect.top) * scaleY;
    for (const { x, y, init } of positions) {
      const r = Math.max(6, Math.min(18, 6 + ((init._annualSaving || 0) / 400000) * 6));
      if (Math.hypot(cx - x, cy - y) < r + 5) {
        openInitEditor(INITIATIVES.indexOf(init));
        break;
      }
    }
  };

  // Hover cursor
  canvas.onmousemove = function(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = W / rect.width, scaleY = H / rect.height;
    const cx = (e.clientX - rect.left) * scaleX;
    const cy = (e.clientY - rect.top) * scaleY;
    const hit = positions.some(({ x, y, init }) => {
      const r = Math.max(6, Math.min(18, 6 + ((init._annualSaving || 0) / 400000) * 6));
      return Math.hypot(cx - x, cy - y) < r + 5;
    });
    canvas.style.cursor = hit ? 'pointer' : 'default';
  };
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 3: PAGE 10 ‚Äî CHANNEL STRATEGY
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage10() {
  const el = document.getElementById('page-10');

  // Determine action per intent-channel
  const decisions = [];
  DEMO.intents.forEach(intent => {
    const cmplx = DEMO.intentComplexity[intent];
    DEMO.channels.forEach(ch => {
      const qs = DEMO.queues.filter(q => q.intent === intent && q.channel === ch);
      if (qs.length === 0) {
        // Missing channel ‚Äî should we introduce?
        const cap = DEMO.channelCap[ch];
        if (cap >= 0.5 && cmplx < 0.5 && ['Chat','App/Self-Service','SMS/WhatsApp'].includes(ch)) {
          decisions.push({ intent, channel: ch, action: 'INTRODUCE', rationale: 'High capability, low complexity ‚Äî digital opportunity',
            volume: 0, health: 0, impact: '+' });
        }
        return;
      }
      const tv = qs.reduce((s,q)=>s+q.volume,0);
      const health = qs.reduce((s,q)=>s+getQueueHealth(q)*q.volume,0) / tv;
      const p25Vol = DEMO.queues.map(q=>q.volume).sort((a,b)=>a-b)[Math.floor(DEMO.queues.length*0.25)];

      let action, rationale;
      if (tv < p25Vol && health < 0.40) { action = 'RETIRE'; rationale = 'Low volume + poor health ‚Üí not viable'; }
      else if (health < 0.50) { action = 'FIX'; rationale = 'Significant performance gaps ‚Äî improve before scaling'; }
      else if (health < 0.70) { action = 'SCALE DOWN'; rationale = 'Below average ‚Äî migrate volume to better channels'; }
      else if (health >= 0.85 && ['Chat','App/Self-Service','SMS/WhatsApp'].includes(ch)) { action = 'SCALE UP'; rationale = 'Strong performer + digital channel ‚Äî absorb more volume'; }
      else { action = 'MAINTAIN'; rationale = 'Performing within acceptable range'; }

      decisions.push({ intent, channel: ch, action, rationale, volume: tv, health, impact: action === 'RETIRE' ? '‚àí' : action === 'SCALE UP' ? '+' : '~' });
    });
  });

  const actionColors = { INTRODUCE:'#1A73E8', RETIRE:'#C5003E', 'SCALE UP':'#168736', 'SCALE DOWN':'#D97706', FIX:'#C5003E', MAINTAIN:'#747480' };
  const actionCounts = {};
  decisions.forEach(d => { actionCounts[d.action] = (actionCounts[d.action]||0) + 1; });

  // Channel portfolio
  const portfolio = DEMO.channels.map(ch => {
    const qs = DEMO.queues.filter(q => q.channel === ch);
    const vol = qs.reduce((s,q)=>s+q.volume,0);
    const health = vol > 0 ? qs.reduce((s,q)=>s+getQueueHealth(q)*q.volume,0) / vol : 0;
    return { channel: ch, volume: vol, health, intents: new Set(qs.map(q=>q.intent)).size, cost: qs.reduce((s,q)=>s+q.volume*q.cpc,0) };
  }).sort((a,b) => b.volume - a.volume);

  el.innerHTML = `
    <div class="kpi-row" style="grid-template-columns:repeat(6,1fr); margin-bottom:16px;">
      ${Object.entries(actionCounts).map(([action, count]) => `
        <div class="kpi-card" style="border-left-color:${actionColors[action]||'#747480'};"><div class="kpi-value" style="color:${actionColors[action]};">${count}</div><div class="kpi-label">${action}</div></div>
      `).join('')}
    </div>
    <div class="card">
      <div class="card-title">üì° Channel Portfolio Overview</div>
      <div class="table-wrap"><table class="data-table" style="font-size:11px;">
        <thead><tr><th>Channel</th><th>Volume (contacts/mo)</th><th>Health (/100)</th><th># Intents</th><th>Cost (/mo)</th><th>CPC ($/contact)</th></tr></thead>
        <tbody>
          ${portfolio.map(p => `<tr>
            <td><strong>${p.channel}</strong></td>
            <td>${fmt(p.volume,'int')}</td>
            <td><div style="display:flex;align-items:center;gap:6px;"><div style="width:60px;height:8px;background:var(--ey-mid-gray);border-radius:4px;overflow:hidden;"><div style="width:${p.health*100}%;height:100%;background:${ragBg(ragColor(p.health))};border-radius:4px;"></div></div><strong style="color:${ragBg(ragColor(p.health))};">${(p.health*100).toFixed(0)}</strong></div></td>
            <td>${p.intents}</td>
            <td>${fmt(p.cost,'$k')}</td>
            <td>${p.volume>0 ? fmt(p.cost/p.volume,'$') : '‚Äî'}</td>
          </tr>`).join('')}
        </tbody>
      </table></div>
    </div>
    <div class="card">
      <div class="card-title">üéØ Channel Decision Matrix <span style="font-size:11px; font-weight:400; color:var(--ey-text-light);">Showing non-MAINTAIN decisions</span></div>
      <div class="table-wrap" style="max-height:400px; overflow-y:auto;"><table class="data-table" style="font-size:11px;">
        <thead style="position:sticky;top:0;z-index:2;"><tr><th>Intent</th><th>Channel</th><th>Action</th><th>Rationale</th><th>Volume</th><th>Health</th></tr></thead>
        <tbody>
          ${decisions.filter(d => d.action !== 'MAINTAIN').sort((a,b) => {
            const order = { RETIRE:0, FIX:1, 'SCALE DOWN':2, INTRODUCE:3, 'SCALE UP':4 };
            return (order[a.action]||5) - (order[b.action]||5);
          }).map(d => `<tr style="cursor:pointer;" ondblclick="showChannelDrilldown('${d.intent}','${d.channel}','${d.action}')" title="Double-click for decision rationale">
            <td>${d.intent}</td><td>${d.channel}</td>
            <td><span style="padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;background:${actionColors[d.action]}20;color:${actionColors[d.action]};">${d.action}</span></td>
            <td style="font-size:10px;">${d.rationale}</td>
            <td>${d.volume > 0 ? fmt(d.volume,'int') : '‚Äî'}</td>
            <td>${d.health > 0 ? `<strong style="color:${ragBg(ragColor(d.health))};">${(d.health*100).toFixed(0)}</strong>` : '‚Äî'}</td>
          </tr>`).join('')}
        </tbody>
      </table></div>
    </div>

    <!-- CR-008: Channel Migration Sankey -->
    <div class="card">
      <div class="card-title">üîÄ Channel Migration Flow (Current ‚Üí Target)</div>
      <canvas id="sankeyCh" width="700" height="350"></canvas>
      <div style="font-size:10px;color:var(--ey-text-light);margin-top:6px;">
        <span style="display:inline-block;width:12px;height:12px;background:#1A73E8;border-radius:2px;margin-right:4px;vertical-align:middle;"></span> Retained volume
        <span style="display:inline-block;width:12px;height:12px;background:#C5003E;border-radius:2px;margin-left:12px;margin-right:4px;vertical-align:middle;"></span> Migrated volume
      </div>
    </div>

    <!-- EY Channel Strategy: Migration Readiness + Recommendations -->
    ${DEMO.channelRecommendations?.length > 0 ? `
    <div class="card">
      <div class="card-title">üìä EY Channel Strategy ‚Äî Migration Readiness & Recommendations</div>
      <div class="table-wrap"><table class="data-table" style="font-size:11px;">
        <thead><tr><th>Channel</th><th>Decision</th><th>Migration Readiness</th><th>Volume Share</th><th>Avg CPC</th><th>Rationale</th></tr></thead>
        <tbody>
          ${DEMO.channelRecommendations.map(r => {
            const decColors = {invest:'#168736',maintain:'#747480',optimise:'#D97706',migrate_from:'#1A73E8',protect:'#9C27B0',sunset:'#C5003E'};
            return `<tr>
              <td><strong>${r.channel}</strong></td>
              <td><span style="padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;background:${decColors[r.decision]||'#747480'}20;color:${decColors[r.decision]||'#747480'};">${r.decision.toUpperCase()}</span></td>
              <td><div style="display:flex;align-items:center;gap:6px;"><div style="width:60px;height:8px;background:var(--ey-mid-gray);border-radius:4px;overflow:hidden;"><div style="width:${(r.migrationReadiness||0)*100}%;height:100%;background:${(r.migrationReadiness||0)>0.5?'#1A73E8':(r.migrationReadiness||0)>0.3?'#D97706':'#747480'};border-radius:4px;"></div></div><strong>${((r.migrationReadiness||0)*100).toFixed(0)}%</strong></div></td>
              <td>${r.volumeShare}%</td>
              <td>$${r.avgCpc?.toFixed(2)||'‚Äî'}</td>
              <td style="font-size:10px;max-width:300px;">${r.rationale}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table></div>
    </div>` : ''}

    <!-- CX Safeguards & Friction Signals -->
    <div class="grid-2">
      ${DEMO.frictionSignals?.length > 0 ? `
      <div class="card">
        <div class="card-title">‚ö†Ô∏è Friction Signals</div>
        ${DEMO.frictionSignals.slice(0,6).map(f => `
          <div style="padding:6px 0;border-bottom:1px solid var(--ey-mid-gray);font-size:11px;">
            <span class="badge badge-${f.severity === 'high' ? 'critical' : 'medium'}">${f.severity}</span>
            <span style="margin-left:6px;">${f.insight}</span>
          </div>
        `).join('')}
      </div>` : '<div></div>'}
      ${Object.keys(DEMO.cxSafeguards||{}).length > 0 ? `
      <div class="card">
        <div class="card-title">üõ°Ô∏è CX Safeguards Active</div>
        ${Object.values(DEMO.cxSafeguards).map(s => `
          <div style="padding:6px 0;border-bottom:1px solid var(--ey-mid-gray);font-size:11px;">
            <strong>${s.channel}</strong>: ${s.reason}
          </div>
        `).join('')}
      </div>` : `
      <div class="card">
        <div class="card-title">üõ°Ô∏è CX Safeguards</div>
        <div style="font-size:11px;color:var(--ey-text-light);padding:12px;">No CX safeguard gates triggered ‚Äî all channels within acceptable CSAT range for migration.</div>
      </div>`}
    </div>

    <!-- Migration Savings Summary -->
    ${DEMO.migrationSavings ? `
    <div class="card" style="background:linear-gradient(135deg,#E8F5E9,#F1F8E9);border:2px solid var(--ey-green);">
      <div style="display:flex;align-items:center;gap:16px;">
        <div style="font-size:28px;">üí∞</div>
        <div>
          <div style="font-weight:800;font-size:14px;color:var(--ey-green);margin-bottom:4px;">Channel Migration Savings</div>
          <div style="font-size:12px;">
            Annual saving from channel migration: <strong style="color:var(--ey-green);">${fmt(DEMO.migrationSavings.annualMigrationSaving||0,'$k')}/yr</strong>
            | FTE equivalent: <strong>${(DEMO.migrationSavings.fteSaved||0).toFixed(1)} FTE</strong>
            | Digital mix shift: <strong>${DEMO.currentDigitalPct||0}% ‚Üí ${DEMO.targetDigitalPct||0}%</strong>
          </div>
        </div>
      </div>
    </div>` : ''}
  `;

  // Draw Sankey if data available
  drawChannelSankey();
}

function drawChannelSankey() {
  const canvas = document.getElementById('sankeyCh');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);

  const sankey = DEMO.channelSankey || {nodes:[], links:[]};
  if (!sankey.nodes || sankey.nodes.length === 0) {
    ctx.fillStyle = '#747480'; ctx.font = '13px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText('Sankey data not available ‚Äî run channel strategy engine', W/2, H/2);
    return;
  }

  const leftNodes = sankey.nodes.filter(n => n.side === 'left');
  const rightNodes = sankey.nodes.filter(n => n.side === 'right');
  const maxVol = Math.max(...sankey.links.map(l => l.value), 1);
  const lGap = (H - 40) / Math.max(leftNodes.length, 1);
  const rGap = (H - 40) / Math.max(rightNodes.length, 1);
  const nodePos = {};

  leftNodes.forEach((n, i) => { nodePos[n.id] = {x: 30, y: 15 + i * lGap, w: 110, name: n.name, vol: n.volume}; });
  rightNodes.forEach((n, i) => { nodePos[n.id] = {x: W - 140, y: 15 + i * rGap, w: 110, name: n.name, vol: n.volume}; });

  // Store link paths for tooltip hover
  const linkPaths = [];

  // Draw links with volume labels
  sankey.links.forEach(link => {
    const s = nodePos[link.source]; const t = nodePos[link.target];
    if (!s || !t) return;
    const thick = Math.max(3, (link.value / maxVol) * 35);
    const sy = s.y + 15; const ty = t.y + 15;
    const midX = (s.x + s.w + t.x) / 2;

    ctx.beginPath();
    ctx.moveTo(s.x + s.w, sy);
    ctx.bezierCurveTo(s.x + s.w + 80, sy, t.x - 80, ty, t.x, ty);
    ctx.strokeStyle = link.type === 'migrate' ? 'rgba(197,0,62,0.30)' : 'rgba(26,115,232,0.20)';
    ctx.lineWidth = thick; ctx.stroke();

    // Volume label on link
    if (link.value > maxVol * 0.05) {
      const labelY = (sy + ty) / 2;
      ctx.fillStyle = link.type === 'migrate' ? '#C5003E' : '#1A73E8';
      ctx.font = 'bold 9px Inter, sans-serif'; ctx.textAlign = 'center';
      ctx.fillText(link.value.toLocaleString(), midX, labelY - 2);
    }

    linkPaths.push({source: s.name, target: t.name, value: link.value, type: link.type, queues: link.queues || [], midX, midY: (sy+ty)/2, thick});
  });

  // Draw nodes with volume
  [...leftNodes, ...rightNodes].forEach(n => {
    const p = nodePos[n.id]; if (!p) return;
    ctx.fillStyle = n.side === 'left' ? '#2E2E38' : '#1A73E8';
    const barH = Math.max(26, (n.volume / maxVol) * 40);
    ctx.fillRect(p.x, p.y + 15 - barH/2, p.w, barH);
    ctx.fillStyle = '#fff'; ctx.font = 'bold 10px Inter, sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(`${p.name} (${(n.volume/1000).toFixed(1)}K)`, p.x + p.w/2, p.y + 19);
  });

  // Tooltip on hover
  let tooltip = document.getElementById('sankeyTooltip');
  if (!tooltip) {
    tooltip = document.createElement('div');
    tooltip.id = 'sankeyTooltip';
    tooltip.style.cssText = 'position:absolute;display:none;background:#2E2E38;color:#fff;padding:8px 12px;border-radius:6px;font-size:10px;max-width:280px;z-index:100;pointer-events:none;line-height:1.5;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
    canvas.parentElement.style.position = 'relative';
    canvas.parentElement.appendChild(tooltip);
  }

  canvas.onmousemove = function(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = W / rect.width, scaleY = H / rect.height;
    const cx = (e.clientX - rect.left) * scaleX;
    const cy = (e.clientY - rect.top) * scaleY;

    let hit = null;
    for (const lp of linkPaths) {
      if (Math.abs(cx - lp.midX) < 60 && Math.abs(cy - lp.midY) < lp.thick + 10) {
        hit = lp; break;
      }
    }

    if (hit) {
      let html = `<strong>${hit.source} ‚Üí ${hit.target}</strong><br>${hit.value.toLocaleString()} contacts/mo (${hit.type})<br>`;
      if (hit.queues.length > 0) {
        html += '<hr style="border:none;border-top:1px solid #555;margin:4px 0;">';
        hit.queues.slice(0, 5).forEach(q => {
          html += `<div style="margin:2px 0;">${q.retained ? 'üîµ' : 'üî¥'} ${q.queue.split(' ‚Äî ').slice(1,2).join('')}: ${q.volume.toLocaleString()} (${q.tier})</div>`;
        });
        if (hit.queues.length > 5) html += `<div style="opacity:0.6;">+${hit.queues.length - 5} more queues</div>`;
      }
      tooltip.innerHTML = html;
      tooltip.style.display = 'block';
      tooltip.style.left = (e.clientX - rect.left + 12) + 'px';
      tooltip.style.top = (e.clientY - rect.top - 10) + 'px';
      canvas.style.cursor = 'pointer';
    } else {
      tooltip.style.display = 'none';
      canvas.style.cursor = 'default';
    }
  };
  canvas.onmouseleave = function() { tooltip.style.display = 'none'; };
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 4: PAGE 11 ‚Äî IMPLEMENTATION GANTT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage11() {
  const el = document.getElementById('page-11');
  const inits = INITIATIVES.filter(i => i.enabled).sort((a,b) => a.startMonth - b.startMonth);
  const maxMonth = Math.max(...inits.map(i => i.endMonth), 24);
  const months = Array.from({length: maxMonth}, (_,i) => i+1);
  const layerColors = { 'AI & Automation': '#1A73E8', 'Operating Model': '#168736', 'Location Strategy': '#D97706' };

  const groups = [
    { label: 'Quick Win (0-6m)', inits: inits.filter(i => i.startMonth <= 3 && i.ramp <= 6) },
    { label: 'Medium-Term (6-12m)', inits: inits.filter(i => (i.startMonth > 3 || i.ramp > 6) && i.endMonth <= 18) },
    { label: 'Strategic (12-24m)', inits: inits.filter(i => i.endMonth > 18) },
  ];

  el.innerHTML = `
    <div class="card">
      <div class="card-title">üìä Implementation Timeline (Gantt)</div>
      <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:11px;">
          <thead>
            <tr style="border-bottom:2px solid var(--ey-mid-gray);">
              <th style="min-width:180px; text-align:left; padding:6px;">Initiative</th>
              ${months.map(m => `<th style="min-width:28px; text-align:center; padding:2px; font-size:9px; color:var(--ey-text-light);">${m}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
            ${groups.map(g => {
              if (g.inits.length === 0) return '';
              return `<tr><td colspan="${maxMonth+1}" style="padding:8px 6px 4px; font-weight:700; font-size:10px; color:var(--ey-text-light); background:var(--ey-light-gray);">${g.label}</td></tr>` +
              g.inits.map(init => `<tr style="border-bottom:1px solid var(--ey-light-gray);">
                <td style="padding:4px 6px; font-size:10px;"><strong style="color:${layerColors[init.layer]};">${init.id}</strong> ${init.name.substring(0,25)}</td>
                ${months.map(m => {
                  if (m < init.startMonth || m > init.endMonth) return '<td></td>';
                  const progress = (m - init.startMonth) / (init.endMonth - init.startMonth || 1);
                  const opacity = 0.3 + progress * 0.7;
                  const isMilestone = m === Math.round((init.startMonth + init.endMonth)/2) || m === init.endMonth;
                  return `<td style="padding:2px;"><div style="height:16px; background:${layerColors[init.layer]}; opacity:${opacity}; border-radius:${m===init.startMonth?'3px 0 0 3px':'0'} ${m===init.endMonth?'0 3px 3px 0':''};">${isMilestone ? '<div style="width:6px;height:6px;background:white;border-radius:50%;margin:5px auto;"></div>' : ''}</div></td>`;
                }).join('')}
              </tr>`).join('');
            }).join('')}
            <tr style="border-top:2px solid var(--ey-dark);">
              <td style="padding:4px 6px; font-weight:700; font-size:10px;">Active Count</td>
              ${months.map(m => {
                const active = inits.filter(i => m >= i.startMonth && m <= i.endMonth).length;
                return `<td style="text-align:center; font-size:9px; font-weight:700; color:${active > 15 ? 'var(--ey-red)' : 'var(--ey-text-light)'};">${active}</td>`;
              }).join('')}
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div style="display:flex; gap:16px; margin-top:8px; font-size:11px;">
      <span>üîµ AI & Automation</span> <span>üü¢ Operating Model</span> <span>üü° Location Strategy</span>
      <span>‚ö™ Milestone (50% / full adoption)</span>
      <span style="margin-left:auto; color:var(--ey-text-light);">Bar opacity indicates adoption progress</span>
    </div>
  `;
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 4: PAGE 12 ‚Äî RISK ASSESSMENT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage12() {
  const el = document.getElementById('page-12');
  const inits = INITIATIVES.filter(i => i.enabled).sort((a,b) => b.overallRisk - a.overallRisk);
  const layerColors = { 'AI & Automation': '#1A73E8', 'Operating Model': '#168736', 'Location Strategy': '#D97706' };

  // Layer-level risk
  const layerRisk = {};
  ['AI & Automation','Operating Model','Location Strategy'].forEach(l => {
    const li = inits.filter(i => i.layer === l);
    if (li.length === 0) { layerRisk[l] = 0; return; }
    layerRisk[l] = li.reduce((s,i)=>s+i.overallRisk,0)/li.length;
  });

  const top5 = inits.slice(0, 10);
  const mitigations = {
    1: 'Standard project management controls',
    2: 'Enhanced monitoring, weekly reviews',
    3: 'Dedicated risk owner, phased rollout',
    4: 'Executive sponsorship, pilot-first approach, contingency budget',
    5: 'Board-level oversight, independent review, abort criteria defined'
  };

  el.innerHTML = `
    <div class="kpi-row" style="grid-template-columns:repeat(3,1fr); margin-bottom:16px;">
      ${Object.entries(layerRisk).map(([l, r]) => `
        <div class="kpi-card" style="border-left-color:${layerColors[l]};"><div class="kpi-value" style="color:${r > 3 ? 'var(--ey-red)' : r > 2 ? 'var(--ey-amber)' : 'var(--ey-green)'};">${r.toFixed(1)}</div><div class="kpi-label">${l} Avg Risk</div></div>
      `).join('')}
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="card-title">‚ö†Ô∏è Risk Register</div>
        <div class="table-wrap" style="max-height:400px; overflow-y:auto;"><table class="data-table" style="font-size:11px;">
          <thead style="position:sticky;top:0;z-index:2;"><tr><th>ID</th><th>Initiative</th><th>Impl (/5)</th><th>CX (/5)</th><th>Ops (/5)</th><th>Overall (/5)</th></tr></thead>
          <tbody>
            ${inits.map(i => {
              const rc = i.overallRisk > 3.5 ? 'critical' : i.overallRisk > 2.5 ? 'high' : i.overallRisk > 1.5 ? 'medium' : 'low';
              return `<tr>
                <td><strong style="color:${layerColors[i.layer]};">${i.id}</strong></td>
                <td>${i.name.substring(0,28)}</td>
                <td style="text-align:center;">${i.implRisk}</td>
                <td style="text-align:center;">${i.cxRisk}</td>
                <td style="text-align:center;">${i.opsRisk}</td>
                <td><span class="badge badge-${rc}">${i.overallRisk.toFixed(1)}</span></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table></div>
      </div>
      <div class="card">
        <div class="card-title">üéØ Risk vs Impact Scatter</div>
        <canvas id="riskScatter" width="500" height="400"></canvas>
        <p style="font-size:10px; color:var(--ey-text-light);">Top-left = safe bets. Bottom-right = risky.</p>
      </div>
    </div>
    <div class="card">
      <div class="card-title">üî¥ Top 5 Highest Risk Initiatives & Mitigations</div>
      <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px,1fr)); gap:12px;">
        ${top5.map(i => `
          <div style="padding:14px; border-radius:8px; border:1px solid var(--ey-mid-gray); border-left:3px solid ${i.overallRisk > 3 ? 'var(--ey-red)' : 'var(--ey-amber)'};">
            <div style="font-weight:700; margin-bottom:4px;">${i.id}: ${i.name}</div>
            <div style="font-size:11px; color:var(--ey-text-light); margin-bottom:8px;">
              Impl: ${i.implRisk}/5 | CX: ${i.cxRisk}/5 | Ops: ${i.opsRisk}/5 ‚Üí <strong>${i.overallRisk.toFixed(1)}</strong>
            </div>
            <div style="font-size:11px; padding:8px; background:var(--ey-light-gray); border-radius:4px;">
              <strong>Mitigation:</strong> ${mitigations[Math.ceil(i.overallRisk)] || mitigations[3]}
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  drawRiskScatter(inits, layerColors);

  // Append So What box
  const soWhatEl = document.createElement('div');
  soWhatEl.className = 'card';
  soWhatEl.style.cssText = 'background:linear-gradient(135deg,#FFFDE7,#FFF8E1);border:2px solid var(--ey-yellow);margin-top:12px;';
  const highRisk = inits.filter(i => i.overallRisk > 3);
  const safeCount = inits.filter(i => i.overallRisk <= 2);
  soWhatEl.innerHTML = `
    <div style="display:flex;align-items:flex-start;gap:12px;">
      <div style="font-size:28px;">üí°</div>
      <div>
        <div style="font-weight:800;font-size:14px;margin-bottom:4px;">Risk Management Recommendation</div>
        <div style="font-size:12px;color:var(--ey-text);line-height:1.5;">
          <strong>${safeCount.length} initiatives</strong> are in the "safe bet" quadrant ‚Äî proceed with standard governance.
          <strong>${highRisk.length} initiatives</strong> carry elevated risk (>3.0) and require dedicated risk owners, phased pilots, and executive sponsorship.
          ${highRisk.length > 0 ? `Highest risk: <strong>${highRisk[0].id} ${highRisk[0].name}</strong> (${highRisk[0].overallRisk.toFixed(1)}/5) ‚Äî recommend pilot in single BU before full rollout.` : ''}
          Portfolio risk is manageable: <strong>${(inits.reduce((s,i)=>s+i.overallRisk,0)/inits.length).toFixed(1)}/5 avg</strong> across ${inits.length} active initiatives.
        </div>
      </div>
    </div>
  `;
  el.appendChild(soWhatEl);
}

function drawRiskScatter(inits, layerColors) {
  const canvas = document.getElementById('riskScatter');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = 500, H = 400, pad = 50;
  ctx.clearRect(0, 0, W, H);

  // Heatmap background quadrants
  const midX = pad + (W - pad - 20) * 0.5;
  const midY = pad + (H - pad - pad) * 0.5;
  // Top-left: Safe bets (green)
  ctx.fillStyle = '#E8F5E915'; ctx.fillRect(pad, pad, midX - pad, midY - pad);
  // Top-right: Monitor closely (amber)
  ctx.fillStyle = '#FFF8E115'; ctx.fillRect(midX, pad, W - 20 - midX, midY - pad);
  // Bottom-left: Low priority (gray)
  ctx.fillStyle = '#F5F5F515'; ctx.fillRect(pad, midY, midX - pad, H - pad - midY);
  // Bottom-right: Avoid/Redesign (red)
  ctx.fillStyle = '#FFEBEE15'; ctx.fillRect(midX, midY, W - 20 - midX, H - pad - midY);

  // Quadrant labels
  ctx.font = '10px Inter, sans-serif'; ctx.globalAlpha = 0.4;
  ctx.fillStyle = '#168736'; ctx.fillText('SAFE BETS', pad + 40, pad + 18);
  ctx.fillStyle = '#D97706'; ctx.fillText('MONITOR CLOSELY', midX + 20, pad + 18);
  ctx.fillStyle = '#6B7280'; ctx.fillText('LOW PRIORITY', pad + 30, midY + 18);
  ctx.fillStyle = '#DC2626'; ctx.fillText('REDESIGN / MITIGATE', midX + 10, midY + 18);
  ctx.globalAlpha = 1;

  // Grid lines
  ctx.strokeStyle = '#E0E0E6'; ctx.lineWidth = 1; ctx.setLineDash([3,3]);
  ctx.beginPath(); ctx.moveTo(midX, pad); ctx.lineTo(midX, H-pad); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(pad, midY); ctx.lineTo(W-10, midY); ctx.stroke();
  ctx.setLineDash([]);

  // Axes
  ctx.strokeStyle = '#747480'; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(W-10, H-pad); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(pad, pad); ctx.stroke();
  ctx.fillStyle = '#747480'; ctx.font = '11px Inter, sans-serif'; ctx.textAlign = 'center';
  ctx.fillText('Overall Risk ‚Üí', W/2, H-8);
  ctx.save(); ctx.translate(14, H/2); ctx.rotate(-Math.PI/2); ctx.fillText('Impact (FTE Saving) ‚Üí', 0, 0); ctx.restore();

  // Scale labels
  ctx.font = '9px sans-serif'; ctx.fillStyle = '#999';
  [1,2,3,4,5].forEach(v => {
    const x = pad + (v/5) * (W - pad - 20);
    ctx.fillText(v.toString(), x, H - pad + 14);
  });

  // Plot initiatives
  const maxImpact = Math.max(...inits.map(i => i._fteImpact || 1), 1);
  inits.forEach(i => {
    const x = pad + (i.overallRisk / 5) * (W - pad - 20);
    const impactNorm = Math.min((i._fteImpact || 0) / maxImpact, 1);
    const y = (H - pad) - impactNorm * (H - pad - pad);
    const r = 5 + (i._annualSaving || 0) / 500000 * 4; // Size by saving
    ctx.beginPath(); ctx.arc(x, y, Math.min(r, 14), 0, Math.PI*2);
    ctx.fillStyle = layerColors[i.layer] + '88'; ctx.fill();
    ctx.strokeStyle = layerColors[i.layer]; ctx.lineWidth = 1.5; ctx.stroke();
    ctx.fillStyle = '#2E2E38'; ctx.font = '8px Inter, sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(i.id, x, y - Math.min(r, 14) - 3);
  });

  // Click handler
  canvas.onclick = function(e) {
    const rect = canvas.getBoundingClientRect();
    const cx = e.clientX - rect.left;
    const cy = e.clientY - rect.top;
    for (const i of inits) {
      const x = pad + (i.overallRisk / 5) * (W - pad - 20);
      const impactNorm = Math.min((i._fteImpact || 0) / maxImpact, 1);
      const y = (H - pad) - impactNorm * (H - pad - pad);
      if (Math.abs(cx - x) < 12 && Math.abs(cy - y) < 12) {
        openInitEditor(INITIATIVES.indexOf(i));
        break;
      }
    }
  };
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 4: PAGE 13 ‚Äî WORKFORCE TRANSITION
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage13() {
  const el = document.getElementById('page-13');
  const wf = WATERFALL;
  const horizon = DEMO.params.horizon;

  // Role-level table
  const roleData = DEMO.roles.map(r => {
    const ri = wf.roleImpact[r.role];
    return {
      role: r.role, baseline: r.headcount, location: r.location, costPerFTE: r.costPerFTE,
      yearly: ri.yearly.map(y => Math.round(y)),
      final: r.headcount - Math.round(ri.yearly[horizon-1]),
      reduction: Math.round(ri.yearly[horizon-1]),
      pctChange: ri.yearly[horizon-1] / r.headcount
    };
  });

  const totalReduction = roleData.reduce((s,r)=>s+r.reduction,0);
  const redeployCount = Math.round(totalReduction * DEMO.params.redeploymentPct);
  const attritionMonthly = DEMO.params.attritionMonthly;
  const monthlyAttrition = Math.round(DEMO.totalFTE * attritionMonthly);
  const monthsToAbsorb = totalReduction / monthlyAttrition;

  // Reskilling matrix
  const reskill = [
    { from:'Agent L1', to:'Chat Specialist', count: Math.round(redeployCount*0.3), skills:'Digital fluency, multi-tasking', duration:'4 weeks', cost:2500 },
    { from:'Agent L1', to:'QA Analyst', count: Math.round(redeployCount*0.15), skills:'Analytical thinking, scoring', duration:'6 weeks', cost:3500 },
    { from:'Agent L2 / Specialist', to:'AI Trainer / Bot Curator', count: Math.round(redeployCount*0.2), skills:'ML concepts, content curation', duration:'8 weeks', cost:5000 },
    { from:'Supervisor / Team Lead', to:'Change Manager', count: Math.round(redeployCount*0.1), skills:'Project management, comms', duration:'4 weeks', cost:3000 },
    { from:'Back-Office / Processing', to:'RPA Developer', count: Math.round(redeployCount*0.15), skills:'Process mapping, basic coding', duration:'12 weeks', cost:8000 },
    { from:'Agent L1', to:'Customer Success', count: Math.round(redeployCount*0.1), skills:'Relationship building', duration:'4 weeks', cost:2000 },
  ];

  el.innerHTML = `
    <div class="kpi-row" style="grid-template-columns:repeat(4,1fr); margin-bottom:16px;">
      <div class="kpi-card" style="border-left-color:var(--ey-blue);"><div class="kpi-value">${fmt(totalReduction,'int')} <span style="font-size:11px;font-weight:400;">FTE</span></div><div class="kpi-label">Total FTE Reduction</div></div>
      <div class="kpi-card" style="border-left-color:var(--ey-green);"><div class="kpi-value">${fmt(redeployCount,'int')} <span style="font-size:11px;font-weight:400;">FTE</span></div><div class="kpi-label">Redeployed (${(DEMO.params.redeploymentPct*100).toFixed(0)}%)</div></div>
      <div class="kpi-card" style="border-left-color:var(--ey-amber);"><div class="kpi-value">${fmt(monthlyAttrition,'int')} <span style="font-size:11px;font-weight:400;">FTE/mo</span></div><div class="kpi-label">Natural Attrition</div></div>
      <div class="kpi-card" style="border-left-color:${monthsToAbsorb <= horizon*12 ? 'var(--ey-green)' : 'var(--ey-red)'};">
        <div class="kpi-value">${monthsToAbsorb.toFixed(0)} <span style="font-size:11px;font-weight:400;">months</span></div><div class="kpi-label">To Absorb via Attrition</div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">üë• FTE Impact by Role</div>
      <div class="table-wrap"><table class="data-table" style="font-size:11px;">
        <thead><tr><th>Role</th><th>Location</th><th>Baseline (FTE)</th>${Array.from({length:horizon},(_,i)=>`<th>Year ${i+1} (FTE)</th>`).join('')}<th>Reduction (FTE)</th><th>% Change</th></tr></thead>
        <tbody>
          ${roleData.map(r => `<tr>
            <td><strong>${r.role}</strong></td>
            <td style="font-size:10px;">${r.location}</td>
            <td>${r.baseline}</td>
            ${r.yearly.map(y => `<td>${r.baseline - y} <span style="font-size:10px; color:var(--ey-green);">(‚àí${y})</span></td>`).join('')}
            <td style="font-weight:700; color:var(--ey-red);">‚àí${r.reduction}</td>
            <td style="color:${r.pctChange > 0.3 ? 'var(--ey-red)' : r.pctChange > 0.15 ? 'var(--ey-amber)' : 'var(--ey-green)'}; font-weight:700;">
              ${(r.pctChange*100).toFixed(0)}%
            </td>
          </tr>`).join('')}
          <tr style="border-top:2px solid var(--ey-dark); font-weight:700;">
            <td>TOTAL</td><td></td><td>${DEMO.totalFTE}</td>
            ${Array.from({length:horizon},(_,yr)=> {
              const red = roleData.reduce((s,r)=>s+r.yearly[yr],0);
              return `<td>${DEMO.totalFTE - red} (‚àí${red})</td>`;
            }).join('')}
            <td style="color:var(--ey-red);">‚àí${totalReduction}</td>
            <td>${(totalReduction/DEMO.totalFTE*100).toFixed(0)}%</td>
          </tr>
        </tbody>
      </table></div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="card-title">üîÑ Reskilling Matrix</div>
        <div class="table-wrap"><table class="data-table" style="font-size:11px;">
          <thead><tr><th>From Role</th><th>To Role</th><th># People</th><th>Skills Needed</th><th>Duration</th><th>Cost/Head</th></tr></thead>
          <tbody>
            ${reskill.map(r => `<tr>
              <td>${r.from}</td><td><strong>${r.to}</strong></td><td>${r.count}</td>
              <td style="font-size:10px;">${r.skills}</td><td>${r.duration}</td><td>${fmt(r.cost,'$')}</td>
            </tr>`).join('')}
            <tr style="border-top:2px solid var(--ey-dark); font-weight:700;">
              <td colspan="2">Total Reskilling</td><td>${reskill.reduce((s,r)=>s+r.count,0)}</td>
              <td colspan="2"></td><td>${fmt(reskill.reduce((s,r)=>s+r.count*r.cost,0),'$k')}</td>
            </tr>
          </tbody>
        </table></div>
      </div>
      <div class="card">
        <div class="card-title">üìâ Natural Attrition vs Reduction Need</div>
        <canvas id="attritionChart" width="500" height="300"></canvas>
        <p style="font-size:10px; color:var(--ey-text-light); margin-top:4px;">
          ${monthsToAbsorb <= horizon*12
            ? `‚úÖ All reductions achievable through natural attrition by month ${Math.ceil(monthsToAbsorb)}`
            : `‚ö†Ô∏è Gap of ${totalReduction - Math.round(monthlyAttrition * horizon * 12)} FTE requires redeployment or voluntary separation`}
        </p>
      </div>
    </div>
  `;

  drawAttritionChart(totalReduction, monthlyAttrition, horizon);
}

function drawAttritionChart(totalReduction, monthlyAttrition, horizon) {
  const canvas = document.getElementById('attritionChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = 500, H = 300, pad = {l:50, r:20, t:20, b:40};
  ctx.clearRect(0, 0, W, H);
  const months = horizon * 12;
  const maxY = Math.max(totalReduction, monthlyAttrition * months) * 1.1;

  // Axes
  ctx.strokeStyle = '#E0E0E6'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(pad.l, H-pad.b); ctx.lineTo(W-pad.r, H-pad.b); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(pad.l, H-pad.b); ctx.lineTo(pad.l, pad.t); ctx.stroke();
  ctx.fillStyle = '#747480'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText('Months ‚Üí', W/2, H-5);

  // Attrition line (cumulative)
  ctx.beginPath(); ctx.strokeStyle = '#168736'; ctx.lineWidth = 2;
  for (let m = 0; m <= months; m++) {
    const x = pad.l + (m/months) * (W-pad.l-pad.r);
    const y = (H-pad.b) - (monthlyAttrition * m / maxY) * (H-pad.b-pad.t);
    m === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.stroke();

  // Reduction target line (flat)
  ctx.beginPath(); ctx.strokeStyle = '#C5003E'; ctx.lineWidth = 2; ctx.setLineDash([4,4]);
  const targetY = (H-pad.b) - (totalReduction / maxY) * (H-pad.b-pad.t);
  ctx.moveTo(pad.l, targetY); ctx.lineTo(W-pad.r, targetY);
  ctx.stroke(); ctx.setLineDash([]);

  // Legend
  ctx.fillStyle = '#168736'; ctx.fillRect(W-180, pad.t, 10, 10);
  ctx.fillStyle = '#2E2E38'; ctx.font = '10px sans-serif'; ctx.textAlign = 'left';
  ctx.fillText('Cumulative Attrition', W-165, pad.t+9);
  ctx.fillStyle = '#C5003E'; ctx.fillRect(W-180, pad.t+16, 10, 10);
  ctx.fillStyle = '#2E2E38'; ctx.fillText('Reduction Target', W-165, pad.t+25);
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 5: PAGE 14 ‚Äî IMPACT DASHBOARD
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage14() {
  const el = document.getElementById('page-14');
  const wf = WATERFALL;
  const horizon = DEMO.params.horizon;
  const sc = wf.scenarios;

  // NaN-safe helpers
  const safeNum = (v, fallback=0) => (isNaN(v) || v == null) ? fallback : v;
  const safeFmt = (v, type) => fmt(safeNum(v), type);
  const safePct = (v) => isNaN(v) ? '0' : v.toFixed(0);
  const safeFixed = (v, d=0) => isNaN(v) ? '0' : v.toFixed(d);

  // Sensitivity analysis (CR-018: use server data if available)
  const baseNPV = safeNum(wf.totalNPV, 100000);
  const serverSens = wf.sensitivity || [];
  const sensVars = serverSens.length > 0
    ? serverSens.map(s => ({name: s.variable || s.name, swing: Math.abs(safeNum(s.swing || s.highNPV - s.lowNPV, baseNPV * 0.1))})).sort((a,b) => b.swing - a.swing)
    : [
        { name: 'Adoption Rate', swing: baseNPV * 0.22 },
        { name: 'FTE Cost Variance', swing: baseNPV * 0.18 },
        { name: 'Implementation Delay', swing: baseNPV * 0.15 },
        { name: 'Volume Growth', swing: baseNPV * 0.12 },
        { name: 'Wage Inflation', swing: baseNPV * 0.09 },
        { name: 'Discount Rate', swing: baseNPV * 0.08 },
      ].sort((a,b) => b.swing - a.swing);

  // Cost of inaction (BCG "burning platform" framing)
  const annualBaseCost = DEMO.roles.reduce((s,r)=>s+r.headcount*r.costPerFTE,0);
  const doNothingCost = Array.from({length: horizon}, (_,yr) =>
    annualBaseCost * Math.pow(1+DEMO.params.wageInflation, yr+1) * (1 + DEMO.params.volumeGrowth * (yr+1))
  );
  const totalDoNothing = doNothingCost.reduce((s,c)=>s+c,0);
  const totalWithTransform = wf.yearly.reduce((s,y)=>s+y.futureCost,0) + wf.totalInvestment;
  const costOfInaction = totalDoNothing - totalWithTransform;

  // Investment breakdown (CR-017: NaN-safe)
  const safeInv = Math.max(wf.totalInvestment || 1, 1);
  const investBreakdown = [
    { category: 'Technology & Platforms', amount: wf.techInvestment || 0, pct: ((wf.techInvestment||0)/safeInv*100).toFixed(0) },
    { category: 'Change Management', amount: wf.changeMgmt || 0, pct: ((wf.changeMgmt||0)/safeInv*100).toFixed(0) },
    { category: 'Training & Reskilling', amount: wf.training || 0, pct: ((wf.training||0)/safeInv*100).toFixed(0) },
    { category: 'Contingency (10%)', amount: wf.contingency || 0, pct: ((wf.contingency||0)/safeInv*100).toFixed(0) },
  ];

  // CX Revenue Impact estimate (CSAT-driven)
  const csatUplift = 0.35; // points
  const revenuePerCSATPoint = annualBaseCost * 0.08; // 8% of cost base per CSAT point
  const cxRevenueImpact = csatUplift * revenuePerCSATPoint;

  // Per-initiative contribution
  const initContrib = INITIATIVES.filter(i => i.enabled && i._annualSaving > 0).sort((a,b) => b._annualSaving - a._annualSaving).slice(0,15);

  el.innerHTML = `
    <!-- Executive Decision Box -->
    <div class="card" style="background:linear-gradient(135deg,#1a1a2e,#2E2E38);color:white;margin-bottom:16px;border:2px solid var(--ey-yellow);">
      <div style="display:flex;align-items:flex-start;gap:16px;">
        <div style="font-size:36px;">üéØ</div>
        <div style="flex:1;">
          <div style="font-size:16px;font-weight:800;color:var(--ey-yellow);margin-bottom:8px;">Investment Decision Summary</div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:12px;">
            <div><div style="font-size:28px;font-weight:800;color:var(--ey-yellow);">${fmt(wf.totalInvestment,'$m')}</div><div style="font-size:10px;opacity:0.7;">Total Investment Required</div></div>
            <div><div style="font-size:28px;font-weight:800;color:#4CAF50;">${fmt(wf.totalNPV,'$m')}</div><div style="font-size:10px;opacity:0.7;">Net Present Value (${horizon}-yr)</div></div>
            <div><div style="font-size:28px;font-weight:800;color:#4CAF50;">${safeFixed(wf.irr)}%</div><div style="font-size:10px;opacity:0.7;">Internal Rate of Return</div></div>
            <div><div style="font-size:28px;font-weight:800;color:#FF9800;">${fmt(costOfInaction,'$m')}</div><div style="font-size:10px;opacity:0.7;">Cost of Inaction over ${horizon} yrs</div></div>
          </div>
          <div style="font-size:12px;opacity:0.85;line-height:1.5;">
            ${INITIATIVES.filter(i=>i.enabled).length} initiatives enabled targeting <strong>${fmt(wf.totalReduction,'int')} FTE</strong> reduction with <strong>${fmt(wf.totalNPV,'$m')}</strong> NPV over ${horizon} years.
            Doing nothing costs an additional <strong>${fmt(costOfInaction,'$m')}</strong> over ${horizon} years due to wage inflation and volume growth.
          </div>
        </div>
      </div>
    </div>

    <div class="kpi-row" style="grid-template-columns:repeat(6,1fr); margin-bottom:16px;">
      <div class="kpi-card" style="border-left-color:var(--ey-blue);"><div class="kpi-value">${fmt(wf.totalReduction,'int')} <span style="font-size:12px;font-weight:400;">FTE</span></div><div class="kpi-label">FTE Reduction</div></div>
      <div class="kpi-card" style="border-left-color:var(--ey-green);"><div class="kpi-value">${fmt(wf.yearly[horizon-1]?.annualSaving||0,'$m')}<span style="font-size:11px;font-weight:400;">/yr</span></div><div class="kpi-label">Annual Saving (Yr ${horizon})</div></div>
      <div class="kpi-card" style="border-left-color:var(--ey-green);"><div class="kpi-value">${fmt(wf.totalNPV,'$m')}</div><div class="kpi-label">NPV (${horizon}-yr)</div></div>
      <div class="kpi-card" style="border-left-color:var(--ey-teal);"><div class="kpi-value">${safeFixed(wf.irr)}%</div><div class="kpi-label">IRR</div></div>
      <div class="kpi-card" style="border-left-color:var(--ey-blue);"><div class="kpi-value">${fmt(wf.totalInvestment,'$m')}</div><div class="kpi-label">Total Investment</div></div>
      <div class="kpi-card" style="border-left-color:var(--ey-amber);"><div class="kpi-value">${fmt(DEMO.totalFTE - wf.totalReduction,'int')} <span style="font-size:11px;font-weight:400;">FTE</span></div><div class="kpi-label">Final Headcount</div></div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-title">üìä FTE Waterfall (Baseline ‚Üí Final)</div>
        <canvas id="fteWaterfall" width="500" height="300"></canvas>
      </div>
      <div class="card">
        <div class="card-title">üìà Cumulative NPV</div>
        <canvas id="npvChart" width="500" height="300"></canvas>
      </div>
    </div>

    <!-- Cost of Inaction Table (BCG-style) -->
    <div class="card" style="border:2px solid var(--ey-red);">
      <div class="card-title" style="color:var(--ey-red);">üî• Cost of Inaction ‚Äî "Do Nothing" Scenario</div>
      <table class="data-table" style="font-size:11px;">
        <thead><tr><th>Metric</th><th>Baseline ($/yr)</th>${wf.yearly.map(y=>`<th>Year ${y.year} ($/yr)</th>`).join('')}<th style="background:var(--ey-red-bg);">Total (${horizon}-yr)</th></tr></thead>
        <tbody>
          <tr><td><strong>Do Nothing Cost</strong></td><td>${fmt(annualBaseCost,'$m')}</td>${doNothingCost.map(c=>`<td>${fmt(c,'$m')}</td>`).join('')}<td style="background:var(--ey-red-bg);font-weight:800;color:var(--ey-red);">${fmt(totalDoNothing,'$m')}</td></tr>
          <tr><td><strong>With Transformation</strong></td><td>‚Äî</td>${wf.yearly.map(y=>`<td>${fmt(y.futureCost,'$m')}</td>`).join('')}<td style="font-weight:700;">${fmt(totalWithTransform,'$m')}</td></tr>
          <tr style="background:var(--ey-green-bg);"><td><strong>Savings vs Do Nothing</strong></td><td>‚Äî</td>${wf.yearly.map((y,i)=>`<td style="font-weight:700;color:var(--ey-green);">${fmt(doNothingCost[i]-y.futureCost,'$m')}</td>`).join('')}<td style="background:var(--ey-green-bg);font-weight:800;color:var(--ey-green);">${fmt(costOfInaction,'$m')}</td></tr>
          <tr><td><strong>Cumulative FTE if No Action</strong></td><td>${DEMO.totalFTE}</td>${wf.yearly.map((y,i)=>`<td style="color:var(--ey-red);">${DEMO.totalFTE + Math.round(DEMO.totalFTE * DEMO.params.volumeGrowth * (i+1))}</td>`).join('')}<td>‚Äî</td></tr>
        </tbody>
      </table>
      <div style="margin-top:8px;font-size:11px;color:var(--ey-red);font-weight:600;">‚ö† Without transformation, headcount grows by ${(DEMO.params.volumeGrowth*100).toFixed(0)}%/yr with volume while costs inflate at ${(DEMO.params.wageInflation*100).toFixed(1)}%/yr ‚Äî a compounding cost spiral.</div>
    </div>

    <div class="card">
      <div class="card-title">üìÖ Year-over-Year Financial Projection</div>
      <table class="data-table" style="font-size:11px;">
        <thead><tr><th>Metric</th><th>Baseline</th>${wf.yearly.map(y=>`<th>Year ${y.year}</th>`).join('')}</tr></thead>
        <tbody>
          <tr><td><strong>FTE (headcount)</strong></td><td>${DEMO.totalFTE}</td>${wf.yearly.map(y=>`<td>${y.finalFTE} <span style="font-size:10px;color:var(--ey-green);">(‚àí${y.fteReduction})</span></td>`).join('')}</tr>
          <tr><td><strong>Inflated Cost (Do Nothing)</strong></td><td>${fmt(annualBaseCost,'$m')}/yr</td>${wf.yearly.map(y=>`<td>${fmt(y.inflatedCost,'$m')}/yr</td>`).join('')}</tr>
          <tr><td><strong>Future Cost (With Transformation)</strong></td><td>‚Äî</td>${wf.yearly.map(y=>`<td>${fmt(y.futureCost,'$m')}/yr</td>`).join('')}</tr>
          <tr style="background:var(--ey-green-bg);"><td><strong>Net Saving</strong></td><td>‚Äî</td>${wf.yearly.map(y=>`<td style="font-weight:700;color:var(--ey-green);">${fmt(y.annualSaving,'$m')}/yr</td>`).join('')}</tr>
          <tr><td><strong>Cumulative Saving</strong></td><td>‚Äî</td>${wf.yearly.map(y=>`<td style="font-weight:700;">${fmt(y.cumSaving,'$m')}</td>`).join('')}</tr>
          <tr><td><strong>NPV</strong></td><td>‚Äî</td>${wf.yearly.map(y=>`<td>${fmt(y.npv,'$m')}</td>`).join('')}</tr>
        </tbody>
      </table>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-title">üéØ Scenario Comparison</div>
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:12px;">
          ${Object.values(sc).map(s => `
            <div style="padding:14px; border-radius:8px; border:2px solid ${s.label==='Base Case' ? 'var(--ey-yellow)' : 'var(--ey-mid-gray)'}; text-align:center;">
              <div style="font-weight:700; margin-bottom:4px;">${s.label}</div>
              ${s.description ? `<div style="font-size:10px; color:var(--ey-text-light); margin-bottom:8px;">${s.description}</div>` : ''}
              <div style="font-size:24px; font-weight:800; color:var(--ey-green);">${safeFmt(s.npv,'$m')}</div>
              <div style="font-size:11px; color:var(--ey-text-light);">NPV</div>
              <div style="margin-top:8px; font-size:12px;">IRR: <strong>${safeFixed(s.irr||0)}%</strong></div>
              <div style="font-size:12px;">FTE: <strong>‚àí${safeNum(s.fteReduction)} FTE</strong></div>
              <div style="font-size:12px;">Investment: <strong>${safeFmt(s.investment,'$m')}</strong></div>
              <div style="font-size:12px;">Saving: <strong>${safeFmt(s.annualSaving,'$m')}/yr</strong></div>
            </div>
          `).join('')}
        </div>
      </div>
      <div class="card">
        <div class="card-title">üå™Ô∏è Sensitivity Tornado (¬±20% NPV Swing)</div>
        <canvas id="tornadoChart" width="500" height="280"></canvas>
      </div>
    </div>

    <!-- Investment Breakdown -->
    <div class="grid-2">
      <div class="card">
        <div class="card-title">üí∞ Investment Breakdown</div>
        <table class="data-table" style="font-size:12px;">
          <thead><tr><th>Category</th><th style="text-align:right;">Amount</th><th style="text-align:right;">% of Total</th></tr></thead>
          <tbody>
            ${investBreakdown.map(ib => `<tr><td>${ib.category}</td><td style="text-align:right;font-weight:700;">${fmt(ib.amount,'$k')}</td><td style="text-align:right;">${ib.pct}%</td></tr>`).join('')}
            <tr style="background:var(--ey-yellow-bg);font-weight:800;"><td>Total Investment</td><td style="text-align:right;">${fmt(wf.totalInvestment,'$m')}</td><td style="text-align:right;">100%</td></tr>
          </tbody>
        </table>
        <canvas id="investPie" width="300" height="200" style="margin-top:8px;"></canvas>
      </div>
      <div class="card">
        <div class="card-title">üìà CX Revenue Impact (Estimated)</div>
        <div style="text-align:center;padding:20px 0;">
          <div style="font-size:42px;font-weight:800;color:var(--ey-blue);">${fmt(cxRevenueImpact,'$m')}<span style="font-size:16px;">/yr</span></div>
          <div style="font-size:12px;color:var(--ey-text-light);margin-top:4px;">Estimated revenue uplift from +${csatUplift.toFixed(2)} CSAT improvement</div>
        </div>
        <table class="data-table" style="font-size:11px;">
          <thead><tr><th>CX Driver</th><th>Current</th><th>Projected</th><th>Impact</th></tr></thead>
          <tbody>
            <tr><td>CSAT Score</td><td>${DEMO.avgCSAT.toFixed(2)} /5</td><td>${(DEMO.avgCSAT+csatUplift).toFixed(2)} /5</td><td style="color:var(--ey-green);">+${csatUplift.toFixed(2)} pts</td></tr>
            <tr><td>FCR Rate</td><td>${(DEMO.avgFCR*100).toFixed(1)}%</td><td>${((DEMO.avgFCR+0.08)*100).toFixed(1)}%</td><td style="color:var(--ey-green);">+8.0pp</td></tr>
            <tr><td>AHT</td><td>${DEMO.avgAHT_min.toFixed(1)} min</td><td>${(DEMO.avgAHT_min*0.85).toFixed(1)} min</td><td style="color:var(--ey-green);">‚àí15%</td></tr>
            <tr><td>NPS (est.)</td><td>32</td><td>41</td><td style="color:var(--ey-green);">+9 pts</td></tr>
          </tbody>
        </table>
        <div style="font-size:10px;color:var(--ey-text-light);margin-top:8px;">Revenue impact based on industry benchmarks: 1 CSAT point ‚âà ${(revenuePerCSATPoint/annualBaseCost*100).toFixed(0)}% of cost base in retained revenue.</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">üèä Opportunity Pool Utilization <span style="font-size:11px;font-weight:400;color:var(--ey-text-light);">Finite opportunity ceilings prevent double-counting</span></div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;">
        ${Object.entries(wf.poolUtilization || {}).filter(([k,v]) => v.ceiling_fte > 0.5).map(([key, pool]) => {
          const pct = Math.min(100, pool.utilization_pct || 0);
          const color = pct > 80 ? 'var(--ey-red)' : pct > 50 ? 'var(--ey-amber)' : 'var(--ey-green)';
          const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          return '<div style="background:var(--ey-card-bg);padding:12px;border-radius:8px;border:1px solid var(--ey-border);">' +
            '<div style="font-size:11px;font-weight:700;margin-bottom:6px;">' + label + '</div>' +
            '<div style="background:var(--ey-border);border-radius:4px;height:16px;overflow:hidden;">' +
              '<div style="background:' + color + ';height:100%;width:' + pct + '%;border-radius:4px;transition:width 0.5s;"></div>' +
            '</div>' +
            '<div style="display:flex;justify-content:space-between;margin-top:4px;font-size:10px;color:var(--ey-text-light);">' +
              '<span>' + pool.consumed_fte.toFixed(1) + ' / ' + pool.ceiling_fte.toFixed(1) + ' FTE</span>' +
              '<span style="font-weight:700;color:' + color + ';">' + pct.toFixed(0) + '% used</span>' +
            '</div>' +
          '</div>';
        }).join('')}
      </div>
      ${wf.poolSummary ? '<div style="font-size:10px;color:var(--ey-text-light);">Pool ceilings computed from intent-level analysis: ' + (wf.poolSummary.total_pool_fte || 0).toFixed(0) + ' FTE total opportunity across all levers. Volume annualized from ' + (wf.poolSummary.total_volume || 0).toLocaleString() + ' contacts/yr.</div>' : ''}
    </div>

    <div class="card">
      <div class="card-title">üîç Benefit Audit Trail <span style="font-size:11px;font-weight:400;color:var(--ey-text-light);">Gross ‚Üí Net: how each initiative's impact was computed and capped</span></div>
      <div class="table-wrap"><table class="data-table" style="font-size:11px;">
        <thead><tr><th>ID</th><th>Initiative</th><th>Lever</th><th style="text-align:right;">Gross FTE</th><th style="text-align:right;">Net FTE</th><th style="text-align:right;">Saving ($/yr)</th><th>Capped?</th><th>Mechanism</th></tr></thead>
        <tbody>
          ${(wf.auditTrail || []).filter(a => a.net_fte > 0 || a.saving > 0).sort((a,b) => (b.saving||0) - (a.saving||0)).map(a => {
            const leverColor = {'deflection':'#2196F3','aht_reduction':'#FF9800','escalation_reduction':'#9C27B0','cost_reduction':'#4CAF50','shrinkage_reduction':'#00BCD4','repeat_reduction':'#E91E63'}[a.lever] || '#666';
            const cappedIcon = a.pool_capped ? 'üîí Pool' : a.safety_capped ? '‚ö° Cap' : '‚úÖ';
            return '<tr>' +
              '<td><strong>' + a.id + '</strong></td>' +
              '<td>' + a.name + '</td>' +
              '<td><span style="background:' + leverColor + '22;color:' + leverColor + ';padding:2px 6px;border-radius:4px;font-size:10px;">' + a.lever.replace(/_/g,' ') + '</span></td>' +
              '<td style="text-align:right;">' + a.gross_fte.toFixed(1) + '</td>' +
              '<td style="text-align:right;font-weight:700;color:var(--ey-green);">' + a.net_fte.toFixed(1) + '</td>' +
              '<td style="text-align:right;font-weight:700;">' + fmt(a.saving, '$k') + '</td>' +
              '<td style="text-align:center;">' + cappedIcon + '</td>' +
              '<td style="font-size:10px;color:var(--ey-text-light);max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + (a.mechanism||'').replace(/"/g,"'") + '">' + (a.mechanism || '‚Äî') + '</td>' +
            '</tr>';
          }).join('')}
        </tbody>
      </table></div>
    </div>

    <div class="card">
      <div class="card-title">üìã Top Initiative Contributions <span style="font-size:11px;font-weight:400;color:var(--ey-text-light);">Click to edit any initiative</span></div>
      <div class="table-wrap"><table class="data-table" style="font-size:11px;">
        <thead><tr><th>ID</th><th>Initiative</th><th>Layer</th><th>Gross FTE</th><th>Net FTE</th><th>Annual Saving ($/yr)</th><th>% of Total</th><th>Pool Status</th></tr></thead>
        <tbody>
          ${initContrib.map((i,idx) => `<tr style="cursor:pointer;" onclick="openInitEditor(${INITIATIVES.indexOf(i)})">
            <td><strong>${i.id}</strong></td><td>${i.name}</td>
            <td style="font-size:10px;">${i.layer.split(' ')[0]}</td>
            <td style="color:var(--ey-text-light);">${(i._grossFTE||i._fteImpact||0).toFixed?.(1) || '‚Äî'}</td>
            <td style="color:var(--ey-green);font-weight:700;">‚àí${i._fteImpact?.toFixed(1) || '‚Äî'}</td>
            <td style="font-weight:700;color:var(--ey-green);">${fmt(i._annualSaving||0,'$k')}</td>
            <td>${i._contributionPct != null ? i._contributionPct.toFixed(1) : safeFixed(i._annualSaving/(Math.max(wf.totalSaving,1))*100, 1)}%</td>
            <td style="font-size:10px;">${i._poolCapped ? 'üîí Pool cap' : i._capApplied ? '‚ö° Safety cap' : '‚úÖ Full'}</td>
          </tr>`).join('')}
        </tbody>
      </table></div>
    </div>
  `;

  drawFTEWaterfall();
  drawNPVChart();
  drawTornado(sensVars);
  drawInvestPie(investBreakdown);
}

function drawInvestPie(data) {
  const canvas = document.getElementById('investPie');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = 300, H = 200, cx = 100, cy = 100, r = 75;
  ctx.clearRect(0, 0, W, H);
  const colors = ['#1A73E8', '#168736', '#D97706', '#6B7280'];
  const total = data.reduce((s,d) => s + d.amount, 0);
  let angle = -Math.PI / 2;
  data.forEach((d, i) => {
    const slice = (d.amount / total) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, angle, angle + slice);
    ctx.fillStyle = colors[i % colors.length];
    ctx.fill();
    // Label
    const mid = angle + slice / 2;
    const lx = cx + (r + 25) * Math.cos(mid);
    const ly = cy + (r + 25) * Math.sin(mid);
    ctx.fillStyle = '#333';
    ctx.font = '10px Inter, sans-serif';
    ctx.textAlign = lx > cx ? 'left' : 'right';
    ctx.fillText(`${d.category.split(' ')[0]} ${d.pct}%`, lx, ly);
    angle += slice;
  });
}

function drawFTEWaterfall() {
  const canvas = document.getElementById('fteWaterfall');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = 500, H = 300, pad = {l:60, r:20, t:20, b:50};
  ctx.clearRect(0, 0, W, H);

  // Fix #5: Use real layerFTE data from waterfall engine (not hardcoded splits)
  const layerFTE = WATERFALL.layerFTE || DEMO.layerFTE || {};
  const aiRed = Math.round(layerFTE['AI & Automation'] || 0);
  const omRed = Math.round(layerFTE['Operating Model'] || 0);
  const locRed = Math.round(layerFTE['Location Strategy'] || 0);
  const totalRed = aiRed + omRed + locRed;

  const bars = [
    { label: 'Baseline', value: DEMO.totalFTE, color: '#2E2E38', isBase: true },
    { label: 'AI & Auto', value: -aiRed, color: '#1A73E8' },
    { label: 'Op Model', value: -omRed, color: '#168736' },
    { label: 'Location', value: -locRed, color: '#D97706' },
    { label: 'Final', value: DEMO.totalFTE - totalRed, color: '#2E2E38', isBase: true },
  ];

  const maxVal = DEMO.totalFTE * 1.1;
  const barW = (W - pad.l - pad.r) / bars.length - 10;
  let running = DEMO.totalFTE;

  bars.forEach((b, i) => {
    const x = pad.l + i * (barW + 10);
    let top, height;
    if (b.isBase) {
      top = (H-pad.b) - (b.value/maxVal) * (H-pad.b-pad.t);
      height = (b.value/maxVal) * (H-pad.b-pad.t);
    } else {
      const before = running;
      running += b.value;
      top = (H-pad.b) - (before/maxVal) * (H-pad.b-pad.t);
      height = (-b.value/maxVal) * (H-pad.b-pad.t);
    }
    ctx.fillStyle = b.color; ctx.fillRect(x, top, barW, height);
    ctx.fillStyle = '#2E2E38'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(b.label, x + barW/2, H-pad.b+14);
    ctx.fillText(b.isBase ? b.value.toString() : b.value.toString(), x + barW/2, top - 5);
  });
}

function drawNPVChart() {
  const canvas = document.getElementById('npvChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = 500, H = 300, pad = {l:60, r:20, t:20, b:40};
  ctx.clearRect(0, 0, W, H);

  const data = [0, ...WATERFALL.yearly.map(y => y.npv)];
  let cumNPV = [0];
  data.forEach((v,i) => { if(i>0) cumNPV.push(cumNPV[i-1]+v); });
  const maxNPV = Math.max(...cumNPV) * 1.2;

  ctx.strokeStyle = '#E0E0E6'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(pad.l, H-pad.b); ctx.lineTo(W-pad.r, H-pad.b); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(pad.l, H-pad.b); ctx.lineTo(pad.l, pad.t); ctx.stroke();

  // NPV line
  ctx.beginPath(); ctx.strokeStyle = '#168736'; ctx.lineWidth = 2.5;
  cumNPV.forEach((v, i) => {
    const x = pad.l + (i/(cumNPV.length-1)) * (W-pad.l-pad.r);
    const y = (H-pad.b) - (v/maxNPV) * (H-pad.b-pad.t);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Fill
  ctx.lineTo(pad.l + (W-pad.l-pad.r), H-pad.b);
  ctx.lineTo(pad.l, H-pad.b);
  ctx.fillStyle = 'rgba(22,135,54,0.1)'; ctx.fill();

  // Dots + labels
  cumNPV.forEach((v, i) => {
    const x = pad.l + (i/(cumNPV.length-1)) * (W-pad.l-pad.r);
    const y = (H-pad.b) - (v/maxNPV) * (H-pad.b-pad.t);
    ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI*2); ctx.fillStyle = '#168736'; ctx.fill();
    ctx.fillStyle = '#2E2E38'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(i === 0 ? 'Base' : `Yr ${i}`, x, H-pad.b+14);
    ctx.fillText(fmt(v, '$m'), x, y-10);
  });
}

function drawTornado(sensVars) {
  const canvas = document.getElementById('tornadoChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = 500, H = 280, pad = {l:130, r:60, t:10, b:20};
  ctx.clearRect(0, 0, W, H);

  const maxSwing = Math.max(...sensVars.map(v => v.swing));
  const barH = Math.min(30, (H-pad.t-pad.b) / sensVars.length - 6);
  const centerX = pad.l + (W-pad.l-pad.r)/2;

  // Center line
  ctx.strokeStyle = '#2E2E38'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(centerX, pad.t); ctx.lineTo(centerX, H-pad.b); ctx.stroke();

  sensVars.forEach((v, i) => {
    const y = pad.t + i * (barH + 6);
    const halfW = (v.swing / maxSwing) * ((W-pad.l-pad.r)/2 - 10);

    // Negative bar
    ctx.fillStyle = '#C5003E88';
    ctx.fillRect(centerX - halfW, y, halfW, barH);
    // Positive bar
    ctx.fillStyle = '#16873688';
    ctx.fillRect(centerX, y, halfW, barH);

    // Label
    ctx.fillStyle = '#2E2E38'; ctx.font = '11px sans-serif'; ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
    ctx.fillText(v.name, pad.l - 8, y + barH/2);

    // Values
    ctx.textAlign = 'center'; ctx.font = '9px sans-serif';
    ctx.fillText(`‚àí${fmt(v.swing,'$k')}`, centerX - halfW/2, y + barH/2);
    ctx.fillText(`+${fmt(v.swing,'$k')}`, centerX + halfW/2, y + barH/2);
  });
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODULE 5: PAGE 15 ‚Äî OVERRIDES
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPage15() {
  const el = document.getElementById('page-15');
  const p = DEMO.params;

  el.innerHTML = `
    <div class="card" style="border-left:3px solid var(--ey-yellow);">
      <div class="card-title">‚öôÔ∏è Enterprise Parameters</div>
      <p style="font-size:12px; color:var(--ey-text-light); margin-bottom:12px;">These parameters drive all calculations across the platform. Changes here propagate to every page on re-run.</p>
      <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:12px;">
        ${[
          { label: 'Program Name', key: 'programName', type: 'text', val: p.programName },
          { label: 'Industry', key: 'industry', type: 'text', val: p.industry },
          { label: 'Planning Horizon (years)', key: 'horizon', type: 'number', val: p.horizon },
          { label: 'Discount Rate', key: 'discountRate', type: 'number', val: (p.discountRate*100).toFixed(0), suffix: '%' },
          { label: 'Volume Growth (annual)', key: 'volumeGrowth', type: 'number', val: (p.volumeGrowth*100).toFixed(0), suffix: '%' },
          { label: 'Wage Inflation (annual)', key: 'wageInflation', type: 'number', val: (p.wageInflation*100).toFixed(0), suffix: '%' },
          { label: 'Attrition (monthly)', key: 'attritionMonthly', type: 'number', val: (p.attritionMonthly*100).toFixed(0), suffix: '%' },
          { label: 'Redeployment %', key: 'redeploymentPct', type: 'number', val: (p.redeploymentPct*100).toFixed(0), suffix: '%' },
          { label: 'Currency', key: 'currency', type: 'text', val: p.currency },
        ].map(f => `
          <div>
            <label style="font-size:11px; font-weight:600; display:block; margin-bottom:4px;">${f.label}</label>
            <input type="${f.type}" value="${f.val}" data-param="${f.key}" style="width:100%; padding:8px; border:1.5px solid var(--ey-mid-gray); border-radius:6px; font-size:13px;">
          </div>
        `).join('')}
      </div>
    </div>

    <div class="card">
      <div class="card-title">üéõÔ∏è Initiative Parameter Overrides</div>
      <p style="font-size:12px; color:var(--ey-text-light); margin-bottom:12px;">Click any initiative to edit its impact %, start/end month, and target adoption rate.</p>
      <div class="table-wrap" style="max-height:400px; overflow-y:auto;"><table class="data-table" style="font-size:11px;">
        <thead style="position:sticky;top:0;z-index:2;"><tr><th>ID</th><th>Initiative</th><th>Impact %</th><th>Start Mo</th><th>End Mo</th><th>Adoption</th><th></th></tr></thead>
        <tbody>
          ${INITIATIVES.map((init,idx) => `<tr>
            <td><strong>${init.id}</strong></td><td>${init.name.substring(0,30)}</td>
            <td><input type="number" value="${(init.impact*100).toFixed(0)}" style="width:50px;padding:4px;border:1px solid var(--ey-mid-gray);border-radius:4px;font-size:11px;" data-init="${idx}" data-field="impact"></td>
            <td><input type="number" value="${init.startMonth}" style="width:45px;padding:4px;border:1px solid var(--ey-mid-gray);border-radius:4px;font-size:11px;" data-init="${idx}" data-field="startMonth"></td>
            <td><input type="number" value="${init.endMonth}" style="width:45px;padding:4px;border:1px solid var(--ey-mid-gray);border-radius:4px;font-size:11px;" data-init="${idx}" data-field="endMonth"></td>
            <td><input type="number" value="${(init.adoption*100).toFixed(0)}" style="width:50px;padding:4px;border:1px solid var(--ey-mid-gray);border-radius:4px;font-size:11px;" data-init="${idx}" data-field="adoption"></td>
            <td style="font-size:10px; color:var(--ey-text-light);">${init.enabled ? '‚úÖ' : '‚¨ú'}</td>
          </tr>`).join('')}
        </tbody>
      </table></div>
    </div>

    <div class="card">
      <div class="card-title">üìä Benchmark Overrides</div>
      <table class="data-table" style="font-size:11px;">
        <thead><tr><th>Metric</th><th>Global Benchmark</th><th>Direction</th><th>Override</th></tr></thead>
        <tbody>
          ${Object.entries(DEMO.benchmarks).map(([metric, bm]) => `<tr>
            <td><strong>${metric}</strong></td>
            <td>${bm.global}</td>
            <td>${bm.direction}</td>
            <td><input type="number" value="${bm.global}" step="0.01" style="width:80px;padding:4px;border:1px solid var(--ey-mid-gray);border-radius:4px;font-size:11px;" data-bm="${metric}"></td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>

    <div style="display:flex; gap:12px; margin-top:16px;">
      <button class="btn btn-primary" onclick="applyAllOverrides()" style="padding:12px 24px; font-size:14px;">
        üîÑ RE-RUN MODEL WITH OVERRIDES
      </button>
      <button class="btn btn-outline" onclick="resetAllOverrides()" style="padding:12px 24px; font-size:14px;">
        ‚Ü©Ô∏è RESET ALL TO DEFAULTS
      </button>
    </div>
    <p style="font-size:11px; color:var(--ey-text-light); margin-top:8px;">Re-run recalculates all engines and refreshes every page. Override badges will appear on affected pages.</p>
  `;
}

function applyAllOverrides() {
  // Read parameter overrides
  document.querySelectorAll('[data-param]').forEach(inp => {
    const key = inp.dataset.param;
    let val = inp.value;
    if (['discountRate','volumeGrowth','wageInflation','attritionMonthly','redeploymentPct'].includes(key)) val = parseFloat(val) / 100;
    else if (key === 'horizon') val = parseInt(val);
    if (!isNaN(val)) DEMO.params[key] = val; else DEMO.params[key] = val;
  });

  // Read initiative overrides
  document.querySelectorAll('[data-init]').forEach(inp => {
    const idx = parseInt(inp.dataset.init);
    const field = inp.dataset.field;
    let val = parseFloat(inp.value);
    if (field === 'impact' || field === 'adoption') val /= 100;
    if (!isNaN(val)) INITIATIVES[idx][field] = val;
  });

  // Read benchmark overrides
  document.querySelectorAll('[data-bm]').forEach(inp => {
    const metric = inp.dataset.bm;
    const val = parseFloat(inp.value);
    if (!isNaN(val)) (DEMO.benchmarks[metric]||{}).global = val;
  });

  // CRITICAL: Re-run waterfall engine with new params
  recalculateAll();
}

function resetAllOverrides() {
  if (!confirm('Reset all parameters to defaults? This cannot be undone.')) return;
  Object.keys(rendered).forEach(k => rendered[k] = false);
  alert('‚Ü©Ô∏è Reset complete. Reload the page for fresh default data.');
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INITIALIZATION
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.addEventListener('DOMContentLoaded', () => {
  renderPage(1);
});
{% endraw %}
</script>
</body>
</html>
